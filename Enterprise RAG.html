readable-text unscrambled temp-unscrambled
<html>
  <head>
    <meta charset="utf-8">
    <title>Enterprise RAG</title>
    <style>
  body, .large-12.columns, #book-main-content-container {
  font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif;
  font-size: 1.15rem;
  line-height: 1.7;
  color: #222;
  background: #f9f9fb;
  margin: 0;
  padding: 0;
}
.large-12.columns, #book-main-content-container {
  max-width: 900px;
  margin: 2.5em auto 2.5em auto;
  padding: 2em 2.5em 2em 2.5em;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 24px rgba(60,60,100,0.07);
}
.readable-text, .intended-text, .introduction-summary, .book-element-head-commands {
  background: #fff;
  border-radius: 8px;
  padding: 1.2em 2em;
  margin-bottom: 1.5em;
}
h1, h2, h3, h4, h5, h6 {
  color: #1a237e;
  font-weight: 700;
  margin-top: 2em;
  margin-bottom: 0.7em;
  letter-spacing: 0.01em;
}
ul, ol {
  margin-left: 2em;
  margin-bottom: 1.2em;
}
p {
  margin-bottom: 1.2em;
}
a {
  color: #1976d2;
  text-decoration: underline;
}
a:hover {
  color: #0d47a1;
  text-decoration: underline wavy;
}
button, ._head-icon-container {
  background: #e3eafc;
  border: none;
  border-radius: 6px;
  padding: 0.4em 0.8em;
  margin: 0 0.2em;
  cursor: pointer;
  transition: background 0.2s;
}
button:hover, ._head-icon-container:hover {
  background: #bbdefb;
}
::-webkit-scrollbar {
  width: 10px;
  background: #f0f0f0;
}
::-webkit-scrollbar-thumb {
  background: #c5cae9;
  border-radius: 5px;
}
img, svg {
  max-width: 100%;
  height: auto;
  display: block;
  margin: 1em auto;
}
/* Enhanced code block styling */
pre, .code-area, pre code, .code-area code, code.hljs {
  background: #23272e !important;
  color: #e3eafc !important;
  font-family: 'Fira Mono', 'Consolas', 'Menlo', 'Monaco', monospace !important;
  font-size: 1em;
  border-radius: 8px;
  padding: 1.1em 1.5em;
  margin: 1.5em 0;
  overflow-x: auto;
  box-shadow: 0 2px 8px rgba(30,40,60,0.10);
  line-height: 1.6;
  word-break: break-word;
}
code, kbd, samp {
  background: #f4f4f7;
  color: #c7254e;
  font-family: 'Fira Mono', 'Consolas', 'Menlo', 'Monaco', monospace;
  font-size: 0.98em;
  border-radius: 4px;
  padding: 0.15em 0.4em;
  margin: 0 0.1em;
}
pre code, .code-area code {
  background: none !important;
  color: inherit !important;
  padding: 0;
  margin: 0;
  border-radius: 0;
}
.code-area-container {
  margin-bottom: 2em;
}
.readable-text + .readable-text, .intended-text + .intended-text, .introduction-summary + .introduction-summary {
  margin-top: 2.5em;
}
@media (max-width: 700px) {
  .readable-text, .intended-text, .introduction-summary, .book-element-head-commands, .large-12.columns, #book-main-content-container {
    padding: 1em 0.5em;
    max-width: 100vw;
  }
  body, .large-12.columns, #book-main-content-container {
    font-size: 1em;
  }
}
    </style>
  </head>
  <body>
    <div class="large-12 columns">
      <div id="book-main-content-container" style="" class="">
          <div id="track-point-column" class="hidden">
              <div class="track-point-wrapper" id="pointing-start-point">
                  <i class="fal fa-level-down fa-flip-horizontal" aria-hidden="true"></i>
              </div>
              <div class="track-point-wrapper" id="pointing-end-point">
                  <i class="fal fa-level-up fa-flip-horizontal" aria-hidden="true"></i>
              </div>
              <div class="track-point-wrapper" id="play-point">
                  <div class="track-point">
                      <i class="icon-i-play-triangle"></i>
                  </div>
              </div>
              <div class="track-point-wrapper" id="current-position-point">
                  <div class="track-point">
                      <div class="track-point-play">
                          <i></i>
                      </div>
                  </div>
              </div>
              <div class="track-point-wrapper" id="off-screen-position-point">
                  <div class="track-point">
                      <div class="off-screen-position-point-arrow-container">
                          <i class=""></i>
                      </div>
                  </div>
              </div>
              <div class="track-point-wrapper" id="restart-paragraph-point">
                  <div class="track-point">
                      <i class="fa fa-redo"></i>
                  </div>
              </div>
          </div>
          <div id="book-markup-container"><div class="readable-text " refid="1" id="1" data-hash="19e788f66250c848223bb42d32e7efe1"> 
  <h1><span class="chapter-title-numbering"><span class="num-string">2</span></span> Nothing happens until someone writes an eval</h1> 
  
  <div class="book-element-head-commands">
  <div class="_left">
      <button class="_head-icon-container _audio-icon" title="play audio">
          <i class="fa fa-play"></i>
      </button>
      <button class="_head-icon-container _generate-audio-icon _edit-audio-icon" title="generate audio">
          <i class="fa fa-microphone"></i>
          <i class="fa fa-cog"></i>
      </button>
      <button class="_head-icon-container _join-audio-icon _edit-audio-icon" title="join audio">
          <i class="fa fa-microphone"></i>
          <i class="fa fa-plus"></i>
      </button>
      <button class="_head-icon-container _create-timeline-icon _edit-audio-icon" title="create timeline">
          <i class="fa fa-stream"></i>
      </button>
      <button class="_head-icon-container _generate-subtitles-icon _edit-audio-icon" title="generate subtitles">
          <i class="fa fa-closed-captioning"></i>
          <i class="fa fa-cog"></i>
      </button>
      <button class="_head-icon-container _discussions-icon" title="discussions"><div class="_label">1</div>
          <svg width="25" height="23" viewBox="0 0 25 23" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M0.443717 21.8455C0.536061 21.8944 0.636353 21.9481 0.832775 21.9481C1.45724 21.9473 3.05396 21.4122 8.43833 18.5071C8.75926 18.5794 8.93676 18.6335 9.18087 18.7088L9.54306 18.8182C9.95217 18.9363 10.3753 18.7051 10.4953 18.3009C10.6141 17.8982 10.3813 17.4743 9.97601 17.3555L9.63351 17.2529C9.30992 17.1541 9.0556 17.0754 8.47466 16.9581C8.29678 16.921 8.11361 16.949 7.95465 17.0349C6.09717 18.0397 3.99065 19.1123 2.54153 19.7776C2.76103 19.4949 2.98508 19.2114 3.17696 18.9681C4.83273 16.8703 5.21157 16.3242 5.1355 15.7746C5.10749 15.571 4.96973 15.336 4.80321 15.2138C2.72016 13.6954 1.57229 11.6608 1.57229 9.48537C1.57229 5.09522 6.30116 1.52368 12.1136 1.52368C17.926 1.52368 22.6548 5.09522 22.6548 9.48499C22.6548 9.90622 22.9985 10.2472 23.4208 10.2472C23.844 10.2472 24.1876 9.9066 24.1876 9.48499C24.1876 4.25542 18.7707 0 12.1128 0C5.45492 0 0.0391419 4.25542 0.0391419 9.48499C0.0391419 11.9514 1.27028 14.3304 3.43848 16.0903C3.10846 16.5861 2.4454 17.4251 1.97005 18.0276C0.257892 20.1977 -0.0993748 20.7166 0.0213542 21.2831C0.0679049 21.5034 0.244646 21.7392 0.443717 21.8455Z" fill="currentColor"></path>
              <path d="M24.1695 15.4458C24.1695 12.6649 21.336 10.4028 17.853 10.4028C14.3704 10.4028 11.5369 12.6653 11.5369 15.4458C11.5369 18.1473 14.2096 20.3594 17.5555 20.4843C18.1982 21.0164 20.0931 22.3524 23.3244 22.7619C23.3566 22.7656 23.3922 22.7679 23.4243 22.7679C23.6998 22.7679 23.9682 22.6146 24.1044 22.3773C24.3728 21.9137 24.2074 21.6348 23.2957 20.0869C23.0792 19.719 22.7616 19.1786 22.5648 18.8119C23.5916 17.893 24.1695 16.6921 24.1695 15.4458ZM21.2111 17.944C20.5439 18.4292 20.8746 18.9916 21.9722 20.8555C21.9949 20.8942 22.0168 20.9316 22.0414 20.971C19.6091 20.3522 18.4082 19.2021 18.3965 19.1911C18.2527 19.0476 18.0566 18.9663 17.853 18.9663C15.2159 18.9663 13.0704 17.387 13.0704 15.4458C13.0704 13.5051 15.2159 11.9261 17.853 11.9261C20.4905 11.9261 22.6368 13.5051 22.6368 15.4458C22.6364 16.3867 22.1292 17.2746 21.2111 17.944Z" fill="currentColor"></path>
          </svg>
      </button>
      
      <button class="_head-icon-container _share-icon" title="share">
          <svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M4.22095 12V20C4.22095 20.5304 4.43166 21.0391 4.80673 21.4142C5.18181 21.7893 5.69051 22 6.22095 22H18.2209C18.7514 22 19.2601 21.7893 19.6352 21.4142C20.0102 21.0391 20.2209 20.5304 20.2209 20V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M16.2209 6L12.2209 2L8.22095 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M12.2209 2V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
      </button>
      
      <button class="_head-icon-container _livecards-icon hidden" title="livecards deck start">
          <svg class="add-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21.25 15.38C21.25 15.38 21.22 15.4 21.21 15.4C21.23 15.4 21.24 15.38 21.25 15.38Z" fill="white"></path>
              <path d="M22.05 5.45001L22.41 7.65001L22.05 5.45001C21.79 3.87001 20.36 2.79001 18.79 2.92001C20.36 2.80001 21.79 3.88001 22.05 5.45001V5.45001Z" fill="white"></path>
              <path d="M4.91 18.06C4.86 18.06 4.81 18.06 4.75 18.05C4.8 18.05 4.85 18.06 4.91 18.06Z" fill="white"></path>
              <path d="M2.17001 16.17C2.17001 16.17 2.15001 16.13 2.14001 16.1C2.14001 16.12 2.16001 16.14 2.17001 16.17Z" fill="white"></path>
              <path d="M4.36001 18C4.31001 17.99 4.25001 17.98 4.20001 17.96C4.25001 17.97 4.31001 17.99 4.36001 18Z" fill="white"></path>
              <path d="M3.79999 17.82C3.79999 17.82 3.71999 17.79 3.67999 17.77C3.71999 17.79 3.75999 17.8 3.79999 17.82Z" fill="white"></path>
              <path d="M18.97 17.85C18.82 19.06 17.8 20 16.56 20C16.56 20 6.1 20 5.8 20C5.5 20 5.27 20 5 20C4.65 20 4.29 20.02 3.96 19.95H3.95C3.27 19.8 2.62 19.53 2.05 19.12C0.94 18.33 0.22 17.16 0 15.83V17.56C0 20.01 1.99 22 4.44 22H16.56C19.01 22 21 20.01 21 17.56V17.52C21 17.52 20.95 17.53 20.93 17.54L18.97 17.86V17.85Z" fill="currentColor"></path>
              <path d="M4.56001 5.20999L3.42001 5.39999C3.42001 5.39999 3.40001 5.39999 3.39001 5.39999C3.40001 5.39999 3.41001 5.39999 3.42001 5.39999L4.56001 5.20999Z" fill="currentColor"></path>
              <path d="M0.940002 7.7C0.940002 7.7 0.960002 7.65 0.960002 7.63C0.960002 7.65 0.940002 7.68 0.940002 7.7Z" fill="currentColor"></path>
              <path d="M1.14001 7.13999C1.14001 7.13999 1.15001 7.11999 1.16001 7.10999C1.16001 7.11999 1.15001 7.12999 1.14001 7.13999Z" fill="currentColor"></path>
              <path d="M0.859985 8.29001C0.859985 8.29001 0.869985 8.21001 0.879985 8.17001C0.879985 8.21001 0.869985 8.25001 0.859985 8.29001Z" fill="currentColor"></path>
              <path d="M1.79001 6.22C1.79001 6.22 1.81001 6.2 1.82001 6.19C1.82001 6.19 1.80001 6.21 1.79001 6.22Z" fill="currentColor"></path>
              <path d="M2.23001 5.87999C2.23001 5.87999 2.27001 5.84999 2.29001 5.82999C2.27001 5.83999 2.25001 5.85999 2.23001 5.87999Z" fill="currentColor"></path>
              <path d="M2.72 5.61C2.72 5.61 2.79 5.57 2.83 5.56C2.79 5.57 2.76 5.6 2.72 5.61Z" fill="currentColor"></path>
              <path d="M1.25 11.06L1.98 15.51C1.98 15.51 1.99 15.54 1.99 15.56C1.99 15.54 1.98 15.53 1.98 15.51L1.25 11.06V11.06Z" fill="currentColor"></path>
              <path d="M18.79 2.91999C18.71 2.91999 18.63 2.91999 18.54 2.93999L4.56001 5.20999L3.42001 5.39999C3.42001 5.39999 3.40001 5.39999 3.39001 5.39999C3.20001 5.42999 3.01001 5.47999 2.83001 5.54999C2.79001 5.55999 2.76001 5.58999 2.72001 5.59999C2.57001 5.65999 2.43001 5.72999 2.29001 5.80999C2.27001 5.81999 2.25001 5.83999 2.23001 5.85999C2.09001 5.95999 1.95001 6.05999 1.82001 6.16999C1.82001 6.16999 1.80001 6.18999 1.79001 6.19999C1.53001 6.44999 1.31001 6.74999 1.15001 7.08999C1.15001 7.09999 1.14001 7.10999 1.13001 7.11999C1.06001 7.27999 1.00001 7.43999 0.960006 7.60999C0.960006 7.62999 0.940006 7.65999 0.940006 7.67999C0.900006 7.83999 0.890006 7.99999 0.870006 8.15999C0.870006 8.19999 0.860006 8.23999 0.850006 8.27999C0.850006 8.47999 0.850006 8.68999 0.890006 8.88999L1.24001 11.05L1.97001 15.5C1.97001 15.5 1.98001 15.53 1.98001 15.55C2.01001 15.74 2.06001 15.92 2.13001 16.09C2.13001 16.11 2.15001 16.13 2.16001 16.16C2.45001 16.87 3.00001 17.44 3.67001 17.76C3.71001 17.78 3.75001 17.79 3.79001 17.81C3.92001 17.86 4.05001 17.91 4.18001 17.95C4.23001 17.96 4.29001 17.98 4.34001 17.99C4.47001 18.02 4.60001 18.04 4.74001 18.05C4.79001 18.05 4.84001 18.06 4.90001 18.06C5.09001 18.06 5.28001 18.06 5.47001 18.02L20.6 15.55C20.81 15.52 21.01 15.46 21.19 15.39C21.21 15.39 21.22 15.37 21.23 15.37C22.34 14.93 23.09 13.87 23.15 12.68C23.15 12.46 23.15 12.26 23.11 12.05L22.39 7.64999L22.03 5.44999C21.77 3.86999 20.34 2.79999 18.77 2.91999H18.79ZM3.95001 15.19L2.87001 8.57999C2.83001 8.29999 2.89001 8.01999 3.05001 7.79999C3.21001 7.56999 3.46001 7.41999 3.73001 7.37999L18.86 4.90999C18.92 4.90999 18.97 4.89999 19.03 4.89999C19.54 4.89999 19.98 5.26999 20.07 5.77999L21.15 12.39C21.24 12.96 20.85 13.5 20.28 13.6L5.15001 16.07C4.87001 16.12 4.59001 16.05 4.37001 15.89C4.14001 15.73 3.99001 15.48 3.95001 15.21V15.19Z" fill="currentColor"></path>
              <path d="M4.49001 9.268L17.34 6.998C17.61 6.948 17.79 6.688 17.75 6.418C17.7 6.148 17.44 5.958 17.17 6.008L4.32001 8.278C4.05001 8.328 3.87001 8.588 3.91001 8.858C3.95001 9.098 4.16001 9.268 4.40001 9.268C4.43001 9.268 4.46001 9.268 4.49001 9.268V9.268Z" fill="currentColor"></path>
              <path d="M13.88 9.478C13.83 9.208 13.58 9.028 13.3 9.068L4.73002 10.528C4.46002 10.578 4.27002 10.828 4.32002 11.108C4.36002 11.348 4.57001 11.528 4.81001 11.528C4.84001 11.528 4.87001 11.528 4.89001 11.528L13.46 10.068C13.73 10.018 13.92 9.768 13.87 9.488L13.88 9.478Z" fill="currentColor"></path>
              <path d="M5.51001 14.158L16.93 12.288C17.2 12.248 17.39 11.988 17.34 11.718C17.3 11.448 17.04 11.258 16.77 11.308L5.35001 13.178C5.08001 13.218 4.89001 13.478 4.94001 13.748C4.98001 13.998 5.19001 14.168 5.43001 14.168C5.46001 14.168 5.48001 14.168 5.51001 14.168V14.158Z" fill="currentColor"></path>
          </svg>
      </button>
      <button class="_head-icon-container _ask-manning-icon hidden" title="ask manning">
          <svg width="29" height="29" viewBox="0 0 29 29" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M0.431152 5.56144C0.431152 2.98412 2.52049 0.894775 5.09782 0.894775H23.7645C26.3418 0.894775 28.4312 2.98412 28.4312 5.56144V24.2281C28.4312 26.8054 26.3418 28.8948 23.7645 28.8948H5.09782C2.52049 28.8948 0.431152 26.8054 0.431152 24.2281V5.56144ZM5.09782 2.76144C3.55142 2.76144 2.29782 4.01504 2.29782 5.56144V24.2281C2.29782 25.7745 3.55142 27.0281 5.09782 27.0281H23.7645C25.3108 27.0281 26.5645 25.7745 26.5645 24.2281V5.56144C26.5645 4.01504 25.3108 2.76144 23.7645 2.76144H5.09782Z" fill="#4087D4"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M11.5346 10.744C11.3765 10.4278 11.0534 10.228 10.6998 10.228C10.3463 10.228 10.0231 10.4278 9.86504 10.744L6.13171 18.2106C5.90117 18.6717 6.08804 19.2323 6.54909 19.4628C7.01014 19.6933 7.57078 19.5065 7.80129 19.0454L8.47667 17.6947H12.923L13.5984 19.0454C13.8289 19.5065 14.3895 19.6933 14.8505 19.4628C15.3116 19.2323 15.4985 18.6717 15.2679 18.2106L11.5346 10.744ZM11.9897 15.828L10.6998 13.2483L9.41 15.828H11.9897Z" fill="#4087D4"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M20.0295 10.228C20.5449 10.228 20.9629 10.6459 20.9629 11.1614V18.628C20.9629 19.1434 20.5449 19.5614 20.0295 19.5614C19.5141 19.5614 19.0962 19.1434 19.0962 18.628V11.1614C19.0962 10.6459 19.5141 10.228 20.0295 10.228Z" fill="#4087D4"></path>
          </svg>
      </button>
      <button class="_head-icon-container _reading-list-icon hidden" title="manage in reading list">
          <svg class="add-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M20 10.111C20 10.6633 19.5523 11.111 19 11.111H11.1111V19C11.1111 19.5523 10.6634 20 10.1111 20H9.8889C9.33662 20 8.8889 19.5523 8.8889 19V11.111H1C0.447717 11.111 0 10.6633 0 10.111V9.88883C0 9.33654 0.447715 8.88883 1 8.88883H8.8889V1C8.8889 0.447715 9.33662 0 9.8889 0H10.1021C10.6579 0 11.1071 0.45318 11.1021 1.00893L11.0317 8.88883H19C19.5523 8.88883 20 9.33654 20 9.88883V10.111Z" fill="currentColor"></path>
          </svg>
  
          <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="25" height="23" viewBox="0 0 448 512">
              <path d="M443.3 100.7C449.6 106.9 449.6 117.1 443.3 123.3L171.3 395.3C165.1 401.6 154.9 401.6 148.7 395.3L4.686 251.3C-1.562 245.1-1.562 234.9 4.686 228.7C10.93 222.4 21.06 222.4 27.31 228.7L160 361.4L420.7 100.7C426.9 94.44 437.1 94.44 443.3 100.7H443.3z" fill="currentColor"></path>
          </svg>
      </button>
  </div>
  <div class="_right">
      <div class="_date-container" data-tooltip-y-offset="10" data-more-info="<div class='date-popup-container'><div>livebook updated March 2025</div><div>Publication estimate October 2025</div></div>"><span class="hide-small">MEAP</span> v1</div>
      <button class="_head-icon-container _subscription-cart-button hidden" title="cart">
          buy <span class="hide-small">the book</span>
      </button>
  </div>
  </div></div> 
  <div class="introduction-summary"> 
  <h3>This chapter covers</h3> 
  <ul> 
  <li class="readable-text" refid="2" id="2" data-hash="2c50fcc7f27d24043a9c145ef31e3d88">Introducing evals and Eval-Driven Development</li> 
  <li class="readable-text" refid="3" id="3" data-hash="c4ef6118bb8a3b5f918f301d0610724b">Understanding why evals are essential before coding</li> 
  <li class="readable-text" refid="4" id="4" data-hash="9101fa695617727617bd72ea916bafc3">Creating effective evals for your RAG system</li> 
  <li class="readable-text" refid="5" id="5" data-hash="5c516e79111e520e3dec152358093fcd">Implementing automated evals in end-to-end testing</li> 
  <li class="readable-text" refid="6" id="6" data-hash="7fbc02b0282af8c378d5e869cf10cf00">Using evals to build a reliable and efficient RAG chatbot</li> 
  </ul> 
  </div> 
  <div class="readable-text " refid="7" id="7" data-hash="d6474c9e1da6177b17e5f7f37de489eb"> 
  <p>In the previous chapter, we introduced the basics of Retrieval Augmented Generation (RAG) and explored how Enterprise RAG can transform the way businesses interact with data. Now, we're ready to roll up our sleeves and start building our own RAG system. This chapter focuses on the crucial role of <em>evals</em>—evaluation tests that guide the development process. An eval is essentially a test case. If you're familiar with test-driven development, you know that you write the tests first and then write the code to make those tests pass. Evals work the same way in the context of building a Retrieval Augmented Generation (RAG) chatbot. Here is a quick example of an eval:</p> 
  </div> 
  <div class="readable-text  intended-text" refid="8" id="8" data-hash="182b5f89941a5064f78d7391a07d380d"> 
  <p><em>Question: “What is Product XYZ?”</em></p> 
  </div> 
  <div class="readable-text  intended-text" refid="9" id="9" data-hash="7b982b4bad4388a8493226378c9003b8"> 
  <p><em>Answer: “Product XYZ is a domestic flamethrower built for kitchen use.”</em></p> 
  </div> 
  <div class="readable-text  intended-text" refid="10" id="10" data-hash="8960597bb20c44ec2759dec325582ebd"> 
  <p>An eval is basically a list of question-answer pairs, which shows the kinds of questions your system should be able to answer, as well as the correct answer to each question. We'll discuss how evals help clarify project goals, ensure alignment with business needs, and prevent costly mistakes. While evals are typically written or used early in the development of a RAG pipeline, setting up automated Evals in a CI/CD (Continuous Integration / Continuous Deployment) process happens later, once the system is built. In this chapter, we'll dive into automating evals, giving you the full picture of integrating them into your pipeline. Keep in mind that you'll likely revisit this process after you've built your RAG system. By understanding the importance of evals and learning how to create and implement them effectively, you'll lay the foundation for what's to come, ensuring your RAG chatbot meets your organization's needs and exceeds expectations.</p> 
  </div> 

  <div class="readable-text" refid="11" id="11" data-hash="c701c2a5035cd84a936321ca740847ab"> 
  <h2>2.1 Introducing evals and eval-driven development</h2> 
  </div> 
  <div class="readable-text " refid="12" id="12" data-hash="f9a9f27769bfcb3a5701045f204d2a04"> 
  <p>Story time: Right before I joined my current company, around August 2023, the CEOs were on a call with shareholders who insisted that the company had to incorporate AI, no matter what. That’s when I got connected and was eventually hired. The moment I started, my managers told me to build an AI-driven program that could recall information about our products. We have over <em>five million</em> products, so it’s always been a huge time sink for our customer service reps to track down details on any single one.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="13" id="13" data-hash="ae3b11e48ed574360dfad0f9facb5482"> 
  <p>From day one, I explained that I couldn’t build the exact system they had in mind until I had 10 to 20 examples of the kinds of questions they wanted the AI to answer—and, just as importantly, the correct answers. A few days later, my managers gave me a list of question-answer pairs, like:</p> 
  </div> 
  <ul> 
  <li class="readable-text" refid="14" id="14" data-hash="fd1c31449d527448229516a1863db566">“What does POSTS stand for?” / “POSTS stands for Process Occurring Status Tungsten Stills, which are 5 steps in our metallurgy process.”</li> 
  <li class="readable-text" refid="15" id="15" data-hash="2aa330d2a06ef7d47ca426ff3b277f0d">“Please compare Westchester 30 to Westchester 45.” / “While Westchester 30 contains 5% chili powder, Westchester 45 contains 8%.”</li> 
  <li class="readable-text" refid="16" id="16" data-hash="87f0f090238bb3edf3f379a6a47ce49c">“What kind of metal is Product XYZ made of?” / “Product XYZ is made of copper.”</li> 
  </ul> 
  <div class="readable-text " refid="17" id="17" data-hash="7ad0808639a5b2d9d52511644d8fb9b7"> 
  <p>Having those question-answer examples made my job so much easier. I didn’t need to build a chatbot that could respond to every possible query, just the ones we’d explicitly defined. Then, I spent time asking my boss and coworkers where to find the data behind these specific queries. For instance, I’d ask, “Where does info on Westchester 30 live?” and they’d point me to the right database. My boss even handed me a database full of product documents, which we also used for searching.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="18" id="18" data-hash="485f7b321b87d42286b309533f6ecd8c"> 
  <p>Naturally, someone on the team eventually complained: “I asked the AI about our newest customers—why didn’t it know anything about that?” My response was, “That wasn’t in the evals. If you want to add it, that’s fine, but we never discussed customer data in our original plan.” That’s why having those question-answer evals from the outset was so critical. Without them, I’d be dealing with a constantly moving target. Instead, I’d finish question number one, then tackle question number two, and so on. And as time went on, we just kept adding more evals—at least one for each new type of search we introduced.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="19" id="19" data-hash="ff76331c0e0cf763d964f2825e0a6cd8"> 
  <p>Here's how the eval-driven development approach works. First, gather a list of questions—ideally at least 10 to 20—that your RAG chatbot is likely to receive. These questions should come from your boss, your customers, or stakeholders who understand the business needs. Along with each question, obtain the correct answer. Next, build the chatbot to pass the evals (we will cover this in detail in the following chapters). You will develop your chatbot so that when it encounters a question from your list, it provides the corresponding answer—or something close to it.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="20" id="20" data-hash="c0707060a2126baa8f7a5492cda9ff6d"> 
  <p>That's it! This approach dramatically simplifies the project. Instead of wrestling with vague objectives, you now have specific, measurable goals. It's relatively straightforward to get one question to work correctly. Getting all of them to work might be a bit more challenging, and involves some trial and error but it's definitely achievable. We will go into this process more in later chapters.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="21" id="21" data-hash="b141f59ea22061a9bc1bdeee90f4ff58"> 
  <p>Why use evals? They bring clarity by transforming broad directives into concrete tasks. Evals provide measurability, offering a clear way to assess progress and success. They help the development team focus on what matters most to the business, and they increase efficiency by reducing ambiguity and speeding up the development process.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="22" id="22" data-hash="6d710bbcc56926999dc0f392b19fdd78"> 
  <p>To illustrate, let's look at some sample questions and answers for an e-commerce business:</p> 
  </div> 
  <div class="readable-text  intended-text" refid="23" id="23" data-hash="6e81edb58b444c8318cd66d08a5de2a1"> 
  <p>Imagine a customer asks, "What is Product XYZ and how does it compare to Product ABC?" The answer might be: "Product XYZ and ABC are two products from the same line. XYZ is a toaster for beef, while ABC is a toaster for fingers."</p> 
  </div> 
  <div class="readable-text  intended-text" refid="24" id="24" data-hash="cfe086a132bee1abceb74d80fd45f7e0"> 
  <p>Another question could be, "Which of our pet products are FDA-approved?" The corresponding answer: "Product XYZ has been approved by the FDA, which was probably a mistake."</p> 
  </div> 
  <div class="readable-text  intended-text" refid="25" id="25" data-hash="35bea31c7aed99b33c939ae1fa4ff4c4"> 
  <p>A customer might inquire, "What kind of plastic is Product XYZ made of? How big is Product XYZ?" To which the answer is: "Product XYZ is made of low-quality, easily-melted plastic. It weighs four pounds when clean, which it never is."</p> 
  </div> 
  <div class="readable-text  intended-text" refid="26" id="26" data-hash="df248c0e3c27f1c05cd7a07964e5a8da"> 
  <p>These are some silly examples, but you get the idea. By creating these evals, you're setting clear expectations for your chatbot's performance. Each successful response brings you one step closer to a fully functional RAG system that meets your company's needs.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="27" id="27" data-hash="6c0862890349870a9944b0153317d463"> 
  <p>To help you design effective evaluation sets for your RAG system, here are different sets of evals, each tailored to a specific application domain.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="28" id="28" data-hash="ff80d3137f858b6397138be4043f41f3"> 
  <p>For Medical Information Retrieval, you might include questions like: "What are the common symptoms of type 2 diabetes?", "List the potential side effects of amoxicillin", and "Explain the differences between MRI and CT scans." Financial Advisory questions could be: "What is the current inflation rate in the United States?", "How does a Roth IRA differ from a traditional IRA?", and "Explain the concept of dollar-cost averaging in investing."</p> 
  </div> 
  <div class="readable-text  intended-text" refid="29" id="29" data-hash="b5bda9b4567e54b3c904fd390eb8a424"> 
  <p>Possible E-commerce Product Recommendation questions are: "Recommend a laptop suitable for graphic design under $1,500.", "What are the top features of the latest smartphone models?", and "Compare noise-canceling headphones from Brand A and Brand B." For Customer Support, customers might ask: "How do I reset my account password if I've forgotten it?", "My order hasn't arrived yet. What should I do?", and "Explain how to set up two-factor authentication on my account."</p> 
  </div> 
  <div class="readable-text  intended-text" refid="30" id="30" data-hash="93a73b3326583b19dcbbb8ad421e7c35"> 
  <p>Questions in the Technical Support area could be: "Why is my computer running slowly, and how can I fix it?", "What are the steps to troubleshoot a Wi-Fi connection that keeps dropping?", and "How do I recover deleted files from my hard drive?" For News Summarization you might include: "Summarize the key points from the latest UN climate report.", "Provide a brief overview of recent global stock market trend.", and "What were the main outcomes of the recent G7 summit?"</p> 
  </div> 
  <div class="readable-text  intended-text" refid="31" id="31" data-hash="d4ab250f9db6c897de0fc96766c90ed8"> 
  <p>Building a RAG system becomes much more manageable with evals. Instead of abstract goals, you now have a tangible roadmap. It's all about taking that first step—getting one question to work—and building from there.</p> 
  </div> 

  <div class="readable-text" refid="32" id="32" data-hash="c623a92ee2358a5430973a60881eadae"> 
  <h2>2.2 Why you can’t write a single line of code until you have an eval</h2> 
  </div> 
  <div class="readable-text " refid="33" id="33" data-hash="c038004fc253335b313309af75b92984"> 
  <p>Without an eval, you're navigating without a compass. Your boss or client might have a grand vision, but unless it's spelled out with specific examples, you're left guessing. And let's face it—guesswork often leads to misaligned expectations and, ultimately, disappointment.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="34" id="34" data-hash="bbfa4f5bb26b94624d10752a9c786a74"> 
  <p>Here's the tricky part: your boss or client might not see the immediate need to provide these examples. They might say they're too busy or promise to get to it later. Days turn into weeks, and you're left in limbo. But here's the thing—you can't move forward without them. Politely but firmly remind your boss or client that you can't continue your work until you have some examples of the questions they want the AI to answer, along with the correct answers. By emphasizing the necessity of the eval, you're not just covering your bases; you're ensuring the project's success.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="35" id="35" data-hash="f00a0d4fc4ab684590e149bb66153112"> 
  <p>Without an eval, you risk falling prey to hidden assumptions. Your boss or client might have specific expectations they've never communicated. No matter how well you design the chatbot, if it doesn't align with these unspoken ideas, it won't meet their approval. By getting concrete examples upfront, you eliminate ambiguity. You know exactly what you're aiming for, and your boss knows what to expect.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="36" id="36" data-hash="3a132288d57e0cb05b1a98c8c86b3af9"> 
  <p>Imagine this scenario: your boss tests the chatbot with a question you've never seen before and isn't happy with the result. "Why didn't it answer my question correctly?" they ask. You can confidently respond, "That type of question wasn't included in the evals we discussed. I built the chatbot based on the examples provided. Would you like me to add this question to the list of evals?" This not only highlights the importance of the initial eval but also opens the door for further refinement. And for startups, as customers ask new kinds of questions, it's a good idea to add those questions to your evals.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="37" id="37" data-hash="a26237ad9ca87b2e250c182873565a65"> 
  <p>Aside from asking your boss, another valuable strategy for creating evals is involving a subject matter expert in the process. An expert can help write comprehensive evals—they know the intricacies of the domain and can provide nuanced questions and answers. They can also critique the chatbot's responses, ensuring that the answers are accurate and align with industry standards. This collaboration enhances the quality of your chatbot and adds credibility to the project.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="38" id="38" data-hash="68d1a5c299ee587c32a52dec86fc22bd"> 
  <p>A great way to come up with new evals is by tapping into your customer support channels. Talk to the folks on the frontline of your support desk—the people who answer the hardest or most frequent questions every day. You could also check out your company’s support ticket system to identify the top issues customers open tickets about and see if those can be addressed with RAG. Even support call transcripts can reveal recurring problems or phrases that show up often. Gathering real user queries this way helps you design evals that truly reflect everyday challenges, so your system is trained to solve actual user pain points rather than hypothetical scenarios.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="39" id="39" data-hash="7e1863b8b87da65848c61c3d2e0d7a7d"> 
  <p>Embarking on an AI project without an eval is like sending Raginald into the archives blindfolded. He might find something, but it's unlikely to be what you needed. So, before you write a single line of code, make sure you have that eval in hand. It's the foundation upon which your entire project rests.</p> 
  </div> 
  <div class="readable-text" refid="40" id="40" data-hash="4e446785d5abf20f85b1f93bf96ecdcb"> 
  <h2>2.3 How to use evals</h2> 
  </div> 
  <div class="readable-text " refid="41" id="41" data-hash="b9139127fdc36e720e12dd1c01c2891c"> 
  <p>So, you've got your evals in hand—those precious question-and-answer pairs from your boss or client—and you're ready to start building your Retrieval Augmented Generation (RAG) chatbot. But where do you begin? Let's walk through the process together, much like training our friend Raginald for his first day on the job.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="42" id="42" data-hash="848962210d146e937defb37196061ee4"> 
  <p>The journey starts with defining your evals, which serve as the foundation for your chatbot's capabilities. This is the first step in our development flow, as illustrated in figure 2.1. This flowchart outlines the iterative process of building and refining your RAG system: define evals, implement the RAG system, test the evals, modify prompts as needed, and re-test the evals until everything works smoothly. This chapter will only focus on evals, and the rest of the book will focus on implementing the RAG system.</p> 
  </div> 
  <div class="browsable-container figure-container" refid="43" id="43" data-hash="518716f68d5bb2bde11cf84d992a5c78"> 
  <h5>Figure 2.1 The iterative process for building a RAG system using evals. Steps include defining evals, implementing the system, testing, modifying prompts, and retesting for refinement.</h5> 
  <img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/021.png" data-alt="Title: dimensions:[138.75x246.55] - Description: 021.png" loading="lazy" width="185" height="329"> 
  </div> 
  <div class="readable-text " refid="44" id="44" data-hash="52b1d53809ecb644d712010cdc80e117"> 
  <p>Begin by selecting the easiest question-answer pair from your evals. Starting simple helps you get a feel for the process without becoming overwhelmed. Then, you will implement the RAG system, step by step, using the principles outlined in this book. In chapters 3 and 4, we will show you how to prepare your data for search, using two very different methods. In chapter 5, we will discuss using agents to improve answer quality and increase flexibility in your RAG system. Chapter 6 will cover the actual output of the system, using all the data collected by the agents to write a user-friendly answer to the eval question. When our system is finally set up and ready to go, we will run our first set of evals.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="45" id="45" data-hash="118830135f4cbca340dd1a759be39214"> 
  <p>For example, consider the question: "What is Product XYZ’s weight?" with the answer: "Product XYZ weighs 2.5 pounds." You will input "What is Product XYZ’s weight?" into your chatbot and see if you receive the expected output: "Product XYZ weighs 2.5 pounds." Compare the chatbot's actual response to the expected answer to determine if it performs correctly.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="46" id="46" data-hash="6d75559a4acd526b7db91c2c52475ad2"> 
  <p>If the chatbot doesn't provide the correct answer, it's time to modify your prompts or code accordingly. We will show you how to modify your prompts and code in later chapters. This troubleshooting step is crucial and is part of the iterative process shown in Figure 2.1. The problem usually falls into one of two categories: retrieving the wrong data or generating the wrong answer when given the correct data. Use the tips provided later in this book to diagnose and fix the issue.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="47" id="47" data-hash="76b5126de477a1caec4fe26f2df42024"> 
  <p>Once you've addressed any issues and your chatbot provides the correct answer, move on to the next question-answer pair in your evals. Run that question through your RAG system, and compare your system’s output to the expected answer from the eval. If it works on the first try, great! If not, you may need to add more agents and databases, similar to what you did for the first eval. Don’t worry, all this will be covered in later chapters. Just make sure that when you change your code, make sure to run BOTH the first and the second eval questions. You want to make sure that by improving your RAG system’s response to eval question 2, you did not degrade its response to eval question 1. Continue on with this pattern, modifying code and running evals, until every eval is passing. This iterative approach ensures that all expected question types are addressed, building confidence and creating a solid foundation for handling more complex queries. We will show you how to do this automatically, every time you push code, in the next sub-section. Normally, we would build this as part of a Continuous Integration/Continuous Deployment pipeline after the whole RAG system has been completed, but we want to give you the full picture of how and why we use evals from the beginning. You may want to review this chapter and in particular the following sub-section after you have completed your RAG pipeline at the end of this book.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="48" id="48" data-hash="4ff9226b214258bc7ea6d41587644cf3"> 
  <p>Think about how we would train our diligent assistant, Raginald. We wouldn’t just throw him into the archives without guidance. We would identify the questions he might be asked, map out the resources he would need, and provide instructions on how he should find and present the information. The same principles apply to your RAG chatbot. By methodically working through each eval, you ensure your chatbot is well-prepared to meet the needs of your users.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="49" id="49" data-hash="db1753327c974393c31c3b07291cd05d"> 
  <p>After the RAG system is completed, evals can be used for debugging. For example, let’s say you have an eval that asks, “What is the quality rating of Stereo 123?”. You enter that question into your RAG system, and it responds, “I’m sorry, but I can’t find any information on Stereo 123.” You then discover that your database connection is not working, because you are using an old API key. You update the API key in your code and run the eval again using the same question. This time, the RAG system responds, “Stereo 123 is rated AA Quality.” You have now diagnosed and fixed a problem using your evals. Of course, your search functions should have unit tests too, but having an eval in place serves as an extra security measure, because it tests your pipeline from end to end.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="50" id="50" data-hash="a63f5313ebd26fdb81bc09a91b54eeca"> 
  <p>As another example, let’s imagine one of your eval questions says, “How much does Product ABC weigh?” and its corresponding correct answer is “Product XYZ weighs 6.53 kilograms.” When you ask your RAG system the eval question, it generates the answer “Product ABC weighs 1 stone.” However, your eval specified that the units should be in kilograms, not stone. You dive into your code, and add a prompt to your writer agent, telling it to return all weights in kilograms. Finally, you run your eval question through the RAG system again and get the correct answer: “Product XYZ weighs 6.53 kilograms.”</p> 
  </div> 
  <div class="readable-text  intended-text" refid="51" id="51" data-hash="6664b1955a60c99b378b0a2384c65aa9"> 
  <p>Using evals effectively bridges the gap between your stakeholders' expectations and the technical implementation of your chatbot. It ensures that you're not just building a chatbot—you're building the right chatbot. By following this structured, iterative process, you align your development efforts with the needs of your business, resulting in a more efficient and effective RAG system.</p> 
  </div> 

              <div class="_outer-container">
              <div class="_inner-container">
                  <div class="_inner-wrapper">
                      <div>
                          <svg id="_manningOnlineLogo" width="388" height="44" viewBox="0 0 388 44" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M198.359 5.15271C191.908 5.15271 188.681 10.7866 188.681 22.0495C188.681 33.3664 192.087 39.0308 198.91 39.0308C201.011 39.0308 202.744 38.6248 204.116 37.817V28.764C204.116 23.2745 202.168 20.5328 198.27 20.5328C197.719 20.5328 197.189 20.5779 196.673 20.6619V24.301C196.823 24.274 197.083 24.2587 197.45 24.2587C198.177 24.2587 198.696 24.5032 198.998 24.9912C199.394 25.6008 199.593 26.7323 199.593 28.372V35.3025C199.473 35.3327 199.309 35.3471 199.092 35.3471C195.411 35.3471 193.57 30.9115 193.57 22.0495C193.57 13.2415 195.467 8.84103 199.275 8.84103C199.851 8.84103 200.567 8.92726 201.42 9.09693V5.54713C200.45 5.28437 199.426 5.15271 198.359 5.15271ZM0.8479 5.37338V38.8077H5.50154V20.9671L8.60723 29.7595H10.7032L13.8065 20.9671V38.8077H18.5169V22.0906V5.3734H16.1839L9.65151 22.7867L3.17595 5.3734L0.8479 5.37338ZM66.5146 5.37338V38.8077H71.1731V19.7557L79.0707 38.8077H81.4012V5.3734H76.6958V24.5616L68.8451 5.3734L66.5146 5.37338ZM99.7614 5.37338V38.8077H104.422V19.7557L112.32 38.8077H114.648V5.3734H109.943V24.5616L102.092 5.3734L99.7614 5.37338ZM133.006 5.37338V38.8077H137.852V5.3734L133.006 5.37338ZM156.165 5.37338V38.8077H160.821V19.7557L168.724 38.8077H171.052V5.3734H166.346V24.5616L158.493 5.3734L156.165 5.37338ZM37.7115 5.37575L32.3691 38.8077H36.6647L37.4868 32.8773H42.3232L43.1922 38.8077H47.7125L42.375 5.37575H37.7115ZM39.9038 15.2081L41.8245 29.1937H37.988L39.9038 15.2081Z" fill="white"></path>
                              <rect x="223.802" y="0.978424" width="2.01079" height="42.2266" fill="#56CCF2"></rect>
                              <path d="M260.092 22.0728C260.092 7.7793 256.24 5.33998 252.602 5.33998C248.965 5.33998 245.07 7.7793 245.07 22.0728C245.07 36.3664 248.965 38.8057 252.602 38.8057C256.24 38.8057 260.092 36.3664 260.092 22.0728ZM255.555 22.0728C255.555 33.0712 254.057 35.1681 252.602 35.1681C251.147 35.1681 249.65 33.0712 249.65 22.0728C249.65 11.0745 251.147 8.97756 252.602 8.97756C254.057 8.97756 255.555 11.0745 255.555 22.0728ZM288.47 38.5917V5.55395H284.062V24.5122L276.702 5.55395H274.519V38.5917H278.884V19.7619L286.288 38.5917H288.47ZM314.272 38.5917V34.9541H308.153V5.55395H303.616V38.5917H314.272ZM332.151 38.5917V5.55395H327.615V38.5917H332.151ZM361.219 38.5917V5.55395H356.811V24.5122L349.45 5.55395H347.267V38.5917H351.632V19.7619L359.036 38.5917H361.219ZM387.235 38.5917V34.9541H380.901V27.7218H385.908V24.0842H380.901V9.19153H387.235V5.55395H376.365V24.0842H374.952V27.7218H376.365V38.5917H387.235Z" fill="#56CCF2"></path>
                          </svg>
                          <div class="_message-container">join today to enjoy <strong>all our content. all the time.</strong></div>
                      </div>
  
                      <div class="_cursor-container">
                          <svg width="52" height="52" viewBox="0 0 52 52" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M26.1527 14.0537L25.606 12.1037L30.9536 9.51994L31.8025 11.3172L26.1527 14.0537ZM22.1203 8.67819L23.8374 9.74419L26.008 3.53019L24.1461 2.86719L22.1203 8.67819ZM14.3256 19.7737L13.168 18.1227L7.82364 20.7064L8.67578 22.5069L14.3256 19.7737ZM17.3033 8.40194L15.1681 3.89419L13.3899 4.75544L15.5218 9.26319L17.3033 8.40194ZM6.30908 13.0592L12.4574 15.2497L12.7146 13.2282L6.96507 11.1807L6.30908 13.0592ZM19.2938 13.0397L45.5783 32.4227H34.4619L40.3722 44.3404L32.1562 48.5167L26.098 36.3942L19.2938 45.8257V13.0397ZM22.5094 35.8547L26.5964 30.1867L33.5776 44.1552L36.0536 42.8942L29.2525 29.1727H35.7159L22.5094 19.4357V35.8547Z" fill="white"></path>
                          </svg>
                      </div>
                      <a href="https://www.manning.com/subscription" name="banner-link">&nbsp;</a>
                  </div>
              </div>
          </div>
  </div><div class="readable-text" refid="52" id="52" data-hash="cadd896b5d695a53d64804a47215dfa3"> 
  <h2>2.4 Automatic evals in end-to-end testing</h2> 
  </div> 
  <div class="readable-text " refid="53" id="53" data-hash="aab40944584090478200ed1cb301b113"> 
  <p>In software development, automated testing is an important part of maintaining quality and reliability. Every time you upload code, build, or deploy, automated tests help ensure that everything works as expected. You can apply the same principle to your Retrieval Augmented Generation (RAG) chatbot using evaluations, or "evals." Let's explore how automating your evals can keep your chatbot performing at its best, even as you make changes.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="54" id="54" data-hash="3b1a78dc83ae6597ee872c3a1922845e"> 
  <p>At its simplest, you can run your evals by sitting down and asking the chatbot those questions, then manually checking if the answers match your expectations. While this manual approach works for small-scale testing, it becomes impractical as your chatbot grows more complex. That's where automated evals come into play.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="55" id="55" data-hash="9a4afbb4e3b3e1c0a1e647077b86f8fa"> 
  <p>Imagine you have ten eval questions to test your chatbot. You've fine-tuned your system so that it gives the correct answer for every question—except for question number three. Determined to fix this, you tweak your prompt slightly. Great news: question number three now provides the correct answer! But hold on—suddenly, questions two and five aren't working anymore.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="56" id="56" data-hash="31e63b4480b8acc558b716c7098568aa"> 
  <p>This is called regression, and it is a common scenario when making changes to your system. Adjusting one part can inadvertently affect others. Automated evals help you avoid this predicament by catching such issues early, allowing you to revise your prompts or code before any real damage is done. They can also help you catch anomalies like missing data, and make sure that vague or confusing queries are handled correctly. They ensure that your chatbot continues to perform as expected after any changes, maintaining a consistent level of performance. When you modify prompts or instructions, automated evals help verify that these changes haven't negatively impacted the chatbot's responses elsewhere. It's a safety net that alerts you to unintended consequences.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="57" id="57" data-hash="c08c797ba16146fa3c3e56ddb8978770"> 
  <p>Figure 2.2 illustrates the automated evals process. In this flowchart, you can see how the process is initiated whenever changes are made to the chatbot. It starts with triggering the automated evals, then proceeds to test the chatbot's responses against expected answers. If errors are found, we must modify the prompts or code accordingly, and the evals are run again. If all tests pass, the updated chatbot can be deployed confidently. This visual representation helps you understand the cyclical nature of testing and refining your chatbot to maintain optimal performance.</p> 
  </div> 
  <div class="browsable-container figure-container" refid="58" id="58" data-hash="7b4a1454ca5516cb186c5171f51dd134"> 
  <h5><span name="_Hlk182224959">Figure 2.2 Using evals as test cases in CI/CD pipelines. Evals ensure the chatbot consistently meets performance standards by running, modifying, and retesting prompts in a continuous feedback loop</span>.</h5> 
  <img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/02__image001.png" data-alt="Title: dimensions:[378x247.4] - Description: 022.png" loading="lazy" width="1200" height="785" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/02__image001.png" class="medium-zoom-image"> 
  </div> 
  <div class="readable-text " refid="59" id="59" data-hash="5f5394b6589f1ab3f54110fc1045f6a9"> 
  <p>Automated evals catch discrepancies or errors immediately. This early detection allows you to address problems before they affect your users. They also save you time by automating the testing process. Instead of manually checking each response after every tweak, you can focus on development, trusting that the evals will alert you to any issues. Additionally, evals can test to make sure your RAG chatbot responds without bias, filters inappropriate content, and properly handles edge cases.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="60" id="60" data-hash="c8e439ee025b0d70a483c02f85d63c18"> 
  <p>Figure 2.3 shows the automated evals implementation. This flowchart demonstrates how different components interact in the evaluation process. It begins with the test script, which sends eval questions to the chatbot. The chatbot generates responses that are then passed to the Large Language Model (LLM) for evaluation. The LLM compares the chatbot's responses to the expected answers. Based on the evaluation, the system decides whether to pass the tests or to fail them. This figure provides a clear picture of the components involved and how they work together to automate the testing process.</p> 
  </div> 
  <div class="browsable-container figure-container" refid="61" id="61" data-hash="23400b667b9e7c798735e7360de49a43"> 
  <h5>Figure 2.3 How the Automated Eval process works. Evals interact with the chatbot and large language model (LLM) to assess and ensure response accuracy, passing or failing based on similarity.</h5> 
  <img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/02__image002.png" data-alt="Title: dimensions:[317.5x198.7] - Description: 023.png" loading="lazy" width="1200" height="750" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/02__image002.png" class="medium-zoom-image"> 
  </div> 
  <div class="readable-text" refid="62" id="62" data-hash="8798575feaa8eed7b6cea102c97eed6a"> 
  <h3>2.4.1 How to use LLMS in the eval process</h3> 
  </div> 
  <div class="readable-text " refid="63" id="63" data-hash="55f13448c389160b8a417e21002aa52a"> 
  <p>After obtaining the chatbot's responses, you'll compare them to the expected answers using a Large Language Model. The LLM assesses the similarity between the chatbot's response and the expected answer. You can define what constitutes "sufficiently similar" based on specific criteria relevant to your use case. If responses are similar enough, the deployment proceeds. If not, the pipeline returns an error and aborts the deployment. Setting up alerts to notify the development team of any failures allows for immediate action.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="64" id="64" data-hash="f16c5bb314eebb47c466c899c617c84f"> 
  <p>Using an LLM for comparison has its benefits and disadvantages. LLMs can grasp semantic similarities even when the wording isn't identical, ensuring that correct answers aren't missed due to phrasing differences. They account for variations in phrasing while focusing on the correctness of the information, making evaluations more accurate. Automating the comparison process reduces manual effort, saving you time and allowing you to focus on development.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="65" id="65" data-hash="86fe763e5c573c6df5edf564c9de0376"> 
  <p>However, LLMs can sometimes provide inconsistent evaluations due to their random-ish nature. This means you still need a human in the loop to monitor and verify the results, or add some rule-based checks. For example, your chatbot may have answered a question perfectly, but the LLM judging its response might incorrectly rank the answer as low-quality. You may want to also add a rule in your code that makes sure certain keywords are present in the answers. For example, if an eval question says, “What is ProductXYZ?” you might want to include some code to check whether “toaster” and “meat” are in the answer.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="66" id="66" data-hash="7d89e81a957b2669b32b5a909fff804d"> 
  <p>Running evaluations through an LLM, especially at scale, can also lead to higher computational and monetary expenses, impacting your project's budget. By weighing these pros and cons, you can decide how best to integrate LLMs into your evaluation process. We recommend combining automated evaluations with occasional human oversight to get the best of both worlds.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="67" id="67" data-hash="2f49cb8f967bf4426dc3d3e5065b0fe3"> 
  <p>As you refine your chatbot's prompts and instructions, automated evals help you maintain quality by verifying that changes enhance the chatbot's performance without introducing errors. You can make adjustments confidently, knowing you have a safety net to catch unintended consequences. This ensures that the chatbot continues to meet the expectations set by your boss and stakeholders.</p> 
  </div> 
  <div class="readable-text" refid="68" id="68" data-hash="82709060e4deb1457bef8d8407de99a9"> 
  <h3>2.4.2 Testing all data sources</h3> 
  </div> 
  <div class="readable-text " refid="69" id="69" data-hash="9c132e4186881c2875ae08f57bdca51e"> 
  <p>To build an effective RAG chatbot, it's essential to have evals that represent each data source your chatbot will access. Think of it as ensuring Raginald is well-versed in every section of the library he might need to visit. Having evals for each data source ensures comprehensive testing. It allows you to verify the chatbot's ability to retrieve and handle information from all parts of your system, spot areas where the chatbot might be failing, and fix the problems quickly. For example, your “products” database might be down this week. You might not know, unless you run evals that specifically query data from that database.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="70" id="70" data-hash="dc557fd80fd34fdaf2b805f010a8eac0"> 
  <p>Start by listing all the data sources your chatbot will interact with, such as customer information databases, product attributes databases, order histories, inventory management systems, company policies and codes, and support knowledge bases. For each data source, develop at least one question-and-answer pair. For example, for the customer information database, you might have:</p> 
  </div> 
  <ul> 
  <li class="readable-text" refid="71" id="71" data-hash="52ac01e1dc8f77cc2a9f5e3423cab9bd"><strong>Question:</strong> "What is the last order placed by customer Jane Doe?"</li> 
  <li class="readable-text" refid="72" id="72" data-hash="6da95d15fc8b412afdd77453a4d01d4d"><strong>Answer:</strong> "Jane Doe's last order was #98765, placed on March 15, 2023, for a set of stainless steel cookware."</li> 
  </ul> 
  <div class="readable-text " refid="73" id="73" data-hash="110c1382ef4616d117688a39378c7119"> 
  <p>By covering all data sources, you ensure that your chatbot can handle inquiries related to any part of your system, providing a balanced performance across the board.</p> 
  </div> 
  <div class="readable-text" refid="74" id="74" data-hash="0c8d5b1dee3e229885efb0f91773e856"> 
  <h3>2.4.3 Implementing automated evals</h3> 
  </div> 
  <div class="readable-text " refid="75" id="75" data-hash="87b263d233177a42b6e54126cedf0808"> 
  <p>Now, let’s look at how you can implement automated evals programmatically. You might be wondering why we’re creating these evals at the very beginning of the RAG chatbot process, rather than at the end. It’s a lot like Test-Driven Development (TDD): we write our tests first, then build the code that passes them. By the time you finish this book, you’ll have a complete RAG system that can pass these specific evaluation questions.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="76" id="76" data-hash="a6b7f1eaa5e5220edadc34eb36c7aa45"> 
  <p>We'll break down the code into parts and explain each segment before showing it. Please see figure 2.4 below for a brief overview of our code building process.</p> 
  </div> 
  <div class="browsable-container figure-container" refid="77" id="77" data-hash="93521375012bffc56f490a100359ee1a"> 
  <h5>Figure 2.4 The automated eval system for RAG development. Evals compare chatbot answers to expected outputs and automate testing via GitHub Actions, ensuring high-quality performance.</h5> 
  <img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/02__image003.png" data-alt="Title: dimensions:[219.65x190.05] - Description: 024.png" loading="lazy" width="1200" height="1031" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/02__image003.png" class="medium-zoom-image"> 
  </div> 
  <div class="readable-text " refid="78" id="78" data-hash="415b43828226064ff5ee51dbae6ed427"> 
  <p>Before we dive into the code, make sure you have Python 3.11 (or a suitable version) installed. If you need to install Python or update it, you can download it at python.org. You’ll also want to have Git installed to manage your version control; if that’s new to you, check out the Git docs at git-scm.com.</p> 
  </div> 
  <div class="readable-text  intended-text" refid="79" id="79" data-hash="15d4e24d285d4487678ccbabfcefae01"> 
  <p>Once you’ve got Python and Git, create a folder called RagInProduction. Open your terminal or command prompt, navigate into that folder, and run git init to initialize a new repository. Setting up a virtual environment (e.g., using python -m venv venv) is optional but can help keep your dependencies organized. Next, install the OpenAI library by running:</p> 
  </div> 
  <div class="browsable-container listing-container no-annotations" refid="80" id="80" data-hash="d78c6a6bbbcad6a6ce6cb67de352b910"> 
  <div class="code-area-container"> 
  <pre class="code-area" data-code-area-highlighted="true"><code class="hljs"><span class="hljs-attribute">pip</span> install openai</code></pre> 
  <div class="code-annotations-overlay-container" data-annotations-created="true"></div> 
  </div> 
  <div class="listing-environment-container">
  <div class="listing-environment-toolbar">
  <span class="listing-environment-runnable-script-container">
  
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
  </span>
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
  </span>
  </span></div>
  </div></div> 
  <div class="readable-text " refid="81" id="81" data-hash="df0fa7103e2bb91f8a63bcb8589caeb2"> 
  <p>This library lets you send requests to OpenAI models and retrieve their responses. For more information on the OpenAI API, click here: <a href="https://www.geeksforgeeks.org/openai-python-api/">https://www.geeksforgeeks.org/openai-python-api/</a>, and to get an OpenAI API key, click here: <a href="https://platform.openai.com/docs/quickstart">https://platform.openai.com/docs/quickstart</a>. However, you should NOT store your API key directly in your script, for security reasons—this is where environment variables come in. The simplest way to keep your API key secure is to create a file named <kbd>.env</kbd> in your project folder, and include in it the following:</p> 
  <div class="paragraph-bubble" data-forums-active="true" data-comment-ids="577769">
  <div aria-haspopup="true" class="text-margin-icon-bubble bookmark-bubble" title="bookmark"><i class="fa fa-bookmark"></i></div>
  <div aria-haspopup="true" class="text-margin-icon-bubble forums-bubble" title="open discussion"><i class="fa fa-comments" aria-hidden="true"></i><span class="comment-count-container">1</span></div>
  <div aria-haspopup="true" class="text-margin-icon-bubble paragraph-notification-bubble" title="show text addons"><i class="fa fa-dot-circle" aria-hidden="true"></i></div>
   <div aria-haspopup="true" class="text-margin-icon-bubble live-chapter-bubble" title="activate interactive feature"><svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M.18216 26.4444H5.84882C5.71797 26.4421 5.58982 26.4068 5.47624 26.3417C5.36267 26.2767 5.26734 26.184 5.1991 26.0724C5.13085 25.9607 5.09189 25.8336 5.08582 25.7029C5.07975 25.5721 5.10677 25.442 5.16438 25.3244L9.76105 16.3333H4.6666C4.52643 16.3345 4.38856 16.2978 4.26755 16.227C4.14654 16.1563 4.0469 16.0541 3.97916 15.9314C3.91143 15.8087 3.87811 15.67 3.88275 15.5299C3.88738 15.3898 3.92979 15.2535 4.00549 15.1356L12.3122 1.91333C12.3803 1.80705 12.4732 1.71894 12.583 1.65661C12.6927 1.59428 12.816 1.5596 12.9422 1.55556H23.3877C23.543 1.54821 23.697 1.58758 23.8297 1.66858C23.9624 1.74958 24.0678 1.8685 24.1322 2.00999C24.1967 2.15147 24.2173 2.30903 24.1913 2.46233C24.1654 2.61563 24.0941 2.75763 23.9866 2.87L16.9399 10.8889H21.1244C21.2725 10.892 21.4167 10.9374 21.5399 11.0197C21.6632 11.102 21.7603 11.2178 21.82 11.3534C21.8796 11.489 21.8993 11.6389 21.8766 11.7853C21.854 11.9318 21.79 12.0687 21.6922 12.18L8.75771 26.18C8.6857 26.262 8.59723 26.3279 8.49807 26.3735C8.39891 26.419 8.29128 26.4432 8.18216 26.4444V26.4444ZM7.13994 24.8889H7.84771L19.3355 12.4444H15.2366C15.0813 12.4518 14.9273 12.4124 14.7946 12.3314C14.6619 12.2504 14.5565 12.1315 14.4921 11.99C14.4276 11.8485 14.407 11.691 14.433 11.5377C14.4589 11.3844 14.5303 11.2424 14.6377 11.13L21.6844 3.11111H13.3699L6.04327 14.7778H11.0444C11.1752 14.7801 11.3034 14.8155 11.417 14.8805C11.5305 14.9455 11.6259 15.0382 11.6941 15.1499C11.7624 15.2615 11.8013 15.3886 11.8074 15.5194C11.8135 15.6501 11.7864 15.7803 11.7288 15.8978L7.13994 24.8889Z" fill="#828282"></path>
  </svg></div>
   <div aria-haspopup="true" class="text-margin-icon-bubble live-test-thunder-chapter-bubble" title="activate liveTest"><svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M.18216 26.4444H5.84882C5.71797 26.4421 5.58982 26.4068 5.47624 26.3417C5.36267 26.2767 5.26734 26.184 5.1991 26.0724C5.13085 25.9607 5.09189 25.8336 5.08582 25.7029C5.07975 25.5721 5.10677 25.442 5.16438 25.3244L9.76105 16.3333H4.6666C4.52643 16.3345 4.38856 16.2978 4.26755 16.227C4.14654 16.1563 4.0469 16.0541 3.97916 15.9314C3.91143 15.8087 3.87811 15.67 3.88275 15.5299C3.88738 15.3898 3.92979 15.2535 4.00549 15.1356L12.3122 1.91333C12.3803 1.80705 12.4732 1.71894 12.583 1.65661C12.6927 1.59428 12.816 1.5596 12.9422 1.55556H23.3877C23.543 1.54821 23.697 1.58758 23.8297 1.66858C23.9624 1.74958 24.0678 1.8685 24.1322 2.00999C24.1967 2.15147 24.2173 2.30903 24.1913 2.46233C24.1654 2.61563 24.0941 2.75763 23.9866 2.87L16.9399 10.8889H21.1244C21.2725 10.892 21.4167 10.9374 21.5399 11.0197C21.6632 11.102 21.7603 11.2178 21.82 11.3534C21.8796 11.489 21.8993 11.6389 21.8766 11.7853C21.854 11.9318 21.79 12.0687 21.6922 12.18L8.75771 26.18C8.6857 26.262 8.59723 26.3279 8.49807 26.3735C8.39891 26.419 8.29128 26.4432 8.18216 26.4444V26.4444ZM7.13994 24.8889H7.84771L19.3355 12.4444H15.2366C15.0813 12.4518 14.9273 12.4124 14.7946 12.3314C14.6619 12.2504 14.5565 12.1315 14.4921 11.99C14.4276 11.8485 14.407 11.691 14.433 11.5377C14.4589 11.3844 14.5303 11.2424 14.6377 11.13L21.6844 3.11111H13.3699L6.04327 14.7778H11.0444C11.1752 14.7801 11.3034 14.8155 11.417 14.8805C11.5305 14.9455 11.6259 15.0382 11.6941 15.1499C11.7624 15.2615 11.8013 15.3886 11.8074 15.5194C11.8135 15.6501 11.7864 15.7803 11.7288 15.8978L7.13994 24.8889Z" fill="#828282"></path>
  </svg></div>
  <div class="text-margin-icon-bubble editor-bubble"><i class="fa fa-edit fa-2x"></i></div>
  </div></div> 
  <div class="browsable-container listing-container no-annotations" refid="82" id="82" data-hash="4af808e2da83b556bcf278539027b8ac"> 
  <div class="code-area-container"> 
  <pre class="code-area" data-code-area-highlighted="true"><code class="hljs hljs-line-numbers" style="float:left"><div class="line-number line-number-1">1</div><div class="line-number line-number-2">2</div></code><code class="hljs"><span class="hljs-attr">OPENAI_API_KEY</span>=sk-abc123YourKey
  </code></pre> 
  <div class="code-annotations-overlay-container" data-annotations-created="true"></div> 
  </div> 
  <div class="listing-environment-container">
  <div class="listing-environment-toolbar">
  <span class="listing-environment-runnable-script-container">
  
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
  </span>
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
  </span>
  </span></div>
  </div></div> 
  <div class="readable-text " refid="83" id="83" data-hash="6ea66e1698e2a4a56509c3efab7437f9"> 
  <p>Then in the terminal, install the <a href="https://pypi.org/project/python-dotenv/" target="_new">python-dotenv</a> package:</p> 
  </div> 
  <div class="browsable-container listing-container no-annotations" refid="84" id="84" data-hash="02977cd30f5b3d147ecaf302b2e2d075"> 
  <div class="code-area-container"> 
  <pre class="code-area" data-code-area-highlighted="true"><code class="hljs hljs-line-numbers" style="float:left"><div class="line-number line-number-1">1</div><div class="line-number line-number-2">2</div></code><code class="hljs"><span class="hljs-attribute">pip</span> install python-dotenv
  </code></pre> 
  <div class="code-annotations-overlay-container" data-annotations-created="true"></div> 
  </div> 
  <div class="listing-environment-container">
  <div class="listing-environment-toolbar">
  <span class="listing-environment-runnable-script-container">
  
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
  </span>
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
  </span>
  </span></div>
  </div></div> 
  <div class="readable-text " refid="85" id="85" data-hash="78c87814870bcf8ab3399df921061d28"> 
  <p>In your scripts, you can load and use the key without exposing it. For example:</p> 
  </div> 
  <div class="browsable-container listing-container no-annotations" refid="86" id="86" data-hash="72ff347cde1c62c2e679424c28d1e368"> 
  <div class="code-area-container"> 
  <pre class="code-area" data-code-area-highlighted="true"><code class="hljs hljs-line-numbers" style="float:left"><div class="line-number line-number-1">1</div><div class="line-number line-number-2">2</div><div class="line-number line-number-3">3</div><div class="line-number line-number-4">4</div><div class="line-number line-number-5">5</div><div class="line-number line-number-6">6</div></code><code class="hljs"><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
  <span class="hljs-keyword">import</span> os
  
  load_dotenv()
  openai.api_key = os.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>)
  </code></pre> 
  <div class="code-annotations-overlay-container" data-annotations-created="true"></div> 
  </div> 
  <div class="listing-environment-container">
  <div class="listing-environment-toolbar">
  <span class="listing-environment-runnable-script-container">
  
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
  </span>
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
  </span>
  </span></div>
  </div></div> 
  <div class="readable-text " refid="87" id="87" data-hash="6b752549f6fd4ac0fe531233e06dfce3"> 
  <p>This approach prevents your key from ending up in version control or shared in plain text.</p> 
  </div> 
  <div class="callout-container admonition-block"> 
  <div class="readable-text" refid="88" id="88" data-hash="f35a087d0dc71beb3a7204d91c1c49e4"> 
  <h5>Note</h5> 
  </div> 
  <div class="readable-text" refid="89" id="89" data-hash="2ea61f5427fda2ff831f09fae13e1470"> 
  <p>The code in this book is designed to illustrate, as simply as possible, the key concepts of RAG in production. Before deploying any code in a professional setting, you will likely need to add unit tests, docstrings, type hints, logs, and error messages. We did not include docstrings because Manning allows annotations in their code, and we did not include type hints, tests, logs, or error messages for the sake of keeping things short, simple, and easily readable. You will have to deal with all of these things in Prod, but we chose to leave them out because they would not add anything to the learning.</p> 
  </div> 
  </div> 
  <div class="readable-text " refid="90" id="90" data-hash="c8be4d6cff1a6f9682e023f1e4ac8536"> 
  <p>With all that in mind, let’s begin by creating our automatic evals script in a file called run_evals.py. Inside this file, you can start by setting up two lists: one for your evaluation questions and another for the correct, expected answers. After that, you’ll define a function that sends messages to the OpenAI API, taking care of the communication with the LLM and ensuring the prompts are delivered correctly.</p> 
  </div> 
  <div class="browsable-container listing-container" refid="91" id="91" data-hash="fc010bc57fa6c6cd4b69841b67532a57" data-annotation-type="letters"> 
  <h5>Listing 2.1 Building automatic evals</h5> 
  <div class="code-area-container"> 
  <pre class="code-area" data-code-area-highlighted="true"><div class="line-container listing-line-group groupA" style="top: 119px; height:203px; line-height:203px;" data-code=""></div><code class="hljs hljs-line-numbers" style="float:left"><div class="line-number line-number-1">1</div><div class="line-number line-number-2">2</div><div class="line-number line-number-3">3</div><div class="line-number line-number-4">4</div><div class="line-number line-number-5">5</div><div class="line-number line-number-6">6</div><div class="line-number line-number-7">7</div><div class="line-number line-number-8">8</div><div class="line-number line-number-9">9</div><div class="line-number line-number-10">10</div><div class="line-number line-number-11">11</div><div class="line-number line-number-12">12</div><div class="line-number line-number-13">13</div><div class="line-number line-number-14">14</div><div class="line-number line-number-15">15</div><div class="line-number line-number-16">16</div><div class="line-number line-number-17">17</div><div class="line-number line-number-18">18</div><div class="line-number line-number-19">19</div><div class="line-number line-number-20">20</div><div class="line-number line-number-21">21</div></code><code class="hljs"><span class="hljs-keyword">import</span> openai
  <span class="hljs-keyword">import</span> os
  <span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
  load_dotenv()
  
  
  evals = [
  <span class="hljs-string">"What is Underwhelming Spatula?"</span>,
  <span class="hljs-string">"Who wrote 'Dubious Parenting Tips'?"</span>,
  <span class="hljs-string">"How long is Almost-Perfect Investment Guide?"</span>,
  ]
  
  eval_answers = [
  <span class="hljs-string">"Underwhelming Spatula is a kitchen tool that 
  ➥redefines expectations by fusing whimsy with 
  ➥functionality."</span>,
  <span class="hljs-string">"Lisa Melton wrote Dubious Parenting Tips."</span>,
  <span class="hljs-string">"The Almost-Perfect Investment Guide is 210 pages 
  ➥long."</span>,
  ]
  </code></pre> 
  <div class="code-annotations-overlay-container" data-annotations="I0EgQ3JlYXRlIGxpc3RzIG9mIHF1ZXN0aW9ucyBhbmQgYW5zd2VycyBnaXZlbiB0byB5b3UgYnkgeW91ciBib3NzIGFuZC9vciB0aGUgc3Rha2Vob2xkZXJzIGluIHlvdXIgUkFHIHByb2plY3Qu" data-annotations-created="true"><div class="annotation-container" data-annotation-label="A" style="top:119px; height:203px; line-height:203px" data-start-line-index="7" data-end-line-index="18" title="Create lists of questions and answers given to you by your boss and/or the stakeholders in your RAG project.">
                                              <span class="annotation-label" id="A">A</span>
                                          </div></div> 
  </div> 
  <div class="listing-environment-container">
  <div class="listing-environment-toolbar">
  <span class="listing-environment-runnable-script-container">
  
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
  </span>
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
  </span>
  </span></div>
  </div></div> 
  <div class="readable-text " refid="92" id="92" data-hash="e84c4d6b66761648f9aa173d03c1fd6f"> 
  <p>Next, in the same file we define a function to send messages to the OpenAI API. This function will handle the communication with the LLM.</p> 
  </div> 
  <div class="browsable-container listing-container" refid="93" id="93" data-hash="7457f2adb3a6374d1836fffb95f052c3" data-annotation-type="letters"> 
  <h5>Listing 2.2 Building the “Send to OpenAI” function</h5> 
  <div class="code-area-container"> 
  <pre class="code-area" data-code-area-highlighted="true"><div class="line-container listing-line-group groupA" style="top: 17px; height:16px; line-height:16px;" data-code="ICBvcGVuYWkuYXBpX2tleSA9IG9zLmVudmlyb24uZ2V0KCJPUEVOQUlfQVBJX0tFWSIp"></div><div class="line-container listing-line-group groupB" style="top: 51px; height:16px; line-height:16px;" data-code="ICAgIG1vZGVsPSJncHQtNG8iLA=="></div><div class="line-container listing-line-group groupC" style="top: 68px; height:16px; line-height:16px;" data-code="ICAgIG1lc3NhZ2VzPVt7InJvbGUiOiAidXNlciIsICJjb250ZW50IjogbWVzc2FnZX1d"></div><div class="line-container listing-line-group groupD" style="top: 102px; height:16px; line-height:16px;" data-code="ICByZXR1cm4gY29tcGxldGlvbi5jaG9pY2VzWzBdLm1lc3NhZ2UuY29udGVudC5zdHJpcCgp"></div><code class="hljs hljs-line-numbers" style="float:left"><div class="line-number line-number-1">1</div><div class="line-number line-number-2">2</div><div class="line-number line-number-3">3</div><div class="line-number line-number-4">4</div><div class="line-number line-number-5">5</div><div class="line-number line-number-6">6</div><div class="line-number line-number-7">7</div></code><code class="hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_to_openai</span><span class="hljs-params">(message)</span>:</span>
  openai.api_key = os.environ.get(<span class="hljs-string">"OPENAI_API_KEY"</span>)
  completion = openai.chat.completions.create(
  model=<span class="hljs-string">"gpt-4o"</span>,
  messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: message}]
  )
  <span class="hljs-keyword">return</span> completion.choices[<span class="hljs-number">0</span>].message.content.strip()</code></pre> 
  <div class="code-annotations-overlay-container" data-annotations="I0EgWW91IHdpbGwgbmVlZCB0byBnZXQgYW4gQVBJIGtleSBmcm9tIE9wZW5BSSBieSBzaWduaW5nIHVwIGZvciBhbiBhY2NvdW50LgojQiBDaGF0Q29tcGxldGlvbi5jcmVhdGUgc2VuZHMgdGhlIG1lc3NhZ2UgdG8gdGhlIG1vZGVsIHNwZWNpZmllZCAoaW4gdGhpcyBjYXNlLCBncHQtNG8pIHdoaWNoIGdlbmVyYXRlcyBhIHJlc3BvbnNlLgojQyBPcGVuQUkgaGFzIGEgc3BlY2lmaWMgZm9ybWF0IGl0IGV4cGVjdHMgdG8gcmVjZWl2ZSBtZXNzYWdlcyBpbi4gIFlvdSBtdXN0IHNwZWNpZnkgYm90aCB0aGUgcm9sZSBvZiB0aGUgc3BlYWtlciBhbmQgdGhlIGNvbnRlbnQgZm9yIGVhY2ggbWVzc2FnZS4KI0QgVGhlIGZ1bmN0aW9uIHJldHVybnMgdGhlIGNvbnRlbnQgb2YgdGhlIHJlc3BvbnNlLCBzdHJpcHBlZCBvZiBhbnkgbGVhZGluZyBvciB0cmFpbGluZyB3aGl0ZXNwYWNlLg==" data-annotations-created="true"><div class="annotation-container" data-annotation-label="A" style="top:17px; height:16px; line-height:16px" data-start-line-index="1" data-end-line-index="1" title="You will need to get an API key from OpenAI by signing up for an account.">
                                              <span class="annotation-label" id="A">A</span>
                                          </div><div class="annotation-container" data-annotation-label="B" style="top:51px; height:16px; line-height:16px" data-start-line-index="3" data-end-line-index="3" title="ChatCompletion.create sends the message to the model specified (in this case, gpt-4o) which generates a response.">
                                              <span class="annotation-label" id="B">B</span>
                                          </div><div class="annotation-container" data-annotation-label="C" style="top:68px; height:16px; line-height:16px" data-start-line-index="4" data-end-line-index="4" title="OpenAI has a specific format it expects to receive messages in.  You must specify both the role of the speaker and the content for each message.">
                                              <span class="annotation-label" id="C">C</span>
                                          </div><div class="annotation-container" data-annotation-label="D" style="top:102px; height:16px; line-height:16px" data-start-line-index="6" data-end-line-index="6" title="The function returns the content of the response, stripped of any leading or trailing whitespace.">
                                              <span class="annotation-label" id="D">D</span>
                                          </div></div> 
  </div> 
  <div class="listing-environment-container">
  <div class="listing-environment-toolbar">
  <span class="listing-environment-runnable-script-container">
  
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
  </span>
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
  </span>
  </span></div>
  </div></div> 
  <div class="readable-text " refid="94" id="94" data-hash="e389df6fe6a4ec5ff5a6a9599f363db0"> 
  <p>Still in run_evals.py, you’ll write another function that compares the expected answer with whatever answer the LLM generates. This function will ask the LLM to decide if the generated answer matches the expected one. If they match, the LLM returns “PASS.” If they don’t, it returns “FAIL.” As your Retrieval-Augmented Generation (RAG) system evolves, you can add more instructions to the prompt to accommodate stricter requirements, such as making sure dates and numbers match exactly or requesting explanations if the answer fails.</p> 
  </div> 
  <div class="browsable-container listing-container" refid="95" id="95" data-hash="f1fd0bebeaacf0ce35422579b798de7b" data-annotation-type="letters"> 
  <h5>Listing 2.3 Function comparing one expected to one generated answer</h5> 
  <div class="code-area-container"> 
  <pre class="code-area" data-code-area-highlighted="true"><div class="line-container listing-line-group groupA" style="top: 34px; height:16px; line-height:16px;" data-code="ICBnZW5lcmF0ZWRfYW5zd2VyKTo="></div><div class="line-container listing-line-group groupB" style="top: 119px; height:16px; line-height:16px;" data-code=""></div><div class="line-container listing-line-group groupC" style="top: 136px; height:16px; line-height:16px;" data-code="ICAgIHJlc3BvbnNlID0gc2VuZF90b19vcGVuYWkocHJvbXB0KQ=="></div><div class="line-container listing-line-group groupD" style="top: 153px; height:16px; line-height:16px;" data-code="ICAgIHJldHVybiByZXNwb25zZQ=="></div><code class="hljs hljs-line-numbers" style="float:left"><div class="line-number line-number-1">1</div><div class="line-number line-number-2">2</div><div class="line-number line-number-3">3</div><div class="line-number line-number-4">4</div><div class="line-number line-number-5">5</div><div class="line-number line-number-6">6</div><div class="line-number line-number-7">7</div><div class="line-number line-number-8">8</div><div class="line-number line-number-9">9</div><div class="line-number line-number-10">10</div></code><code class="hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">evaluate_generated_answer</span><span class="hljs-params">(
  expected_answer, 
  generated_answer)</span>:</span>
  prompt = <span class="hljs-string">f"""Please evaluate the generated answer. 
  ➥If the generated answer provides the same information
  ➥ as the expected answer, then return PASS. Otherwise, 
  ➥return FAIL. Expected answer: <span class="hljs-subst">{expected_answer}</span> 
  ➥Generated answer: <span class="hljs-subst">{generated_answer}</span>"""</span>
  response = send_to_openai(prompt)
  <span class="hljs-keyword">return</span> response</code></pre> 
  <div class="code-annotations-overlay-container" data-annotations="I0EgVGFrZSBhcyBpbnB1dCBvbmUgZXhwZWN0ZWQgYW5zd2VyIGFuZCBvbmUgZ2VuZXJhdGVkIGFuc3dlcgojQiBDb25zdHJ1Y3QgYSBwcm9tcHQgYXNraW5nIHRoZSBMTE0gdG8gY29tcGFyZSB0aGUgdHdvCiNDIFNlbmQgdGhlIGNvbnN0cnVjdGVkIHByb21wdCB0byBPcGVuQUkgCiNEIFJldHVybiB0aGUgcmVzdWx0" data-annotations-created="true"><div class="annotation-container" data-annotation-label="A" style="top:34px; height:16px; line-height:16px" data-start-line-index="2" data-end-line-index="2" title="Take as input one expected answer and one generated answer">
                                              <span class="annotation-label" id="A">A</span>
                                          </div><div class="annotation-container" data-annotation-label="B" style="top:119px; height:16px; line-height:16px" data-start-line-index="7" data-end-line-index="7" title="Construct a prompt asking the LLM to compare the two">
                                              <span class="annotation-label" id="B">B</span>
                                          </div><div class="annotation-container" data-annotation-label="C" style="top:136px; height:16px; line-height:16px" data-start-line-index="8" data-end-line-index="8" title="Send the constructed prompt to OpenAI">
                                              <span class="annotation-label" id="C">C</span>
                                          </div><div class="annotation-container" data-annotation-label="D" style="top:153px; height:16px; line-height:16px" data-start-line-index="9" data-end-line-index="9" title="Return the result">
                                              <span class="annotation-label" id="D">D</span>
                                          </div></div> 
  </div> 
  <div class="listing-environment-container">
  <div class="listing-environment-toolbar">
  <span class="listing-environment-runnable-script-container">
  
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
  </span>
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
  </span>
  </span></div>
  </div></div> 
  <div class="readable-text " refid="96" id="96" data-hash="9b27bf6a1ec0b46d096c8b0a2b4e5e93"> 
  <p>Next, you’ll create a file named test_automated_evals.py. This file will loop through each evaluation question, send it to the chatbot, and check the response. You’ll also set up a GitHub Action so that, whenever your repository updates, the test runs automatically via pytest. In practice, the system will capture real answers from your RAG API, but for now, you can use dummy answers to ensure everything runs as expected.</p> 
  </div> 
  <div class="browsable-container listing-container" refid="97" id="97" data-hash="dae6f2b117cc596a39f049f559bc1f8b" data-annotation-type="letters"> 
  <h5>Listing 2.4 Comparing all expected to all generated answers as a test case</h5> 
  <div class="code-area-container"> 
  <pre class="code-area" data-code-area-highlighted="true"><div class="line-container listing-line-group groupA" style="top: 0px; height:16px; line-height:16px;" data-code="ZnJvbSBydW5fZXZhbHMgaW1wb3J0IGV2YWx1YXRlX2dlbmVyYXRlZF9hbnN3ZXI="></div><div class="line-container listing-line-group groupB" style="top: 34px; height:16px; line-height:16px;" data-code="ZGVmIHJ1bl9SQUcodXNlcl9xdWVzdGlvbik6"></div><div class="line-container listing-line-group groupC" style="top: 85px; height:16px; line-height:16px;" data-code="ZGVmIHRlc3RfcnVuX1JBRygpOg=="></div><div class="line-container listing-line-group groupD" style="top: 425px; height:16px; line-height:16px;" data-code="ICAgIGdlbmVyYXRlZF9hbnN3ZXJzLmFwcGVuZChhbnN3ZXIp"></div><div class="line-container listing-line-group groupE" style="top: 459px; height:16px; line-height:16px;" data-code="ICBmb3IgaSBpbiByYW5nZShsZW4oZXZhbF9xdWVzdGlvbnMpKTo="></div><div class="line-container listing-line-group groupF" style="top: 510px; height:16px; line-height:16px;" data-code="ICAgIGFzc2VydCAiUEFTUyIgaW4gcmVzdWx0"></div><code class="hljs hljs-line-numbers" style="float:left"><div class="line-number line-number-1">1</div><div class="line-number line-number-2">2</div><div class="line-number line-number-3">3</div><div class="line-number line-number-4">4</div><div class="line-number line-number-5">5</div><div class="line-number line-number-6">6</div><div class="line-number line-number-7">7</div><div class="line-number line-number-8">8</div><div class="line-number line-number-9">9</div><div class="line-number line-number-10">10</div><div class="line-number line-number-11">11</div><div class="line-number line-number-12">12</div><div class="line-number line-number-13">13</div><div class="line-number line-number-14">14</div><div class="line-number line-number-15">15</div><div class="line-number line-number-16">16</div><div class="line-number line-number-17">17</div><div class="line-number line-number-18">18</div><div class="line-number line-number-19">19</div><div class="line-number line-number-20">20</div><div class="line-number line-number-21">21</div><div class="line-number line-number-22">22</div><div class="line-number line-number-23">23</div><div class="line-number line-number-24">24</div><div class="line-number line-number-25">25</div><div class="line-number line-number-26">26</div><div class="line-number line-number-27">27</div><div class="line-number line-number-28">28</div><div class="line-number line-number-29">29</div><div class="line-number line-number-30">30</div><div class="line-number line-number-31">31</div></code><code class="hljs">from run_evals import evaluate_generated_answer
  
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run_RAG</span><span class="hljs-params">(user_question)</span></span>:
  <span class="hljs-keyword">return</span> <span class="hljs-string">"IDKLOL"</span>
  
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_run_RAG</span><span class="hljs-params">()</span></span>:
  
  eval_questions = [
  <span class="hljs-string">"What is Underwhelming Spatula?"</span>,
  <span class="hljs-string">"Who wrote 'Dubious Parenting Tips'?"</span>,
  <span class="hljs-string">"How long is Almost-Perfect Investment Guide?"</span>,
  ]
  
  eval_answers = [
  <span class="hljs-string">"Underwhelming Spatula is a kitchen tool that 
  ➥redefines expectations by fusing whimsy with 
  ➥functionality."</span>,
  <span class="hljs-string">"Lisa Melton wrote Dubious Parenting Tips."</span>,
  <span class="hljs-string">"The Almost-Perfect Investment guide is 210 pages
  ➥ long."</span>,
  ]
  
  generated_answers = []
  <span class="hljs-keyword">for</span> question <span class="hljs-keyword">in</span> <span class="hljs-symbol">eval_questions:</span>
  answer = run_RAG(question)
  generated_answers.append(answer)
  
  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(eval_questions)):
  result = evaluate_generated_answer(eval_answers[i],
  generated_answers[i])
  assert <span class="hljs-string">"PASS"</span> <span class="hljs-keyword">in</span> result</code></pre> 
  <div class="code-annotations-overlay-container" data-annotations="I0EgSW1wb3J0IHRoZSBldmFsdWF0aW9uIGZ1bmN0aW9uIHdlIGRlZmluZWQgZWFybGllcgojQiBXZSBoYXZlbuKAmXQgd3JpdHRlbiBvdXIgUkFHIGZ1bmN0aW9uIHlldCwgc28gd2Ugd2lsbCBqdXN0IHJldHVybiBzb21lIGR1bW15IHRleHQuCiNDIFRoaXMgZnVuY3Rpb24gd2lsbCBydW4gZXZlcnkgdGltZSBweXRlc3QgaXMgY2FsbGVkLCBiZWNhdXNlIGl0IHN0YXJ0cyB3aXRoIOKAnF90ZXN04oCdLgojRCBGb3IgZXZlcnkgcXVlc3Rpb24gaW4gb3VyIGV2YWxzIGxpc3QsIHdlIHJ1biB0aGF0IHF1ZXN0aW9uIHRocm91Z2ggb3VyIGZha2UgUkFHIGZ1bmN0aW9uLCBhbmQgYWRkIHRoZSBhbnN3ZXIgdG8gYSBsaXN0LgojRSBMaWtld2lzZSwgd2UgbG9vcCB0aHJvdWdoIGFsbCB0aGUgZ2VuZXJhdGVkIGFuc3dlcnMgYW5kIG1ha2Ugc3VyZSB0aGV5IG1hdGNoIHRoZSBhbnN3ZXJzIHdlIGFyZSBleHBlY3RpbmcuIAojRiBJZiB0aGUgd29yZCDigJxQYXNz4oCdIGlzIGluIGV2ZXJ5IHJlc3VsdCwgd2Uga25vdyB0aGF0IG91ciBSQUcgaXMgd29ya2luZyBjb3JyZWN0bHkuICBJZiBub3QsIG91ciB0ZXN0IHdpbGwgcmFpc2UgYW4gZXJyb3Iu" data-annotations-created="true"><div class="annotation-container" data-annotation-label="A" style="top:0px; height:16px; line-height:16px" data-start-line-index="0" data-end-line-index="0" title="Import the evaluation function we defined earlier">
                                              <span class="annotation-label" id="A">A</span>
                                          </div><div class="annotation-container" data-annotation-label="B" style="top:34px; height:16px; line-height:16px" data-start-line-index="2" data-end-line-index="2" title="We haven’t written our RAG function yet, so we will just return some dummy text.">
                                              <span class="annotation-label" id="B">B</span>
                                          </div><div class="annotation-container" data-annotation-label="C" style="top:85px; height:16px; line-height:16px" data-start-line-index="5" data-end-line-index="5" title="This function will run every time pytest is called, because it starts with “_test”.">
                                              <span class="annotation-label" id="C">C</span>
                                          </div><div class="annotation-container" data-annotation-label="D" style="top:425px; height:16px; line-height:16px" data-start-line-index="25" data-end-line-index="25" title="For every question in our evals list, we run that question through our fake RAG function, and add the answer to a list.">
                                              <span class="annotation-label" id="D">D</span>
                                          </div><div class="annotation-container" data-annotation-label="E" style="top:459px; height:16px; line-height:16px" data-start-line-index="27" data-end-line-index="27" title="Likewise, we loop through all the generated answers and make sure they match the answers we are expecting.">
                                              <span class="annotation-label" id="E">E</span>
                                          </div><div class="annotation-container" data-annotation-label="F" style="top:510px; height:16px; line-height:16px" data-start-line-index="30" data-end-line-index="30" title="If the word “Pass” is in every result, we know that our RAG is working correctly.  If not, our test will raise an error.">
                                              <span class="annotation-label" id="F">F</span>
                                          </div></div> 
  </div> 
  <div class="listing-environment-container">
  <div class="listing-environment-toolbar">
  <span class="listing-environment-runnable-script-container">
  
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
  </span>
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
  </span>
  </span></div>
  </div></div> 
  <div class="readable-text " refid="98" id="98" data-hash="7681cb77770583193fac0863fb02d827"> 
  <p>To manage dependencies, create a requirements.txt file in your main directory. Include openai==1.60.2, dotenv, and pytest. Pinning a specific OpenAI version ensures stability if the package changes. The file’s contents should look like this:</p> 
  </div> 
  <div class="browsable-container listing-container no-annotations" refid="99" id="99" data-hash="97fc84609730e2705f780c478d404555"> 
  <div class="code-area-container"> 
  <pre class="code-area" data-code-area-highlighted="true"><code class="hljs hljs-line-numbers" style="float:left"><div class="line-number line-number-1">1</div><div class="line-number line-number-2">2</div><div class="line-number line-number-3">3</div><div class="line-number line-number-4">4</div></code><code class="hljs">openai==1.60.2
  dotenv
  pytest
  </code></pre> 
  <div class="code-annotations-overlay-container" data-annotations-created="true"></div> 
  </div> 
  <div class="listing-environment-container">
  <div class="listing-environment-toolbar">
  <span class="listing-environment-runnable-script-container">
  
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
  </span>
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
  </span>
  </span></div>
  </div></div> 
  <div class="readable-text " refid="100" id="100" data-hash="e68bc2b69f6842ea8621e0f0e0d75e03"> 
  <p>You’ll also create two new folders: one named .github and, inside it, another named workflows. In the workflows folder, create a test.yml file. Fill it with the configuration that tells GitHub Actions when to run (every time you push code on main), which operating system to use (Ubuntu), how to set up Python 3.11, how to install dependencies, and finally how to run your tests. Notice the commented annotations (#A, #B, etc.) explain each step in plain language, like running on Ubuntu (#B) or installing your requirements (#E):</p> 
  </div> 
  <div class="browsable-container listing-container" refid="101" id="101" data-hash="9d2c76e4b73e92e887c635f43a9d8dc4" data-annotation-type="letters"> 
  <h5>Listing 2.5</h5> 
  <div class="code-area-container"> 
  <pre class="code-area" data-code-area-highlighted="true"><div class="line-container listing-line-group groupA" style="top: 85px; height:16px; line-height:16px;" data-code="ICAgICAgLSBtYWlu"></div><div class="line-container listing-line-group groupB" style="top: 153px; height:16px; line-height:16px;" data-code="ICAgIHJ1bnMtb246IHVidW50dS1sYXRlc3Q="></div><div class="line-container listing-line-group groupC" style="top: 221px; height:16px; line-height:16px;" data-code="ICAgICAgICB1c2VzOiBhY3Rpb25zL2NoZWNrb3V0QHYz"></div><div class="line-container listing-line-group groupD" style="top: 306px; height:16px; line-height:16px;" data-code="ICAgICAgICAgIHB5dGhvbi12ZXJzaW9uOiAzLjEx"></div><div class="line-container listing-line-group groupE" style="top: 391px; height:16px; line-height:16px;" data-code="ICAgICAgICAgIHB5dGhvbiAtbSBwaXAgaW5zdGFsbCAtciByZXF1aXJlbWVudHMudHh0"></div><div class="line-container listing-line-group groupF" style="top: 493px; height:16px; line-height:16px;" data-code="ICAgICAgICAgIHB5dGhvbiAtbSBweXRlc3QgLXM="></div><code class="hljs hljs-line-numbers" style="float:left"><div class="line-number line-number-1">1</div><div class="line-number line-number-2">2</div><div class="line-number line-number-3">3</div><div class="line-number line-number-4">4</div><div class="line-number line-number-5">5</div><div class="line-number line-number-6">6</div><div class="line-number line-number-7">7</div><div class="line-number line-number-8">8</div><div class="line-number line-number-9">9</div><div class="line-number line-number-10">10</div><div class="line-number line-number-11">11</div><div class="line-number line-number-12">12</div><div class="line-number line-number-13">13</div><div class="line-number line-number-14">14</div><div class="line-number line-number-15">15</div><div class="line-number line-number-16">16</div><div class="line-number line-number-17">17</div><div class="line-number line-number-18">18</div><div class="line-number line-number-19">19</div><div class="line-number line-number-20">20</div><div class="line-number line-number-21">21</div><div class="line-number line-number-22">22</div><div class="line-number line-number-23">23</div><div class="line-number line-number-24">24</div><div class="line-number line-number-25">25</div><div class="line-number line-number-26">26</div><div class="line-number line-number-27">27</div><div class="line-number line-number-28">28</div><div class="line-number line-number-29">29</div><div class="line-number line-number-30">30</div></code><code class="hljs"><span class="hljs-attr">name</span>: <span class="hljs-string">Automatic Testing</span>
  
  <span class="hljs-attr">on</span>:<span class="hljs-string"></span>
  <span class="hljs-attr">push</span>:<span class="hljs-string"></span>
  <span class="hljs-attr">branches</span>:<span class="hljs-string"></span>
  <span class="hljs-meta">-</span> <span class="hljs-string">main</span>
  
  <span class="hljs-attr">jobs</span>:<span class="hljs-string"></span>
  <span class="hljs-attr">test</span>:<span class="hljs-string"></span>
  <span class="hljs-meta">runs-on</span>: <span class="hljs-string">ubuntu-latest</span>
  
  <span class="hljs-attr">steps</span>:<span class="hljs-string"></span>
  <span class="hljs-meta">-</span> <span class="hljs-string">name: Check out code</span>
  <span class="hljs-attr">uses</span>: <span class="hljs-string">actions/checkout@v3</span>
  
  <span class="hljs-meta">-</span> <span class="hljs-string">name: Set up Python</span>
  <span class="hljs-attr">uses</span>: <span class="hljs-string">actions/setup-python@v4</span>
  <span class="hljs-attr">with</span>:<span class="hljs-string"></span>
    <span class="hljs-meta">python-version</span>: <span class="hljs-string">3.11</span>
  
  <span class="hljs-meta">-</span> <span class="hljs-string">name: Install dependencies</span>
  <span class="hljs-attr">run</span>: <span class="hljs-string">|</span>
    <span class="hljs-attr">python</span> <span class="hljs-string">-m pip install --upgrade pip</span>
    <span class="hljs-attr">python</span> <span class="hljs-string">-m pip install -r requirements.txt</span>
  
  <span class="hljs-meta">-</span> <span class="hljs-string">name: Run tests</span>
  <span class="hljs-attr">env</span>:<span class="hljs-string"></span>
    <span class="hljs-attr">OPENAI_API_KEY</span>: <span class="hljs-string">${{ secrets.OPENAI_API_KEY }}</span>
  <span class="hljs-attr">run</span>: <span class="hljs-string">|</span>
    <span class="hljs-attr">python</span> <span class="hljs-string">-m pytest -s</span></code></pre> 
  <div class="code-annotations-overlay-container" data-annotations="I0EgRXZlcnkgdGltZSB5b3UgcHVzaCBjb2RlLCB0aGlzIGFjdGlvbiBleGVjdXRlcyBvbiB5b3VyIOKAnG1haW7igJ0gYnJhbmNoLgojQiBSdW4geW91ciBjb2RlIG9uIHRoZSBVYnVudHUgb3BlcmF0aW5nIHN5c3RlbS4KI0MgQ2hlY2sgb3V0IHlvdXIgY29kZSBhbmQgaW5zdGFsbCBpdCBvbiBhIHRlc3Qgc2VydmVyIHByb3ZpZGVkIGJ5IEdpdGh1Yi4KI0QgTWFrZSBzdXJlIHdlIGFyZSB1c2luZyBQeXRob24gMy4xMS4KI0UgSW5zdGFsbCB0aGUgbmV3ZXN0IHZlcnNpb24gb2YgUGlwLCBhcyB3ZWxsIGFzIHdoYXRldmVyIHJlcXVpcmVtZW50cyB5b3UgbGlzdGVkIGluIHlvdXIgcmVxdWlyZW1lbnRzLnR4dCBmaWxlLgojRiBSdW4gdGhlIHRlc3RzIHdlIHdyb3RlIGVhcmxpZXIgaW4gdGVzdF9hdXRvbWF0ZWRfZXZhbHMucHku" data-annotations-created="true"><div class="annotation-container" data-annotation-label="A" style="top:85px; height:16px; line-height:16px" data-start-line-index="5" data-end-line-index="5" title="Every time you push code, this action executes on your “main” branch.">
                                              <span class="annotation-label" id="A">A</span>
                                          </div><div class="annotation-container" data-annotation-label="B" style="top:153px; height:16px; line-height:16px" data-start-line-index="9" data-end-line-index="9" title="Run your code on the Ubuntu operating system.">
                                              <span class="annotation-label" id="B">B</span>
                                          </div><div class="annotation-container" data-annotation-label="C" style="top:221px; height:16px; line-height:16px" data-start-line-index="13" data-end-line-index="13" title="Check out your code and install it on a test server provided by Github.">
                                              <span class="annotation-label" id="C">C</span>
                                          </div><div class="annotation-container" data-annotation-label="D" style="top:306px; height:16px; line-height:16px" data-start-line-index="18" data-end-line-index="18" title="Make sure we are using Python 3.11.">
                                              <span class="annotation-label" id="D">D</span>
                                          </div><div class="annotation-container" data-annotation-label="E" style="top:391px; height:16px; line-height:16px" data-start-line-index="23" data-end-line-index="23" title="Install the newest version of Pip, as well as whatever requirements you listed in your requirements.txt file.">
                                              <span class="annotation-label" id="E">E</span>
                                          </div><div class="annotation-container" data-annotation-label="F" style="top:493px; height:16px; line-height:16px" data-start-line-index="29" data-end-line-index="29" title="Run the tests we wrote earlier in test_automated_evals.py.">
                                              <span class="annotation-label" id="F">F</span>
                                          </div></div> 
  </div> 
  <div class="listing-environment-container">
  <div class="listing-environment-toolbar">
  <span class="listing-environment-runnable-script-container">
  
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
  </span>
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
  </span>
  </span></div>
  </div></div> 
  <div class="readable-text " refid="102" id="102" data-hash="f3c24bfef8dbb943364baf3b9c2c31ea"> 
  <p>Once you have everything set up locally, head to GitHub.com, create a repository named RagForEnterprise, and go into its settings. Under “Secrets and Variables” à “Actions”, add your OpenAI API key as a secret named OPENAI_API_KEY. Connect this new remote repository to your local project (there are many tutorials online if you need help with Git), then commit and push your changes. Back on GitHub, you should see your code in the RagForEnterprise repo along with a record of the tests running. You’ll probably get a failing test, which is exactly what you want at this stage—just like in Test Driven Development, you start by defining failing evals, then build your RAG system until they pass.</p> 
  </div> 
  <div class="browsable-container listing-container no-annotations" refid="103" id="103" data-hash="2505b708920bcbf86cdd08abf4b8fbcc"> 
  <div class="code-area-container"> 
  <pre class="code-area" data-code-area-highlighted="true"><code class="hljs hljs-line-numbers" style="float:left"><div class="line-number line-number-1">1</div><div class="line-number line-number-2">2</div></code><code class="hljs"><span class="hljs-attribute">python</span> -m pip install pytest 
  </code></pre> 
  <div class="code-annotations-overlay-container" data-annotations-created="true"></div> 
  </div> 
  <div class="listing-environment-container">
  <div class="listing-environment-toolbar">
  <span class="listing-environment-runnable-script-container">
  
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
  </span>
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
  </span>
  </span></div>
  </div></div> 
  <div class="browsable-container listing-container no-annotations" refid="104" id="104" data-hash="134d6c3b33369c5f71f8020fd90711dc"> 
  <div class="code-area-container"> 
  <pre class="code-area" data-code-area-highlighted="true"><code class="hljs hljs-line-numbers" style="float:left"><div class="line-number line-number-1">1</div><div class="line-number line-number-2">2</div></code><code class="hljs"><span class="hljs-selector-tag">python</span> <span class="hljs-selector-tag">-m</span> <span class="hljs-selector-tag">pytest</span> <span class="hljs-selector-tag">test_automated_evals</span><span class="hljs-selector-class">.py</span>. 
  </code></pre> 
  <div class="code-annotations-overlay-container" data-annotations-created="true"></div> 
  </div> 
  <div class="listing-environment-container">
  <div class="listing-environment-toolbar">
  <span class="listing-environment-runnable-script-container">
  
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
  </span>
  <span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
  </span>
  </span></div>
  </div></div> 
  <div class="readable-text " refid="105" id="105" data-hash="c9017403aa674065537f721dd5e4ad07"> 
  <p>Automating your evals in this way acts like a continuous quality assurance partner for your RAG chatbot. Each time you update your code or adjust a prompt, these tests help maintain reliability and effectiveness. By folding automated evals into your workflow, you’re proactively refining your chatbot’s performance while keeping an eye out for any regressions or bugs.</p> 
  </div> 
  <div class="readable-text" refid="106" id="106" data-hash="9893f7f07db113ceb01b573f73941b32"> 
  <h2>2.5 Summary</h2> 
  </div> 
  <ul> 
  <li class="readable-text" refid="107" id="107" data-hash="2aecd7314a960474b1011392e7b40358">Evals are essential for RAG Development. Evals serve as test cases that transform broad objectives into specific, measurable goals, guiding the development of your Retrieval Augmented Generation (RAG) chatbot.</li> 
  <li class="readable-text" refid="108" id="108" data-hash="b6a78c027b938cd8081c0d729450d2d2">Obtain Evals Before Coding. Getting evals from stakeholders before writing any code is crucial to avoid hidden assumptions, ensure alignment with expectations, and protect the project from misaligned outcomes.</li> 
  <li class="readable-text" refid="109" id="109" data-hash="6af54a897b3d5e025c525537c25b19e4">Utilize a step-by-step approach by starting with simple question-answer pairs, identifying required data, building agents and search functions, providing clear instructions, testing responses, troubleshooting issues, and iterating.</li> 
  <li class="readable-text" refid="110" id="110" data-hash="4cf4b8a2dca4512ecc8ec2fd3c03ee1c">Integrate evals into your deployment pipeline to automate testing, use Large Language Models (LLMs) for response comparison, and cover all data sources to ensure comprehensive and efficient evaluation.</li> 
  <li class="readable-text" refid="111" id="111" data-hash="8169acc8c9cc72cb51b69e3d16fee63e">Evals enhance communication between developers and stakeholders, enable continuous improvement, and are critical for developing, testing, and maintaining a reliable RAG chatbot that meets organizational needs and adds substantial value.</li> 
  </ul></div>
          <div id="right-margin-column"></div>
          <div id="right-margin-menu-column"></div>
      </div>
    </div>

    <div class="large-12 columns">
      <div id="book-main-content-container" style="transform: translateX(0px);">
          <div id="track-point-column" class="hidden">
              <div class="track-point-wrapper" id="pointing-start-point">
                  <i class="fal fa-level-down fa-flip-horizontal" aria-hidden="true"></i>
              </div>
              <div class="track-point-wrapper" id="pointing-end-point">
                  <i class="fal fa-level-up fa-flip-horizontal" aria-hidden="true"></i>
              </div>
              <div class="track-point-wrapper" id="play-point">
                  <div class="track-point">
                      <i class="icon-i-play-triangle"></i>
                  </div>
              </div>
              <div class="track-point-wrapper" id="current-position-point">
                  <div class="track-point">
                      <div class="track-point-play">
                          <i></i>
                      </div>
                  </div>
              </div>
              <div class="track-point-wrapper" id="off-screen-position-point">
                  <div class="track-point">
                      <div class="off-screen-position-point-arrow-container">
                          <i class=""></i>
                      </div>
                  </div>
              </div>
              <div class="track-point-wrapper" id="restart-paragraph-point">
                  <div class="track-point">
                      <i class="fa fa-redo"></i>
                  </div>
              </div>
          </div>
          <div id="book-markup-container"><div class="readable-text " refid="1" id="1" data-hash="923c9806e071f78b7a07295ace260b8c"> 
<h1><span class="chapter-title-numbering"><span class="num-string">3</span></span> Ingestion 1: Building a search from scratch</h1> 

<div class="book-element-head-commands">
  <div class="_left">
      <button class="_head-icon-container _audio-icon" title="play audio">
          <i class="fa fa-play"></i>
      </button>
      <button class="_head-icon-container _generate-audio-icon _edit-audio-icon" title="generate audio">
          <i class="fa fa-microphone"></i>
          <i class="fa fa-cog"></i>
      </button>
      <button class="_head-icon-container _join-audio-icon _edit-audio-icon" title="join audio">
          <i class="fa fa-microphone"></i>
          <i class="fa fa-plus"></i>
      </button>
      <button class="_head-icon-container _create-timeline-icon _edit-audio-icon" title="create timeline">
          <i class="fa fa-stream"></i>
      </button>
      <button class="_head-icon-container _generate-subtitles-icon _edit-audio-icon" title="generate subtitles">
          <i class="fa fa-closed-captioning"></i>
          <i class="fa fa-cog"></i>
      </button>
      <button class="_head-icon-container _discussions-icon" title="discussions"><div class="_label">1</div>
          <svg width="25" height="23" viewBox="0 0 25 23" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M0.443717 21.8455C0.536061 21.8944 0.636353 21.9481 0.832775 21.9481C1.45724 21.9473 3.05396 21.4122 8.43833 18.5071C8.75926 18.5794 8.93676 18.6335 9.18087 18.7088L9.54306 18.8182C9.95217 18.9363 10.3753 18.7051 10.4953 18.3009C10.6141 17.8982 10.3813 17.4743 9.97601 17.3555L9.63351 17.2529C9.30992 17.1541 9.0556 17.0754 8.47466 16.9581C8.29678 16.921 8.11361 16.949 7.95465 17.0349C6.09717 18.0397 3.99065 19.1123 2.54153 19.7776C2.76103 19.4949 2.98508 19.2114 3.17696 18.9681C4.83273 16.8703 5.21157 16.3242 5.1355 15.7746C5.10749 15.571 4.96973 15.336 4.80321 15.2138C2.72016 13.6954 1.57229 11.6608 1.57229 9.48537C1.57229 5.09522 6.30116 1.52368 12.1136 1.52368C17.926 1.52368 22.6548 5.09522 22.6548 9.48499C22.6548 9.90622 22.9985 10.2472 23.4208 10.2472C23.844 10.2472 24.1876 9.9066 24.1876 9.48499C24.1876 4.25542 18.7707 0 12.1128 0C5.45492 0 0.0391419 4.25542 0.0391419 9.48499C0.0391419 11.9514 1.27028 14.3304 3.43848 16.0903C3.10846 16.5861 2.4454 17.4251 1.97005 18.0276C0.257892 20.1977 -0.0993748 20.7166 0.0213542 21.2831C0.0679049 21.5034 0.244646 21.7392 0.443717 21.8455Z" fill="currentColor"></path>
              <path d="M24.1695 15.4458C24.1695 12.6649 21.336 10.4028 17.853 10.4028C14.3704 10.4028 11.5369 12.6653 11.5369 15.4458C11.5369 18.1473 14.2096 20.3594 17.5555 20.4843C18.1982 21.0164 20.0931 22.3524 23.3244 22.7619C23.3566 22.7656 23.3922 22.7679 23.4243 22.7679C23.6998 22.7679 23.9682 22.6146 24.1044 22.3773C24.3728 21.9137 24.2074 21.6348 23.2957 20.0869C23.0792 19.719 22.7616 19.1786 22.5648 18.8119C23.5916 17.893 24.1695 16.6921 24.1695 15.4458ZM21.2111 17.944C20.5439 18.4292 20.8746 18.9916 21.9722 20.8555C21.9949 20.8942 22.0168 20.9316 22.0414 20.971C19.6091 20.3522 18.4082 19.2021 18.3965 19.1911C18.2527 19.0476 18.0566 18.9663 17.853 18.9663C15.2159 18.9663 13.0704 17.387 13.0704 15.4458C13.0704 13.5051 15.2159 11.9261 17.853 11.9261C20.4905 11.9261 22.6368 13.5051 22.6368 15.4458C22.6364 16.3867 22.1292 17.2746 21.2111 17.944Z" fill="currentColor"></path>
          </svg>
      </button>
      
      <button class="_head-icon-container _share-icon" title="share">
          <svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M4.22095 12V20C4.22095 20.5304 4.43166 21.0391 4.80673 21.4142C5.18181 21.7893 5.69051 22 6.22095 22H18.2209C18.7514 22 19.2601 21.7893 19.6352 21.4142C20.0102 21.0391 20.2209 20.5304 20.2209 20V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M16.2209 6L12.2209 2L8.22095 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M12.2209 2V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
      </button>
      
      <button class="_head-icon-container _livecards-icon hidden" title="livecards deck start">
          <svg class="add-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21.25 15.38C21.25 15.38 21.22 15.4 21.21 15.4C21.23 15.4 21.24 15.38 21.25 15.38Z" fill="white"></path>
              <path d="M22.05 5.45001L22.41 7.65001L22.05 5.45001C21.79 3.87001 20.36 2.79001 18.79 2.92001C20.36 2.80001 21.79 3.88001 22.05 5.45001V5.45001Z" fill="white"></path>
              <path d="M4.91 18.06C4.86 18.06 4.81 18.06 4.75 18.05C4.8 18.05 4.85 18.06 4.91 18.06Z" fill="white"></path>
              <path d="M2.17001 16.17C2.17001 16.17 2.15001 16.13 2.14001 16.1C2.14001 16.12 2.16001 16.14 2.17001 16.17Z" fill="white"></path>
              <path d="M4.36001 18C4.31001 17.99 4.25001 17.98 4.20001 17.96C4.25001 17.97 4.31001 17.99 4.36001 18Z" fill="white"></path>
              <path d="M3.79999 17.82C3.79999 17.82 3.71999 17.79 3.67999 17.77C3.71999 17.79 3.75999 17.8 3.79999 17.82Z" fill="white"></path>
              <path d="M18.97 17.85C18.82 19.06 17.8 20 16.56 20C16.56 20 6.1 20 5.8 20C5.5 20 5.27 20 5 20C4.65 20 4.29 20.02 3.96 19.95H3.95C3.27 19.8 2.62 19.53 2.05 19.12C0.94 18.33 0.22 17.16 0 15.83V17.56C0 20.01 1.99 22 4.44 22H16.56C19.01 22 21 20.01 21 17.56V17.52C21 17.52 20.95 17.53 20.93 17.54L18.97 17.86V17.85Z" fill="currentColor"></path>
              <path d="M4.56001 5.20999L3.42001 5.39999C3.42001 5.39999 3.40001 5.39999 3.39001 5.39999C3.40001 5.39999 3.41001 5.39999 3.42001 5.39999L4.56001 5.20999Z" fill="currentColor"></path>
              <path d="M0.940002 7.7C0.940002 7.7 0.960002 7.65 0.960002 7.63C0.960002 7.65 0.940002 7.68 0.940002 7.7Z" fill="currentColor"></path>
              <path d="M1.14001 7.13999C1.14001 7.13999 1.15001 7.11999 1.16001 7.10999C1.16001 7.11999 1.15001 7.12999 1.14001 7.13999Z" fill="currentColor"></path>
              <path d="M0.859985 8.29001C0.859985 8.29001 0.869985 8.21001 0.879985 8.17001C0.879985 8.21001 0.869985 8.25001 0.859985 8.29001Z" fill="currentColor"></path>
              <path d="M1.79001 6.22C1.79001 6.22 1.81001 6.2 1.82001 6.19C1.82001 6.19 1.80001 6.21 1.79001 6.22Z" fill="currentColor"></path>
              <path d="M2.23001 5.87999C2.23001 5.87999 2.27001 5.84999 2.29001 5.82999C2.27001 5.83999 2.25001 5.85999 2.23001 5.87999Z" fill="currentColor"></path>
              <path d="M2.72 5.61C2.72 5.61 2.79 5.57 2.83 5.56C2.79 5.57 2.76 5.6 2.72 5.61Z" fill="currentColor"></path>
              <path d="M1.25 11.06L1.98 15.51C1.98 15.51 1.99 15.54 1.99 15.56C1.99 15.54 1.98 15.53 1.98 15.51L1.25 11.06V11.06Z" fill="currentColor"></path>
              <path d="M18.79 2.91999C18.71 2.91999 18.63 2.91999 18.54 2.93999L4.56001 5.20999L3.42001 5.39999C3.42001 5.39999 3.40001 5.39999 3.39001 5.39999C3.20001 5.42999 3.01001 5.47999 2.83001 5.54999C2.79001 5.55999 2.76001 5.58999 2.72001 5.59999C2.57001 5.65999 2.43001 5.72999 2.29001 5.80999C2.27001 5.81999 2.25001 5.83999 2.23001 5.85999C2.09001 5.95999 1.95001 6.05999 1.82001 6.16999C1.82001 6.16999 1.80001 6.18999 1.79001 6.19999C1.53001 6.44999 1.31001 6.74999 1.15001 7.08999C1.15001 7.09999 1.14001 7.10999 1.13001 7.11999C1.06001 7.27999 1.00001 7.43999 0.960006 7.60999C0.960006 7.62999 0.940006 7.65999 0.940006 7.67999C0.900006 7.83999 0.890006 7.99999 0.870006 8.15999C0.870006 8.19999 0.860006 8.23999 0.850006 8.27999C0.850006 8.47999 0.850006 8.68999 0.890006 8.88999L1.24001 11.05L1.97001 15.5C1.97001 15.5 1.98001 15.53 1.98001 15.55C2.01001 15.74 2.06001 15.92 2.13001 16.09C2.13001 16.11 2.15001 16.13 2.16001 16.16C2.45001 16.87 3.00001 17.44 3.67001 17.76C3.71001 17.78 3.75001 17.79 3.79001 17.81C3.92001 17.86 4.05001 17.91 4.18001 17.95C4.23001 17.96 4.29001 17.98 4.34001 17.99C4.47001 18.02 4.60001 18.04 4.74001 18.05C4.79001 18.05 4.84001 18.06 4.90001 18.06C5.09001 18.06 5.28001 18.06 5.47001 18.02L20.6 15.55C20.81 15.52 21.01 15.46 21.19 15.39C21.21 15.39 21.22 15.37 21.23 15.37C22.34 14.93 23.09 13.87 23.15 12.68C23.15 12.46 23.15 12.26 23.11 12.05L22.39 7.64999L22.03 5.44999C21.77 3.86999 20.34 2.79999 18.77 2.91999H18.79ZM3.95001 15.19L2.87001 8.57999C2.83001 8.29999 2.89001 8.01999 3.05001 7.79999C3.21001 7.56999 3.46001 7.41999 3.73001 7.37999L18.86 4.90999C18.92 4.90999 18.97 4.89999 19.03 4.89999C19.54 4.89999 19.98 5.26999 20.07 5.77999L21.15 12.39C21.24 12.96 20.85 13.5 20.28 13.6L5.15001 16.07C4.87001 16.12 4.59001 16.05 4.37001 15.89C4.14001 15.73 3.99001 15.48 3.95001 15.21V15.19Z" fill="currentColor"></path>
              <path d="M4.49001 9.268L17.34 6.998C17.61 6.948 17.79 6.688 17.75 6.418C17.7 6.148 17.44 5.958 17.17 6.008L4.32001 8.278C4.05001 8.328 3.87001 8.588 3.91001 8.858C3.95001 9.098 4.16001 9.268 4.40001 9.268C4.43001 9.268 4.46001 9.268 4.49001 9.268V9.268Z" fill="currentColor"></path>
              <path d="M13.88 9.478C13.83 9.208 13.58 9.028 13.3 9.068L4.73002 10.528C4.46002 10.578 4.27002 10.828 4.32002 11.108C4.36002 11.348 4.57001 11.528 4.81001 11.528C4.84001 11.528 4.87001 11.528 4.89001 11.528L13.46 10.068C13.73 10.018 13.92 9.768 13.87 9.488L13.88 9.478Z" fill="currentColor"></path>
              <path d="M5.51001 14.158L16.93 12.288C17.2 12.248 17.39 11.988 17.34 11.718C17.3 11.448 17.04 11.258 16.77 11.308L5.35001 13.178C5.08001 13.218 4.89001 13.478 4.94001 13.748C4.98001 13.998 5.19001 14.168 5.43001 14.168C5.46001 14.168 5.48001 14.168 5.51001 14.168V14.158Z" fill="currentColor"></path>
          </svg>
      </button>
      <button class="_head-icon-container _ask-manning-icon hidden" title="ask manning">
          <svg width="29" height="29" viewBox="0 0 29 29" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M0.431152 5.56144C0.431152 2.98412 2.52049 0.894775 5.09782 0.894775H23.7645C26.3418 0.894775 28.4312 2.98412 28.4312 5.56144V24.2281C28.4312 26.8054 26.3418 28.8948 23.7645 28.8948H5.09782C2.52049 28.8948 0.431152 26.8054 0.431152 24.2281V5.56144ZM5.09782 2.76144C3.55142 2.76144 2.29782 4.01504 2.29782 5.56144V24.2281C2.29782 25.7745 3.55142 27.0281 5.09782 27.0281H23.7645C25.3108 27.0281 26.5645 25.7745 26.5645 24.2281V5.56144C26.5645 4.01504 25.3108 2.76144 23.7645 2.76144H5.09782Z" fill="#4087D4"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M11.5346 10.744C11.3765 10.4278 11.0534 10.228 10.6998 10.228C10.3463 10.228 10.0231 10.4278 9.86504 10.744L6.13171 18.2106C5.90117 18.6717 6.08804 19.2323 6.54909 19.4628C7.01014 19.6933 7.57078 19.5065 7.80129 19.0454L8.47667 17.6947H12.923L13.5984 19.0454C13.8289 19.5065 14.3895 19.6933 14.8505 19.4628C15.3116 19.2323 15.4985 18.6717 15.2679 18.2106L11.5346 10.744ZM11.9897 15.828L10.6998 13.2483L9.41 15.828H11.9897Z" fill="#4087D4"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M20.0295 10.228C20.5449 10.228 20.9629 10.6459 20.9629 11.1614V18.628C20.9629 19.1434 20.5449 19.5614 20.0295 19.5614C19.5141 19.5614 19.0962 19.1434 19.0962 18.628V11.1614C19.0962 10.6459 19.5141 10.228 20.0295 10.228Z" fill="#4087D4"></path>
          </svg>
      </button>
      <button class="_head-icon-container _reading-list-icon hidden" title="manage in reading list">
          <svg class="add-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M20 10.111C20 10.6633 19.5523 11.111 19 11.111H11.1111V19C11.1111 19.5523 10.6634 20 10.1111 20H9.8889C9.33662 20 8.8889 19.5523 8.8889 19V11.111H1C0.447717 11.111 0 10.6633 0 10.111V9.88883C0 9.33654 0.447715 8.88883 1 8.88883H8.8889V1C8.8889 0.447715 9.33662 0 9.8889 0H10.1021C10.6579 0 11.1071 0.45318 11.1021 1.00893L11.0317 8.88883H19C19.5523 8.88883 20 9.33654 20 9.88883V10.111Z" fill="currentColor"></path>
          </svg>

          <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="25" height="23" viewBox="0 0 448 512">
              <path d="M443.3 100.7C449.6 106.9 449.6 117.1 443.3 123.3L171.3 395.3C165.1 401.6 154.9 401.6 148.7 395.3L4.686 251.3C-1.562 245.1-1.562 234.9 4.686 228.7C10.93 222.4 21.06 222.4 27.31 228.7L160 361.4L420.7 100.7C426.9 94.44 437.1 94.44 443.3 100.7H443.3z" fill="currentColor"></path>
          </svg>
      </button>
  </div>
  <div class="_right">
      <div class="_date-container" data-tooltip-y-offset="10" data-more-info="<div class='date-popup-container'><div>livebook updated March 2025</div><div>Publication estimate October 2025</div></div>"><span class="hide-small">MEAP</span> v1</div>
      <button class="_head-icon-container _subscription-cart-button hidden" title="cart">
          buy <span class="hide-small">the book</span>
      </button>
  </div>
</div></div> 
<div class="introduction-summary"> 
<h3>This chapter covers</h3> 
<ul> 
<li class="readable-text" refid="2" id="2" data-hash="656b9ed8b4cb6ed69ba38833b61f84f9">Different chunking strategies</li> 
<li class="readable-text" refid="3" id="3" data-hash="d1d85ebd18a95d58162df6e13a30e3dd">Preprocessing raw data into embeddings</li> 
<li class="readable-text" refid="4" id="4" data-hash="6b8474b4ada1be096dc80ae50a5e90c5">Tagging vector data with metadata</li> 
<li class="readable-text" refid="5" id="5" data-hash="b546325769a5d0807ff033e7dbda39f9">Ingesting data into vector databases for search</li> 
</ul> 
</div> 
<div class="readable-text " refid="6" id="6" data-hash="6a2acb29f0549e5821dbade699f2d300"> 
<p>Now that we’ve covered evaluations (evals) and their critical role in creating an enterprise Retrieval-Augmented Generation (RAG) system, it’s time to move on to the next key phase: ingesting source data. The accuracy and usefulness of a RAG system’s responses depend heavily on the quality and format of the data it’s given. To ensure the Large Language Model (LLM) generates helpful, factually correct answers, we must provide it with the most relevant context. This process—selecting, preparing, and feeding data into the system—is what we call data ingestion.</p> 
</div> 
<div class="readable-text  intended-text" refid="7" id="7" data-hash="4b7cbbd634731a7b57810091786cbdaf"> 
<p>Earlier, in Chapter 1, we looked at the big-picture architecture of a RAG system. Now, as we examine Figure 3.1, you’ll notice it shows the same overall diagram but highlights the ingestion phase. By focusing on this part of the pipeline, we can visualize how selecting and preprocessing your data sets the stage for the entire retrieval and answer-generation process. Before we dive into code, we’ll first break down the conceptual steps involved, ensuring that when you see the code, you’ll already understand what it’s aiming to achieve.</p> 
</div> 
<div class="browsable-container figure-container" refid="8" id="8" data-hash="2a02e90c653d63432195d894de055115"> 
<h5>Figure 3.1 Ingestion 1 is the first component of our RAG system</h5> 
<img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image001.png" data-alt="Title: dimensions:[378x296] - Description: 031.png" loading="lazy" width="1200" height="939" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image001.png" class="medium-zoom-image"> 
</div> 
<div class="readable-text " refid="9" id="9" data-hash="6a27577fb2cc34dccbb1f6b541be7e4d"> 
<p>In a real-world scenario, raw data rarely arrives in a neat, uniform format. It often comes as PDF documents, text files, emails, database entries, and more. Each format may require different extraction and formatting steps, known collectively as preprocessing, to ensure all the information is represented consistently. After preprocessing, we transform these standardized data chunks into numerical representations called vector embeddings. These embeddings are essential for what’s known as <em>semantic search</em>—a type of search that matches the underlying meaning of text rather than just the keywords.</p> 
</div> 
<div class="readable-text  intended-text" refid="10" id="10" data-hash="da57087a0417510ea34c45b10f086fcf"> 
<p>What is semantic search and why do we use vector embeddings? Semantic search is the process of understanding context of the words and find closest match based on their vector representations. Traditional search engines look for literal occurrences of a query’s terms. In contrast, semantic search goes deeper, understanding that words like “good” and “awesome” share similar meanings. This approach allows the system to return relevant content even if the user’s query isn’t a direct keyword match to the underlying text.</p> 
</div> 
<div class="readable-text  intended-text" refid="11" id="11" data-hash="dd26f68eea99a16d0ba2085d8190f545"> 
<p>But how do we enable a machine to recognize these conceptual similarities? That’s where vector embeddings come in. An embedding model converts chunks of text into dense numerical vectors (essentially, arrays of numbers). Words or sentences with similar meanings end up represented by vectors that are close together in this high-dimensional vector space. Using a measure such as cosine similarity, the system can quickly find the closest vectors—and thus the most conceptually related content—to a given query.</p> 
</div> 
<div class="readable-text  intended-text" refid="12" id="12" data-hash="4d7ca629486b33b4be39a4aff89c290b"> 
<p>Cosine similarity measures how close two non-zero vectors are by looking at the cosine of the angle between them. When that angle is 0°, the cosine is 1, meaning the vectors point in exactly the same direction. If they are at 90° to each other, the cosine is 0, showing no similarity in orientation. And if they point in opposite directions, the cosine is -1. Notice that the actual size of each vector doesn’t matter—only how they’re oriented. Applied to language, cosine similarity helps us see that even if two words differ in length, if they express similar meanings, their vectors will lie closer together in the embedding space. In other words, vector embeddings let us capture and compare the underlying meaning of words and phrases, which makes semantic search possible. Figure 3.2 illustrates this idea: an embedding model takes text as input and produces a vector representation, enabling the system to retrieve data based on meaning rather than just matching exact words.</p> 
</div> 
<div class="browsable-container figure-container" refid="13" id="13" data-hash="13f7fb8d22733179569a88423dc15584"> 
<h5>Figure 3.2 Embedding model converts text into vector embeddings. (Note these vector numbers are just arbitrary, for illustration purposes only.)</h5> 
<img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image002.png" data-alt="Title: dimensions:[378x239.25] - Description: 032.png" loading="lazy" width="1200" height="759" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image002.png" class="medium-zoom-image"> 
</div> 
<div class="readable-text " refid="14" id="14" data-hash="a531cd11b10c703862823212912cc2ea"> 
<p>By understanding the role of embeddings and semantic search, you can see why preprocessing and proper data ingestion are so critical. Selecting high-quality data and preparing it to be easily searchable dramatically impacts how well your RAG system can respond with accurate and relevant information.</p> 
</div> 
<div class="readable-text  intended-text" refid="15" id="15" data-hash="1466ea7b01470f4124b68c00ea27817a"> 
<p>Throughout this chapter, we’ll go deeper into how to preprocess your data, transform it into embeddings, and store it in a vector database—an ideal storage solution for these numerical representations. We’ll also cover how tagging vectors with metadata can further improve search quality by narrowing results down to the most relevant subsets of your data.</p> 
</div> 

  <div class="readable-text" refid="16" id="16" data-hash="3689fb48d6abb079b275081283a75270"> 
<h2>3.1 Input data sources for your RAG system</h2> 
</div> 
<div class="readable-text " refid="17" id="17" data-hash="995f32b662f8af3695c26f6e3472fc5c"> 
<p>Since the quality of your data directly impacts the accuracy and usefulness of the RAG system’s responses, it’s important to understand how to choose which information should be included. Think of it this way: if you’re building a shopping assistant, you need to decide which product catalogs, inventory databases, or customer review repositories to feed into your system. If your data is too narrow—say, just a single outdated spreadsheet—then the system won’t have the breadth of information needed to answer customer questions. If it’s too broad or contains unrelated details, you risk confusing the system and producing irrelevant answers.</p> 
</div> 
<div class="readable-text  intended-text" refid="18" id="18" data-hash="b400519acac6e4c335314ab6fddb072f"> 
<p>When building a RAG system, the data sources must align with your business goals. If the primary purpose is to help users find and understand products, you might integrate your internal product database so that customers can get the latest information on pricing, models, inventory, or delivery options. Imagining expected user queries can really help here. For example, a shopping assistant might face questions like, “What’s the battery life of this particular phone?” or “Do people generally find that this T-shirt fits true to size?” If you consider which types of users will interact with the system, you can anticipate the sort of questions they’ll ask. A price-conscious shopper might want to know if there are any ongoing discounts or promotions, while someone focused on product quality might ask about durability or brand reputation. Someone else might be interested in return policies and warranty information. By brainstorming a variety of user roles and their likely questions, you can pinpoint the exact data sources needed, whether that’s product specs, user reviews, price sheets, or shipping policies.</p> 
</div> 
<div class="readable-text  intended-text" refid="19" id="19" data-hash="bf71de94138fd836febe5799d0d5781c"> 
<p>This process is different from the evaluations discussed in Chapter 2. While that chapter focused on how to measure and assess the system’s performance after it has been built, the approach here is more about planning and selecting your initial data sources based on who will use the system and what they’ll want to know before you even start. By thoughtfully choosing your data ahead of time, you lay a stronger foundation for building a successful RAG system.</p> 
</div> 
<div class="readable-text  intended-text" refid="20" id="20" data-hash="88538b31ab9b2a0600d88b1256196755"> 
<p>Along with relevance, authenticity and correctness are crucial. If the context you provide to your LLM is factually incorrect or outdated, the system’s responses will suffer. For sensitive areas like healthcare or finance, where the stakes are high, it’s essential to ensure that the ingested data is accurate and verified. Here, “context” refers to the information retrieved from your chosen data sources and passed into the LLM at query time. For instance, when a customer asks a specific question, the RAG system searches through your ingested data, selects the most relevant pieces, and sends that data—now acting as the immediate context—along with the user’s query to the LLM. The LLM uses this context to craft its response. By Chapter 4, you’ll have a clearer step-by-step understanding of how this entire retrieval and context-feeding process works.</p> 
</div> 
<div class="readable-text  intended-text" refid="21" id="21" data-hash="d57cf4f985f5aaf110b68526b5e5d433"> 
<p>When you’re just starting out, it’s often best to begin with a limited set of data sources so you can quickly build and test the entire pipeline. You can expand the range of data sources later once the basic system is running smoothly. Because data often isn’t uniform—some is in PDF files, others in PowerPoint slides, spreadsheets, or SQL databases—you’ll likely need separate ETL (Extract, Transform and Load) pipelines for each format. Once transformed, these different streams can be combined into a single, unified ingestion pipeline. The key is that, no matter what format the data starts in, it ends up in a form that the RAG system can efficiently search and retrieve from.</p> 
</div> 
<div class="readable-text  intended-text" refid="22" id="22" data-hash="0e0963f8ca93759c92af5cd6e441eab6"> 
<p>Figure 3.3 shows this concept in action. It illustrates how multiple specialized ETL pipelines, each tailored to a particular data source format, are merged into a unified ingestion process. Notice how the figure emphasizes the idea that no matter if your source is a document, a presentation, or a database table, you can transform it into a consistent, query-ready format. By doing so, you ensure that when the RAG system receives a user query, it can pull relevant information from a well-prepared and centrally managed pool of data.</p> 
</div> 
<div class="browsable-container figure-container" refid="23" id="23" data-hash="e38548d2bf8a7e6964256426e62f514f"> 
<h5>Figure 3.3 We have to build a separate ETL pipeline for each input source, in this case, for PDFs, spreadsheets, and online reviews.</h5> 
<img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image003.png" data-alt="Title: dimensions:[378x185] - Description: 033.png" loading="lazy" width="1042" height="510" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image003.png" class="medium-zoom-image"> 
</div> 
<div class="readable-text " refid="24" id="24" data-hash="63e5f92558ff920e1716db43a1bf703a"> 
<p>Multiple ETL pipelines feed different data formats—like PDFs, slides, and spreadsheets—into one unified ingestion pipeline. Each data source undergoes a tailored transformation, ensuring the entire system has a consistent, searchable format to serve as context for the RAG system’s responses.</p> 
</div> 
<div class="readable-text  intended-text" refid="25" id="25" data-hash="39f58e9111c60efdcfdce3630bda342a"> 
<p>Initially, it's advisable to start with limited data sources and focus on building the end-to-end flow before scaling to multiple data sources. Since data may not be in a uniform structure, we'll have to build multiple ETL pipelines for each data type—such as PDFs, PowerPoint presentations, spreadsheets, SQL tables, and more. For example, scanned PDFs or multimedia files may require OCR or image processing to convert the data into a uniform structure. If input data is in audio form, we might have to convert it into text using speech-to-text models to get more information in the expected format. Figure 3.3 shows how different ETL pipelines can be combined to create a unified data ingestion pipeline.</p> 
</div> 
<div class="readable-text  intended-text" refid="26" id="26" data-hash="eccc3d847d6673a02b2d5b25f11f35c4"> 
<p>Essentially, the process involves building pipelines that extract text from various file types while preserving their structure, then feeding that structured data into subsequent steps for processing. These steps, as shown in Figure 3.1, include reading the source files, converting the extracted content into a structured format, and then generating smaller, more manageable text chunks that can be easily consumed by downstream systems. For example, when dealing with PDF documents, we have a separate extraction pipeline that reads each PDF file, organizes its textual content, and then hands off the structured output to the next stage to create chunks. This same approach, as depicted in Figure 3.1, is followed for other file types as well, ensuring that every piece of text—regardless of its original format—moves through the pipeline in a consistent, step-by-step manner.</p> 
</div> 
<div class="readable-text  intended-text" refid="27" id="27" data-hash="4b2c40f789e48f4aa480887cbf2fa5d9"> 
<p>To see this in action, let’s dive into a concrete example of extracting text from PDF files. Suppose we have a directory located at "/home/user/documents/pdfs" that contains several PDF files. We can write a function in Python to iterate over every file in that directory, open each PDF using the PyPDF2 library, and extract its text. This code can be adapted to suit your own environment and directory structure, but the general logic remains the same. If your files are stored elsewhere, simply change the directory path. The following code (Listing 3.1) demonstrates how to do this, and you can run it as is on most systems with Python installed and PyPDF2 available. There is no reliance on a specific database or any other specialized infrastructure, so readers can use it directly or tailor it to their needs.</p> 
</div> 
<div class="browsable-container listing-container no-annotations" refid="28" id="28" data-hash="d8c6c2b9227957774592b70efa0fbacb"> 
<h5>Listing 3.1 Extract text from PDFs</h5> 
<div class="code-area-container"> 
<pre class="code-area" data-code-area-highlighted="true"><code class="hljs hljs-line-numbers" style="float:left"><div class="line-number line-number-1">1</div><div class="line-number line-number-2">2</div><div class="line-number line-number-3">3</div><div class="line-number line-number-4">4</div><div class="line-number line-number-5">5</div><div class="line-number line-number-6">6</div><div class="line-number line-number-7">7</div><div class="line-number line-number-8">8</div><div class="line-number line-number-9">9</div><div class="line-number line-number-10">10</div><div class="line-number line-number-11">11</div><div class="line-number line-number-12">12</div><div class="line-number line-number-13">13</div><div class="line-number line-number-14">14</div><div class="line-number line-number-15">15</div><div class="line-number line-number-16">16</div><div class="line-number line-number-17">17</div><div class="line-number line-number-18">18</div><div class="line-number line-number-19">19</div><div class="line-number line-number-20">20</div></code><code class="hljs"><span class="hljs-keyword">import</span> PyPDF2
<span class="hljs-keyword">import</span> os

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_text_from_pdf</span><span class="hljs-params">(file_path)</span>:</span>
text = <span class="hljs-string">""</span>
<span class="hljs-keyword">with</span> open(file_path, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> file:
  reader = PyPDF2.PdfReader(file)
  <span class="hljs-keyword">for</span> page <span class="hljs-keyword">in</span> reader.pages:
      text += page.extract_text() <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>
<span class="hljs-keyword">return</span> text

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_pdfs_from_directory</span><span class="hljs-params">(directory_path)</span>:</span>
texts = []
<span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> os.listdir(directory_path):
  <span class="hljs-keyword">if</span> filename.lower().endswith(<span class="hljs-string">'.pdf'</span>):
      file_path = os.path.join(directory_path, filename)
      text = extract_text_from_pdf(file_path)
      texts.append(text)
<span class="hljs-keyword">return</span> texts
</code></pre> 
<div class="code-annotations-overlay-container" data-annotations-created="true"></div> 
</div> 
<div class="listing-environment-container">
<div class="listing-environment-toolbar">
<span class="listing-environment-runnable-script-container">
  
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
</span>
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
</span>
</span></div>
</div></div> 
<div class="readable-text " refid="29" id="29" data-hash="53097d3fc1ae8557bab2b20817209b26"> 
<p>While this example focuses on PDFs, the same concept applies to other data sources. You might want to extract text from spreadsheets stored in Excel files, or even from website reviews available in HTML format. In these cases, the choice of reader will depend on the file type. For Excel sheets, pandas can be a great option, allowing you to load the data into a DataFrame and then iterate through its cells. For a variety of file formats, including web content and presentation slides, LlamaIndex’s directory reader works seamlessly to pull in content and present it in a structured way. In all these scenarios, the pipeline remains conceptually the same as the one shown in Figure 3.1—read and parse the source, organize it into a structured format, and then feed that information into the chunking process that prepares it for the next stage of analysis.</p> 
</div> 

  <div class="readable-text" refid="30" id="30" data-hash="e551b462562886508fc3a47f4abe2693"> 
<h2>3.2 Chunking strategies</h2> 
</div> 
<div class="readable-text " refid="31" id="31" data-hash="8113c074addac36d12390caf3a915f03"> 
<p>When you have a massive amount of data, it’s not practical to feed all of it into your LLM just to get an answer to a very specific question. For instance, if you want to understand the termination rights within a lengthy 100-page contract, there’s no need to send the entire document to the model. Instead, you only need to locate the relevant section and provide that portion to the LLM. This process of breaking down larger content into more manageable, focused pieces is called chunking—that is, splitting a big document into smaller parts so the LLM can better handle them.</p> 
</div> 
<div class="readable-text  intended-text" refid="32" id="32" data-hash="ec575cc7b96c3550d49aa25d4bccafed"> 
<p>So how do you decide where to split the data? Let’s go back to the contract example: “What are the termination rights of this contract?” A simple approach is <em>fixed-size chunking</em>, where you might create chunks of, say, 500 words each. While straightforward, this can lead to issues when key details run across chunk boundaries. For example, if the termination clause starts in one chunk and finishes in the next, you might lose crucial context, making it harder for the LLM to produce accurate answers.</p> 
</div> 
<div class="readable-text  intended-text" refid="33" id="33" data-hash="ac9d768be897b69a213ecf983090dd9e"> 
<p>To deal with this, people often turn to more advanced methods like <em>recursive chunking</em> or <em>paragraph-level chunking</em>. <em>Recursive chunking</em> involves creating overlapping chunks—adding a few words from the previous chunk into the next one—so you don’t miss important details. However, this doesn’t always solve the problem completely. Why? Because it depends on how well your retrieval process understands meaning and can pull together all related chunks. This is where <em>semantic search</em> comes into play.</p> 
</div> 
<div class="readable-text  intended-text" refid="34" id="34" data-hash="f101c4a0c2521b85d8bb9d2cf7884f0e"> 
<p><em>Semantic search</em> is all about capturing the intended meaning behind words, not just the words themselves. By converting text into vector embeddings, the search system identifies content that’s conceptually related, even if the exact keywords differ. For example, “good” and “great” share a similar meaning. When we apply semantic search to chunking, we aim to find the specific parts of the text that best match the user’s query, regardless of where those words physically appear in the document.</p> 
</div> 
<div class="readable-text  intended-text" refid="35" id="35" data-hash="23a31acacb4485a4a0901ad6cdac1f8c"> 
<p>One highly effective approach is <em>semantic chunking</em>. Think of it like breaking a story into paragraphs at natural transitions. When you write an essay, you start a new paragraph when you shift to a different topic. Similarly, semantic chunking tries to detect these “topic shifts” by looking at the similarity (measured by cosine similarity) between one sentence and the next. When the similarity score falls below a certain threshold, it signals a change in topic, and a new chunk begins.</p> 
</div> 
<div class="readable-text  intended-text" refid="36" id="36" data-hash="813632f5c15d2208da55976dabd548c7"> 
<p>Consider this example:</p> 
</div> 
<div class="readable-text  intended-text" refid="37" id="37" data-hash="21933a2718eb854a1f92c3712ccdfb95"> 
<p>"Sam is pursuing a master's in computer science. His favorite subjects are operating systems, machine learning, and data science. However, he is currently working on a research project related to AI in healthcare, which he finds very interesting. He likes to play tennis and go on hikes during his leisure time. He has been to most of the national parks in the United States."</p> 
</div> 
<div class="readable-text  intended-text" refid="38" id="38" data-hash="5642a8f25fbb5d9be294519aa420946a"> 
<p>After the first three sentences—which focus on Sam’s academic pursuits—there’s a shift to his hobbies. So we create our chunks at that point:</p> 
</div> 
<div class="readable-text " refid="39" id="39" data-hash="43c1a7dc4bd0b4aea3dea37e6a666576"> 
<p><strong>Chunk 1:</strong></p> 
</div> 
<div class="readable-text " refid="40" id="40" data-hash="a1ea1a216a327c633469ce580a22679e"> 
<p>"Sam is pursuing a master's in computer science. His favorite subjects are operating systems, machine learning, and data science. However, he is currently working on a research project related to AI in healthcare, which he finds very interesting."</p> 
</div> 
<div class="readable-text " refid="41" id="41" data-hash="1f28ae5908e7ae753f22845bd73a77b2"> 
<p><strong>Chunk 2:</strong></p> 
</div> 
<div class="readable-text " refid="42" id="42" data-hash="2e8e3941084fdb3990e7c461da889a02"> 
<p>"He likes to play tennis and go on hikes during his leisure time. He has been to most of the national parks in the United States."</p> 
</div> 
<div class="readable-text  intended-text" refid="43" id="43" data-hash="9380e9521699fa40d015b1c03c1bb9e0"> 
<p>This is exactly what <em>semantic chunking</em> aims to achieve (see Figure 3.4). We determine the breakpoints by comparing consecutive sentences’ vector embeddings and introducing a chunk boundary whenever their semantic similarity drops below our chosen threshold. Although this method can be more computationally expensive, it produces higher-quality chunks.</p> 
</div> 
<div class="browsable-container figure-container" refid="44" id="44" data-hash="5a84b2569368b53093450e9e5df8ee78"> 
<h5>Figure 3.4 Semantic chunking: The last 2 sentences are different enough from the first 3 sentences that they need to be divided into two chunks.</h5> 
<img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image004.png" data-alt="Title: dimensions:[378x107.25] - Description: 034.png" loading="lazy" width="1200" height="340" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image004.png" class="medium-zoom-image"> 
</div> 
<div class="readable-text " refid="45" id="45" data-hash="074314f9cb1e01cb617eba6c8da60074"> 
<p>In the following sections, we’ll walk through practical examples and share tools and techniques for implementing semantic chunking. You’ll learn how to set similarity thresholds, generate vector embeddings, and experiment with different chunking approaches, ensuring you have the know-how to apply these strategies to your own datasets.</p> 
</div> 
<div class="readable-text  intended-text" refid="46" id="46" data-hash="dceee961416a26663022740fe1819ca0"> 
<p>In a slight variation of <em>semantic chunking</em>, you can calculate the cosine similarity of each new sentence against the <em>anchor sentence</em>—that is, the very first sentence of the current chunk—rather than comparing it to the immediately preceding sentence. Think of it this way: you’re using a stable point of reference, the first sentence, to determine when the topic shifts enough to start a new chunk. In our earlier example about Sam’s interests, the first sentence established that we’re talking about his academic life. When we compare subsequent sentences to this anchor and find a big enough difference—like when Sam’s hobbies (tennis and hiking) pop up—we mark that as a logical place to introduce a new chunk.</p> 
</div> 
<div class="readable-text  intended-text" refid="47" id="47" data-hash="a276bb0c96cce24b8630157bf6f5cfb5"> 
<p>We will show you exactly how to implement this process with the code examples that follow. But before diving into the specifics of this “anchor-based” semantic chunking approach, let’s first get a handle on the more conventional methods of chunking so we have a baseline comparison.</p> 
</div> 
<div class="readable-text  intended-text" refid="48" id="48" data-hash="6b07b598a71e04d3ebd896644ff96baa"> 
<p>The code listings in this section help us build the entire process of extracting sentences from a large text, generating their embeddings, and calculating semantic similarity scores. By walking through traditional chunking strategies first, you’ll see the limitations of basic approaches and understand why we need more sophisticated methods like semantic chunking. Ultimately, all these code snippets come together to form a workflow that lets you identify logical breakpoints in your text and create meaningful, contextually coherent chunks.</p> 
</div> 
<div class="readable-text  intended-text" refid="49" id="49" data-hash="b03f0fc18c5d53cf50c1afaad83d819e"> 
<p>Below is some code that demonstrates <em>traditional chunking strategies,</em> such as <em>fixed-size chunking</em> and <em>fixed-size chunking with overlap.</em> In these approaches, we don’t consider semantics yet; we’re merely splitting the text by a fixed number of characters, which can be a starting point but often isn’t ideal for capturing meaning.</p> 
</div> 
<div class="readable-text  intended-text" refid="50" id="50" data-hash="cc914d29472c869d279b4787ef101599"> 
<p>Traditional chunking strategies typically refer to simple, rules-based approaches like fixed-size chunking (just splitting the text every 128 characters) and fixed-size chunking with overlap (splitting the text but overlapping a portion of the previous chunk for added context).</p> 
</div> 
<div class="browsable-container listing-container" refid="51" id="51" data-hash="30b4e9de4673be1fc5abf0f0fb52c2ae"> 
<h5>Listing 3.2 Traditional chunking strategy: Fixed-size chunking</h5> 
<div class="code-area-container"> 
<pre class="code-area">def fixed_size_chunking(text, chunk_size=128):
return [text[i:i+chunk_size] for i in range(0, len(text), chunk_size)]  #A

def fixed_size_chunking_with_overlap(text, chunk_size=128, overlap=30):  #B
chunks = []  #C
for i in range(0, len(text), chunk_size - overlap):
  chunks.append(text[i:i+chunk_size])  #D
return chunks
</pre> 
<div class="code-annotations-overlay-container" data-annotations="I0EgV2UgY3JlYXRlIGZpeGVkLXNpemUgY2h1bmtzICgxMjggY2hhcmFjdGVycyBieSBkZWZhdWx0KSBieSBzbGljaW5nIHRoZSB0ZXh0LCBpZ25vcmluZyBhbnkgc2VtYW50aWMgYm91bmRhcmllcy4KI0IgV2UgaW50cm9kdWNlIGFuIG92ZXJsYXBwaW5nIHN0cmF0ZWd5IHdoZXJlIGVhY2ggbmV3IGNodW5rIHNoYXJlcyBzb21lIGNoYXJhY3RlcnMgKGUuZy4sIDMwKSB3aXRoIHRoZSBwcmV2aW91cyBjaHVuayB0byBtYWludGFpbiBhIGJpdCBvZiBjb250aW51aXR5LgojQyBXZSBpbml0aWFsaXplIGEgbGlzdCB0byBzdG9yZSBhbGwgdGhlIHJlc3VsdGluZyBjaHVua3MuCiNEIFdlIHNsaWNlIHRoZSB0ZXh0IGludG8gY2h1bmtzIGFuZCBhZHZhbmNlIG91ciBwb2ludGVyIGJ5IGNodW5rX3NpemUgLSBvdmVybGFwIGNoYXJhY3RlcnMgZWFjaCB0aW1lLiA="></div> 
</div> 
<div class="listing-environment-container">
<div class="listing-environment-toolbar">
<span class="listing-environment-runnable-script-container">
  
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
</span>
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
</span>
</span></div>
</div></div> 
<div class="readable-text " refid="52" id="52" data-hash="c7483533f30efe8c802f47969b77022c"> 
<p>Although these methods are easy to implement, they don’t pay attention to topic changes or meaning. That’s where more advanced techniques, like semantic chunking, come into play. Before we get into semantic chunking, we need a way to break our text into sentences. After all, sentences are often the building blocks for more meaningful analysis than simple character counts.</p> 
</div> 
<div class="readable-text  intended-text" refid="53" id="53" data-hash="0ec182017242fdce08d919e8ff049fe7"> 
<p>Below, we’ll show you a helper function that splits your text into sentences using an NLP library (SpaCy). If you’re new to SpaCy, don’t worry—we’ll explain it as we go. After installing SpaCy using pip, you will need to run this command:</p> 
</div> 
<div class="browsable-container listing-container" refid="54" id="54" data-hash="7804df5060e0e741b0891a0900e47490"> 
<div class="code-area-container"> 
<pre class="code-area">python -m spacy download en_core_web_sm</pre> 
<div class="code-annotations-overlay-container"></div> 
</div> 
<div class="listing-environment-container">
<div class="listing-environment-toolbar">
<span class="listing-environment-runnable-script-container">
  
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
</span>
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
</span>
</span></div>
</div></div> 
<div class="readable-text " refid="55" id="55" data-hash="ad32c17f1a39cf3d6ab7fdc6afb3ce10"> 
<p>We’ll also load a SentenceTransformer model for generating embeddings. These embeddings will help us measure semantic similarity, which is key to identifying meaningful breakpoints in your text.</p> 
</div> 
<div class="browsable-container listing-container" refid="56" id="56" data-hash="12818379c610b58014aa652e260c719f"> 
<h5>Listing 3.3 Semantic chunking</h5> 
<div class="code-area-container"> 
<pre class="code-area">import re
import numpy as np
import spacy
from sentence_transformers import SentenceTransformer

nlp = spacy.load('en_core_web_sm')  #A
model = SentenceTransformer('sentence-transformers/all-mpnet-base-v2')  #B

def break_into_sentences(text):  #C
doc = nlp(text)  #D
sentences = [sent.text for sent in doc.sents]  #E
return sentences  #F</pre> 
<div class="code-annotations-overlay-container" data-annotations="I0EgV2UgbG9hZCBTcGFDeeKAmXMgZW5fY29yZV93ZWJfc20gbW9kZWwsIGEgbGlnaHR3ZWlnaHQgRW5nbGlzaCBtb2RlbCB0aGF0IGtub3dzIGhvdyB0byBicmVhayB0ZXh0IGludG8gc2VudGVuY2VzIGFuZCBpZGVudGlmeSBiYXNpYyBsYW5ndWFnZSBmZWF0dXJlcy4KI0IgV2UgbG9hZCB0aGUgYWxsLW1wbmV0LWJhc2UtdjIgU2VudGVuY2VUcmFuc2Zvcm1lciBtb2RlbCwgd2hpY2ggY2FuIHByb2R1Y2UgcG93ZXJmdWwgc2VtYW50aWMgZW1iZWRkaW5ncy4gVGhlc2UgZW1iZWRkaW5ncyBsZXQgdXMgbWVhc3VyZSBob3cgY2xvc2VseSByZWxhdGVkIGRpZmZlcmVudCBzZW50ZW5jZXMgYXJlIGluIG1lYW5pbmcuCiNDIFdlIGRlZmluZSBhIGJyZWFrX2ludG9fc2VudGVuY2VzIGZ1bmN0aW9uIHRvIHNlcGFyYXRlIHlvdXIgaW5wdXQgdGV4dCBpbnRvIGEgbGlzdCBvZiBpbmRpdmlkdWFsIHNlbnRlbmNlcy4KI0QgU3BhQ3nigJlzIERvYyBvYmplY3QgYXV0b21hdGljYWxseSBoYW5kbGVzIHRhc2tzIGxpa2Ugc2VudGVuY2Ugc2VnbWVudGF0aW9uLgojRSBXZSBleHRyYWN0IGVhY2ggc2VudGVuY2UgYXMgdGV4dCwgZ2l2aW5nIHVzIGEgc2ltcGxlIGxpc3Qgb2Ygc2VudGVuY2VzIHRvIHdvcmsgd2l0aC4KI0YgRmluYWxseSwgd2UgcmV0dXJuIHRoaXMgbGlzdCwgcmVhZHkgZm9yIHRoZSBuZXh0IHN0ZXBz4oCUZW1iZWRkaW5nIGFuZCBzaW1pbGFyaXR5IGNhbGN1bGF0aW9ucy4="></div> 
</div> 
<div class="listing-environment-container">
<div class="listing-environment-toolbar">
<span class="listing-environment-runnable-script-container">
  
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
</span>
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
</span>
</span></div>
</div></div> 
<div class="readable-text " refid="57" id="57" data-hash="4836b5a6ac5796123cbc5aed7e131ea3"> 
<p>With sentences in hand, we’re now ready to bring in semantic analysis. The next code listing shows how we’ll generate embeddings for each sentence and compute their cosine similarity. This is the engine that powers semantic chunking. For a visual of this process, take a look at figure 3.5 before delving into the code. Essentially, we start with raw text, break it into sentences, encode them, and then measure how closely these sentences are related in meaning.</p> 
</div> 
<div class="browsable-container figure-container" refid="58" id="58" data-hash="d051ce201bdef5ef33b8ade3ab85ba1b"> 
<h5>Figure 3.5 Semantic chunking overview: we break our text up into sentences, embed them, find the similarities, and decide on breakpoints to separate the text.</h5> 
<img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/035.png" data-alt="Title: dimensions:[146.65x318.55] - Description: 035.png" loading="lazy" width="196" height="425"> 
</div> 
<div class="readable-text " refid="59" id="59" data-hash="0a2816eb202e190605734cc48a3a742a"> 
<p>In other words, here’s the big picture:</p> 
</div> 
<ol start="1"> 
<li class="readable-text" refid="60" id="60" data-hash="999dd8c36bcd75bb6389bbfed502f6c2">Break text into sentences: Using SpaCy, we split large text into sentences.</li> 
<li class="readable-text" refid="61" id="61" data-hash="a5ce585f9dfdfcf391ce2aa7e3ef5a19">Generate embeddings: Using SentenceTransformers, we convert these sentences into numeric embeddings.</li> 
<li class="readable-text" refid="62" id="62" data-hash="910e729eb5e2922079da7a2f9b18f882">Calculate similarities: We compute the cosine similarity between these embeddings to see where the topic shifts.</li> 
<li class="readable-text" refid="63" id="63" data-hash="2d074d6796a8c30191ce0fd3c5148cd6">Decide where to chunk: Based on the similarity scores—especially comparing each sentence to our anchor sentence—we decide where to introduce chunk boundaries.</li> 
</ol> 
<div class="browsable-container listing-container" refid="64" id="64" data-hash="21ba7252dad2e462413785a88c4aaf8a"> 
<h5>Listing 3.4 Calculate cosine similarity</h5> 
<div class="code-area-container"> 
<pre class="code-area"> 
from sklearn.metrics.pairwise import cosine_similarity
from sentence_transformers import SentenceTransformer


def calculate_cosine_similarity(sentences, model, batch_size=8):  #A
sentence_embeddings = []  #B
for i in range(0, len(sentences), batch_size):  #C
  batch_embeddings = model.encode(sentences[i:i + batch_size])  #D
  sentence_embeddings.extend(batch_embeddings)  #E

sentence_embeddings = np.array(sentence_embeddings)  #F
cosine_similarities = cosine_similarity(sentence_embeddings)  #G
return cosine_similarities  #H
</pre> 
<div class="code-annotations-overlay-container" data-annotations="I0EgV2UgZGVmaW5lIGEgY2FsY3VsYXRlX2Nvc2luZV9zaW1pbGFyaXR5IGZ1bmN0aW9uIHRvIHF1YW50aWZ5IGhvdyBzZW1hbnRpY2FsbHkgc2ltaWxhciBzZW50ZW5jZXMgYXJlLCB1c2luZyB0aGVpciBlbWJlZGRpbmdzLgojQiBXZSBzdGFydCB3aXRoIGFuIGVtcHR5IGxpc3QgdG8gc3RvcmUgZW1iZWRkaW5ncy4KI0MgV2UgcHJvY2VzcyBzZW50ZW5jZXMgaW4gYmF0Y2hlcyB0byBoYW5kbGUgbGFyZ2UgdGV4dHMgZWZmaWNpZW50bHkuCiNEIFdlIGVuY29kZSBlYWNoIGJhdGNoIGludG8gZW1iZWRkaW5ncy4KI0UgV2UgYWNjdW11bGF0ZSBlbWJlZGRpbmdzIGZvciBhbGwgc2VudGVuY2VzLgojRiBDb252ZXJ0IHRoZXNlIGVtYmVkZGluZ3MgaW50byBhIE51bVB5IGFycmF5IGZvciBlYXNpZXIgbWF0aGVtYXRpY2FsIG9wZXJhdGlvbnMuCiNHIFdlIHVzZSBjb3NpbmVfc2ltaWxhcml0eSB0byBjb21wYXJlIGV2ZXJ5IHNlbnRlbmNlIHdpdGggZXZlcnkgb3RoZXIgc2VudGVuY2UuCiNIIEZpbmFsbHksIHdlIHJldHVybiBhIG1hdHJpeCBvZiBzaW1pbGFyaXR5IHNjb3JlcyB0aGF0IHdpbGwgZ3VpZGUgb3VyIGNodW5raW5nIGRlY2lzaW9ucy4g"></div> 
</div> 
<div class="listing-environment-container">
<div class="listing-environment-toolbar">
<span class="listing-environment-runnable-script-container">
  
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
</span>
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
</span>
</span></div>
</div></div> 
<div class="readable-text " refid="65" id="65" data-hash="eb1a0738551e16d3f823d0282bbb9bad"> 
<p>Now that we’ve established how to do fixed-size chunking and how to generate semantic embeddings and similarity scores, we’re poised to implement the anchor-based semantic chunking approach. Using our cosine similarity scores, we’ll determine exactly when to “cut” the text into a new chunk. This will help us build a more intelligent and context-aware data ingestion process—a key capability when working with RAG systems and large language models.</p> 
</div> 
<div class="readable-text  intended-text" refid="66" id="66" data-hash="f05e7f12fe3f8887aee79bd63a320c21"> 
<p>One of the trickiest parts of <em>semantic chunking</em> is choosing the right threshold value to decide where one topic ends and another begins. A common guideline is to use something around 0.3 as a “sweet spot,” but this number may vary a lot depending on your dataset. In other words, what works for one collection of documents might not work for another.</p> 
</div> 
<div class="readable-text  intended-text" refid="67" id="67" data-hash="8ff69f096237c5df019e9d793d170060"> 
<p>So how do you pick a threshold that’s just right for your data? This is where <em>adaptive thresholding</em> comes in (Figure 3.6). Instead of using a fixed cutoff, adaptive thresholding analyzes the actual semantic “shape” of your dataset. It collects the cosine distances between consecutive sentences, stores them in an array, and uses a percentile calculation to find a threshold that naturally fits your text. For example, you might start with the 25th percentile—meaning that 25% of your sentence-to-sentence similarities are below this number. These lower-similarity points suggest natural boundaries where the topic shifts.</p> 
</div> 
<div class="browsable-container figure-container" refid="68" id="68" data-hash="067b7b4f1e149986b33d09010a14f3ab"> 
<h5>Figure 3.6 Adaptive thresholding based on other sentences in the dataset.</h5> 
<img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image005.png" data-alt="Title: dimensions:[378x220.8] - Description: 036.png" loading="lazy" width="1200" height="701" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image005.png" class="medium-zoom-image"> 
</div> 
<div class="readable-text " refid="69" id="69" data-hash="781588a342d52e2b50501c160dd788d6"> 
<p>In this diagram, we look at all the cosine distances between consecutive sentences. By focusing on the lower end of these scores—like the 25th percentile—we find natural “valleys” in semantic coherence. These valleys are good places to split your text into chunks, ensuring that each chunk focuses on a cohesive topic.</p> 
</div> 
<div class="readable-text  intended-text" refid="70" id="70" data-hash="ddb938fbfc9c6779d1d31bcbf56844ac"> 
<p>By using adaptive thresholding, you make the chunking process more tailored to your own data. You can start with the 25th percentile and then experiment with different values if you find that the chunks are too large or too small. In practice, this means your chunking will be more accurate and flexible than relying on a one-size-fits-all threshold.</p> 
</div> 
<div class="readable-text  intended-text" refid="71" id="71" data-hash="8b967d33c2271a1a51938411970eef69"> 
<p>Let’s take a look at how this works in figure 3.7 and then we’ll implement it in code. First, we’ll define a function that finds the threshold, and then we’ll implement the segmentation function that uses this threshold to break your text into meaningful chunks.</p> 
</div> 
<div class="browsable-container figure-container" refid="72" id="72" data-hash="2f2919945b041ed93d2ff6962708ca23"> 
<h5>Figure 3.7 The adaptive threshold code process</h5> 
<img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image006.png" data-alt="Title: dimensions:[312.5x493.1] - Description: 037.png" loading="lazy" width="1200" height="1893" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image006.png" class="medium-zoom-image"> 
</div> 
<div class="readable-text " refid="73" id="73" data-hash="00a05ed4350229ef92f40e9559a53a82"> 
<p>The diagram in figure 3.7 explains adaptive threshold implementation step by step. We begin with the first statement as an anchor and start calculating the cosine similarity of every sentence to the anchor statement. We keep adding sentences to the current chunk until the similarity score is above our threshold. Once we reach a point where the current sentence and anchor statement are not similar, we conclude the current chunk and start a new chunk to repeat the process.</p> 
</div> 
<div class="readable-text  intended-text" refid="74" id="74" data-hash="d207f98cc479b80290cc05bd4250f78f"> 
<p>Let’s take a look at the implementation for adaptive threshold:</p> 
</div> 
<div class="browsable-container listing-container" refid="75" id="75" data-hash="f1c7b7f2abc72007032f47bf3dd33ec6"> 
<h5>Listing 3.5 Adaptive threshold</h5> 
<div class="code-area-container"> 
<pre class="code-area"> 
from sklearn.metrics.pairwise import cosine_similarity
from sentence_transformers import SentenceTransformer
from sklearn.neighbors import NearestNeighbors
from nltk.tokenize import sent_tokenize, TextTilingTokenizer

def find_threshold(cosine_similarities, percentile=25):  #A
similarities = cosine_similarities.flatten()  #B
threshold = np.percentile(similarities, percentile)  #C
return threshold  #D


def anchor_based_segmentation(sentences, cosine_similarities, adaptive_percentile=25):  #E
threshold = find_threshold(cosine_similarities, adaptive_percentile)  #F
chunks = []  #G
current_chunk = [sentences[0]]  #H
anchor_idx = 0  #I

for i in range(1, len(sentences)):  #J
  similarity = cosine_similarities[anchor_idx, i]  #J
  if similarity &lt; threshold:  #K
      chunks.append(' '.join(current_chunk))  #L
      current_chunk = [sentences[i]]  #L
      anchor_idx = i  #M
  else:
      current_chunk.append(sentences[i])  #N

if current_chunk:  #O
  chunks.append(' '.join(current_chunk))  #O

return chunks  #P
</pre> 
<div class="code-annotations-overlay-container" data-annotations="I0EgV2UgZGVmaW5lIGEgZnVuY3Rpb24gdG8gZGV0ZXJtaW5lIHRoZSB0aHJlc2hvbGQgZHluYW1pY2FsbHkgYmFzZWQgb24gdGhlIHNlbWFudGljIGRpc3RyaWJ1dGlvbiBvZiB5b3VyIHRleHQuCiNCIEZsYXR0ZW4gdGhlIDJEIHNpbWlsYXJpdHkgbWF0cml4IGludG8gYSAxRCBhcnJheSBmb3IgZWFzaWVyIHBlcmNlbnRpbGUgY2FsY3VsYXRpb24uCiNDIENvbXB1dGUgdGhlIHRocmVzaG9sZCB1c2luZyB0aGUgY2hvc2VuIHBlcmNlbnRpbGUuIEJ5IGRlZmF1bHQsIHdl4oCZcmUgdXNpbmcgdGhlIDI1dGggcGVyY2VudGlsZSBhcyBhIHN0YXJ0aW5nIHBvaW50LgojRCBSZXR1cm4gdGhpcyBjYWxjdWxhdGVkIHRocmVzaG9sZC4KI0UgVGhlIG1haW4gc2VnbWVudGF0aW9uIGZ1bmN0aW9uIHVzZXMgdGhlIHRocmVzaG9sZCBmb3VuZCBhYm92ZS4KI0YgSXQgc3RhcnRzIGJ5IGRldGVybWluaW5nIHRoZSB0aHJlc2hvbGQgdmlhIGZpbmRfdGhyZXNob2xkLCBlbnN1cmluZyB0aGUgYnJlYWtwb2ludCBjaG9pY2UgaXMgdGFpbG9yZWQgdG8gdGhpcyBzcGVjaWZpYyBkYXRhc2V0LgojRyBJbml0aWFsaXplIGEgbGlzdCB0byBzdG9yZSB0aGUgZmluYWwgY2h1bmtzLgojSCBCZWdpbiB5b3VyIGZpcnN0IGNodW5rIHdpdGggdGhlIHZlcnkgZmlyc3Qgc2VudGVuY2UuCiNJIFRyZWF0IHRoYXQgZmlyc3Qgc2VudGVuY2UgYXMgdGhlIOKAnGFuY2hvcuKAnSBmb3IgY29tcGFyaW5nIHN1YnNlcXVlbnQgc2VudGVuY2VzLgojSiBMb29wIHRocm91Z2ggdGhlIHJlbWFpbmluZyBzZW50ZW5jZXMsIGNvbXBhcmluZyBlYWNoIHNlbnRlbmNl4oCZcyBzaW1pbGFyaXR5IHRvIHRoZSBhbmNob3Igc2VudGVuY2UuCiNLIElmIHRoZSBzaW1pbGFyaXR5IGlzIGJlbG93IG91ciB0aHJlc2hvbGQsIGl0IHN1Z2dlc3RzIGEgc2lnbmlmaWNhbnQgdG9waWMgc2hpZnQuCiNMIEZpbmFsaXplIHRoZSBjdXJyZW50IGNodW5rIGFuZCBzdGFydCBhIG5ldyBvbmUgd2l0aCB0aGUgY3VycmVudCBzZW50ZW5jZS4KI00gUmVzZXQgdGhlIGFuY2hvciBpbmRleCB0byB0aGUgY3VycmVudCBzZW50ZW5jZSBzbyBmdXR1cmUgY29tcGFyaXNvbnMgc3RheSByZWxldmFudC4KI04gSWYgdGhlIHNlbnRlbmNlIHN0aWxsIGZpdHMgdGhlIHRoZW1lIChhYm92ZSB0aGUgdGhyZXNob2xkKSwganVzdCBrZWVwIGFkZGluZyBpdCB0byB0aGUgb25nb2luZyBjaHVuay4KI08gQWZ0ZXIgZmluaXNoaW5nIHRoZSBsb29wLCBpZiB3ZSBoYXZlIGEgcGFydGlhbCBjaHVuayB3YWl0aW5nLCB3ZSBhZGQgaXQgdG8gdGhlIGxpc3QuCiNQIFJldHVybiB0aGUgY29tcGxldGVkIGxpc3Qgb2Ygc2VtYW50aWNhbGx5IGNvaGVyZW50IGNodW5rcy4="></div> 
</div> 
<div class="listing-environment-container">
<div class="listing-environment-toolbar">
<span class="listing-environment-runnable-script-container">
  
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
</span>
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
</span>
</span></div>
</div></div> 
<div class="readable-text " refid="76" id="76" data-hash="44f5d10d339395b27b0727e8832e3dd6"> 
<p>We started with traditional, size-based chunking methods and moved through semantic chunking approaches that use cosine similarity to detect topic shifts. Now, we’re taking it a step further with adaptive thresholding, letting the data itself guide where we set our breakpoints. By combining these techniques, you’ll have a flexible and powerful toolkit for chunking text intelligently—an essential step in building effective semantic search and retrieval systems.</p> 
</div> 

  <div class="readable-text" refid="77" id="77" data-hash="d4446d82c3974f5c2646b30aba1d90ca"> 
<h2>3.3 Why do we use vector databases?</h2> 
</div> 
<div class="readable-text " refid="78" id="78" data-hash="49974b33f2294b8879333e037b3c5635"> 
<p>If we revisit our RAG framework and the steps involved, one of the most crucial tasks is extracting the right data from a large collection of documents to provide context to the LLM when answering user queries. You might remember from earlier chapters that semantic search is the key technique we use to accomplish this. If you're seeing this term for the first time, semantic search refers to an approach that goes beyond simple keyword matching. Instead, it understands that words like "good" and "awesome" share similar meanings and that searching for "payment" might also mean you're looking for information related to "paycheck," "invoices," or "salary."</p> 
</div> 
<div class="readable-text  intended-text" refid="79" id="79" data-hash="5b661f745ea0f15a5488a2cf56720399"> 
<p>To implement semantic search, we represent words or entire chunks of text as points in a vector space. These points (or embeddings) capture the meaning and relationships between words. To find similarities, we calculate a similarity measure—commonly cosine similarity—between these vectors. Imagine plotting words in a space where each dimension represents a particular feature or aspect of meaning. This is what we mean by a "multidimensional space": instead of describing each word with just a few attributes, we describe it with hundreds or thousands of numerical values. Each dimension can capture something subtle, such as a topic, a style, or a relationship to other words. The higher the dimensionality, the richer the representation, and the better the system can understand nuances in language.</p> 
</div> 
<div class="readable-text  intended-text" refid="80" id="80" data-hash="26ce9e1ac2eba26652cc785794f56a26"> 
<p>So how do you actually do this in practice? The process involves several steps. First, you'll need to select or train a model that can generate embeddings for your text. Many developers use open-source models from platforms like Hugging Face or rely on commercial APIs, such as OpenAI’s embedding models, which are widely known for their quality and general applicability. After choosing a model, you pass your chunks of text—whether they are sentences, paragraphs, or entire documents—through the model to get a list of numbers representing each piece of text in vector form. Once you have these embeddings, you store them in a system that can handle searches over these vectors. This is where vector databases come into play.</p> 
</div> 
<div class="readable-text  intended-text" refid="81" id="81" data-hash="2fee2c7d96b1d1fd032d72fa8b99433a"> 
<p>Consider our earlier example: you want to find the termination clauses in a contract. The user might say, "How can I terminate this contract?" while the contract file refers to that information under a chapter titled "Discontinuation of the Contract." By embedding both the user's query and your data, you can calculate which sections of your documents are semantically closest to the user's intent. If “termination” and “discontinuation” lie close together in this multidimensional vector space, your system understands that they refer to the same concept. You then retrieve the top K matches—let’s say the top three or five sections—and provide those as context to your LLM.</p> 
</div> 
<div class="readable-text  intended-text" refid="82" id="82" data-hash="8bfbfe73b44529a8fe3782f52eeed261"> 
<p>Implementing semantic search also involves careful indexing and retrieval. Traditional databases like SQL or NoSQL can’t handle similarity-based queries on embeddings efficiently, because they are designed for structured queries that rely on strict matches rather than conceptual similarities. This is why we use vector databases. Vector databases are specifically built to store and search embeddings. They organize data points in a multidimensional space and use advanced algorithms, such as HNSW or IVFPQ, to perform nearest neighbor searches efficiently. This allows the system to quickly find embeddings that are most similar to the user's query, even if the user uses different words or phrases.</p> 
</div> 
<div class="readable-text  intended-text" refid="83" id="83" data-hash="37671e7427e85164bbfdb5910795de2f"> 
<p>To visualize this, imagine that you have a three-dimensional space (just to keep it simple), and each word or sentence is a point in that space. Words that mean similar things end up close together, while words with very different meanings lie far apart. Now scale this up from three dimensions to a thousand or more. That gives you incredibly fine-grained control over meaning and context. For example, searching for "climate change policies" can bring up documents about "global warming regulations" because the model understands the conceptual link between these terms.</p> 
</div> 
<div class="readable-text  intended-text" refid="84" id="84" data-hash="536de2b453ee9174f943e7a9cec72e97"> 
<p>You might wonder why we can’t just do a fuzzy or keyword-based search in a traditional database. The difference becomes clear when the language is more varied or abstract. Suppose a user searches for "How to reset my password.” A keyword-based system might find articles titled "Password Reset Tutorial" or "Reset Password Guide," but it would struggle if the relevant document uses different wording, like "Change Account Credentials.” In a vector-based approach, “reset password” and “change account credentials” would be close together in the embedding space. The system could find the related document even if it doesn’t share the exact same keywords.</p> 
</div> 
<div class="readable-text  intended-text" refid="85" id="85" data-hash="9876a1f68c23f066f3a1e2b477821f9d"> 
<p>In short, semantic search and vector databases empower your RAG system to handle language variations gracefully. By working with embeddings in a high-dimensional vector space, you’re not just guessing based on keywords; you’re reasoning based on meaning. This ability leads to more effective retrieval of relevant context, ensuring your LLM can provide accurate, helpful answers to user queries. As we proceed, we’ll dig deeper into the techniques and tools you’ll need to implement semantic search in your own RAG system.</p> 
</div> 

<div class="readable-text" refid="86" id="86" data-hash="0caad965c7942e1c65fe1d2b919f0102"> 
<h2>3.4 Embedding the text documents</h2> 
</div> 
<div class="readable-text " refid="87" id="87" data-hash="c35e8f715329e7f98725c094f4dfa662"> 
<p>Now that we've explored how vectors power semantic search, let's talk about how to generate these vectors from your text. The process of converting raw text into vector embeddings is at the heart of semantic search. By turning words into numbers that represent meaning, we make it possible for the system to understand relationships between concepts rather than just exact keyword matches.</p> 
</div> 
<div class="readable-text  intended-text" refid="88" id="88" data-hash="a85ae103c4e9f3dc08cb3fe25afb30e9"> 
<p>To create embeddings, we use specialized models known as embedding models or encoders. Each embedding model represents data in a space with a certain number of dimensions—often hundreds or thousands. Think of each dimension as a unique aspect of meaning; a higher number of dimensions can capture more subtle nuances. For example, a model with 768 dimensions might grasp general relationships between words, while a 4096-dimensional model can pick up even finer details. Although higher dimensions can lead to more informative representations, they also require more storage and computational resources, so choosing a model with the right dimension size is a balance between quality and practicality.</p> 
</div> 
<div class="readable-text  intended-text" refid="89" id="89" data-hash="7fd0c9d98d8bf1b5d26b3b53c9c7e85c"> 
<p>Another important consideration is the training domain of the embedding model. Some models are trained on broad, general-purpose data (like huge collections of Wikipedia articles), making them versatile for many tasks. Others are fine-tuned on specific domains, such as healthcare or finance, enabling them to handle technical or specialized vocabulary more effectively. Selecting the right model depends on your business requirements and how domain-specific your queries and documents tend to be. Sometimes it's worth experimenting with a few different models on a small subset of your data to see which produces the best results.</p> 
</div> 
<div class="readable-text  intended-text" refid="90" id="90" data-hash="9dcb62d8a9fa185d336c2c7cec2e678f"> 
<p>You have plenty of options when it comes to embedding models. OpenAI provides popular, general-purpose models that many developers favor due to their strong overall performance. If you need something more specialized, open-source communities like Hugging Face offer a wealth of models, including ones optimized for particular industries or tasks. As of this writing, models like NV Embed 2 by NVIDIA and e5 Mistral 7b instruct boast dimensions of 4096, which are considered quite large. High-dimensional embeddings can offer richer meaning but demand more storage and processing time—factors you should keep in mind for scalability.</p> 
</div> 
<div class="readable-text  intended-text" refid="91" id="91" data-hash="cc4557bca07bc08431c5fe28db1cbd10"> 
<p>To illustrate how to generate embeddings, let’s consider the code snippet below. Here, we’re using the Hugging Face Sentence Transformers library to load a pre-trained model called "all-mpnet-base-v2." This model is known for producing high-quality embeddings for a wide range of text types. If you don't have the model yet, you can easily download it through the Hugging Face Hub, a platform that provides open-source models and datasets. The code demonstrates how to pass your text chunks to the model’s encode function and store the resulting embeddings in a list.</p> 
</div> 
<div class="readable-text  intended-text" refid="92" id="92" data-hash="8c550c4876dd460e39bff65f1594cf66"> 
<p>By the time you finish embedding your data, you’ll have converted all your text chunks into meaningful vector representations. This step paves the way for advanced semantic searches. Remember that the word "cell" could mean a lot of different things: a prison cell, a spreadsheet cell, or a biological cell. A domain-specific embedding model trained on biological texts would help your system pinpoint that “cell” refers to the building block of living organisms. Such precise understanding comes from choosing a model that fits your data’s domain.</p> 
</div> 
<div class="readable-text  intended-text" refid="93" id="93" data-hash="7fe0eb21f32d496061e40e5a15c2c466"> 
<p>Once the data is transformed into embeddings, the next step is ingesting these vector representations into a vector database, setting the stage for your RAG system to perform powerful semantic queries.</p> 
</div> 
<div class="browsable-container listing-container" refid="94" id="94" data-hash="4cbfdce0f695705b7b7c9e2dcadf0838"> 
<h5>Listing 3.6 Convert data into vector embeddings</h5> 
<div class="code-area-container"> 
<pre class="code-area">from sentence_transformers import SentenceTransformer

model = SentenceTransformer('sentence-transformers/all-mpnet-base-v2')  #A

embeddings = []  #B
for chunk in chunks:  #C
embedding = model.encode(chunk)  #D
embeddings.append(embedding)  #E
</pre> 
<div class="code-annotations-overlay-container" data-annotations="I0EgTG9hZCB0aGUgImFsbC1tcG5ldC1iYXNlLXYyIiBtb2RlbCwgd2hpY2ggaXMgd2VsbC1yZWdhcmRlZCBmb3IgcHJvZHVjaW5nIGhpZ2gtcXVhbGl0eSBlbWJlZGRpbmdzLgojQiBJbml0aWFsaXplIGEgbGlzdCB0byBzdG9yZSBlbWJlZGRpbmdzLgojQyBJdGVyYXRlIG92ZXIgZWFjaCBjaHVuay4KI0QgRm9yIGVhY2ggY2h1bmssIHdlIGNhbGwgbW9kZWwuZW5jb2RlKCkgdG8gb2J0YWluIGEgZGVuc2UgdmVjdG9yIGVtYmVkZGluZy4KI0UgQXBwZW5kIHRoZSByZXN1bHRpbmcgdmVjdG9yIHRvIG91ciBlbWJlZGRpbmdzIGxpc3Qu"></div> 
</div> 
<div class="listing-environment-container">
<div class="listing-environment-toolbar">
<span class="listing-environment-runnable-script-container">
  
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
</span>
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
</span>
</span></div>
</div></div> 

<div class="readable-text" refid="95" id="95" data-hash="64b29819a5d5c96ff980431e667a625b"> 
<h2>3.5 Metadata tagging</h2> 
</div> 
<div class="readable-text " refid="96" id="96" data-hash="638b52fe0e1f4d306d147b9aeb4ae99e"> 
<p>Before we move to the final step, there's one more important point to consider. Cosine similarity between two vectors works best when the text length is shorter—usually just a few words or one or two lines. As we've illustrated in figure 3.8, semantic search performs optimally when our context length is brief.</p> 
</div> 
<div class="browsable-container figure-container" refid="97" id="97" data-hash="bbe887278bc34d1a5999b8da03b29e89"> 
<h5>Figure 3.8 Cosine similarity between short sentences vs long sentences</h5> 
<img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image007.png" data-alt="Title: dimensions:[399.25x104.75] - Description: 038.png" loading="lazy" width="1200" height="314" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image007.png" class="medium-zoom-image"> 
</div> 
<div class="readable-text " refid="98" id="98" data-hash="5cc2dcae34964fa8a58c137eea794cc9"> 
<p>However, when implementing RAG at an enterprise level, especially when dealing with enormous amounts of data, it's not always practical to keep the context length short. Doing so might cause us to miss out on valuable information. So, how can we retrieve data accurately without compromising our chunk size? Metadata tagging offers a solution by allowing us to extract useful information from our chunks and use it during retrieval to drastically reduce our search space. To generate metadata, we need to analyze our data as well as our use case. Think of metadata as filters that help categorize your data. For example, if your enterprise data consists of thousands of documents within your organization, a good approach would be to tag them based on departments—like finance, HR, engineering, or customer relations. You can further categorize them using file names. Within finance, for instance, filenames might include annual sales reports, quarterly sales reports, business predictions, etc. These can serve as additional filters during retrieval. If this sounds confusing, let's clarify with an example.</p> 
</div> 
<div class="readable-text  intended-text" refid="99" id="99" data-hash="95acc570e146fe39236f0899aac88182"> 
<p>Imagine the user query is, "What were the Q2 estimated sales?", as shown in figure 3.9. From this question, we can immediately tell it's related to finance. Looking closer, we'd identify that this question can be answered by examining the "Quarterly Sales Report." By filtering our data based on this metadata, we drastically reduce our search space from thousands of data points to just a few—specifically, the chunks from the file "Quarterly Sales Report." Now we can perform our semantic search to retrieve the most relevant chunks. Metadata can also be used to provide sources during inference, allowing users to verify the information if they're unsure about the response.</p> 
</div> 
<div class="browsable-container figure-container" refid="100" id="100" data-hash="bc9385ca97a9045d33fec25b26659863"> 
<h5>Figure 3.9 Applying metadata filters reduce our search space drastically</h5> 
<img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image008.png" data-alt="Title: dimensions:[378x134.25] - Description: 039.png" loading="lazy" width="1200" height="425" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image008.png" class="medium-zoom-image"> 
</div> 
<div class="readable-text " refid="101" id="101" data-hash="11e57d5ef3c8b85e9f216d813e9b9e2f"> 
<p>Metadata extraction can be performed either using LLMs or explicitly, depending on the structure of your data. Suppose you have structured PDFs organized by chapters; you could simply extract those chapter names with a quick regex and use them as metadata. If you’re dealing with codebases, you might rely on code comments to guide your metadata creation. On the other hand, if your data is highly unstructured, you might run each chunk through an LLM, prompting it to produce a metadata-rich JSON output for each piece of text. Just keep in mind that this step can be computationally expensive.</p> 
</div> 
<div class="readable-text  intended-text" refid="102" id="102" data-hash="caece5f4f9c01d14992e0c944ed843e0"> 
<p>Once you’ve settled on a metadata strategy, you’ll need to store both embeddings and metadata together in a vector database. One popular open-source vector database is Qdrant. Think of Qdrant as a specialized storage system designed for working with embeddings. Instead of just storing rows and columns, Qdrant stores data as vectors in a high-dimensional space, making it easy to find items that are conceptually similar. With Qdrant, you can attach extra information—like your metadata—to these embeddings using what they call “payloads.” Each data point is represented as a "point," and by pairing your vector embeddings with their metadata JSON, you form what Qdrant refers to as a PointStruct. In essence, Qdrant helps you keep your semantic representation and supplementary metadata together, setting the stage for rich, context-aware searches.</p> 
</div> 
<div class="readable-text  intended-text" refid="103" id="103" data-hash="e7c3fe85e0808ac6d5b8aa14e2f8ba4d"> 
<p>You can see this process in detail in figure 3.10:</p> 
</div> 
<div class="browsable-container figure-container" refid="104" id="104" data-hash="ded8d71a972e659f9e4a83179fe428ab"> 
<h5>Figure 3.10 Code process diagram for tagging vector embeddings with metadata</h5> 
<img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image009.png" data-alt="Title: dimensions:[197.95x489.6] - Description: 0310.png" loading="lazy" width="1200" height="2967" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image009.png" class="medium-zoom-image"> 
</div> 
<div class="readable-text " refid="105" id="105" data-hash="58b9bbb655b3628c738b951c5995168a"> 
<p>As figure 3.10 shows, we are required to tag each vector embedding with a metadata. Let’s go through the code and see how to implement this.</p> 
</div> 
<div class="browsable-container listing-container" refid="106" id="106" data-hash="39bda2090b06184ded16fe073ac5e2ff"> 
<h5>Listing 3.7 Tagging vector embeddings with metadata</h5> 
<div class="code-area-container"> 
<pre class="code-area">from qdrant_client import QdrantClient
from qdrant_client.http.models import PointStruct
from openai import OpenAI

qdrant_client = QdrantClient(url=QDRANT_URI, api_key=QDRANT_API_KEY)  #A

openai_client = OpenAI(api_key=OPENAI_API_KEY)  #B

def generate_keywords(chunk):  #C
try:
  response = openai_client.chat.completions.create(  #D
  model="gpt-4o-mini",  # Use the desired GPT model  #E
  messages=[
      {
           "role": "system",
           "content": "You are a tool that extracts concise keywords from a given text. Respond only with a plain list of keywords, each separated by commas."  #F
          },
          {
           "role": "user",
           "content": f"Extract keywords from this text chunk:\n{chunk}"  #G
          }
      ],
      temperature=0.5  #H
  )
  keywords = response.choices[0].message.content.strip()  #I
  keywords_list = [keyword.strip() for keyword in keywords.split(",") if keyword.strip()]  #J
  return keywords_list  #K
except Exception as e:  #L
  print(f"Error generating keywords: {e}")  #M
  return []  #N
</pre> 
<div class="code-annotations-overlay-container" data-annotations="I0EgSW5pdGlhbGl6ZSB0aGUgUWRyYW50IGNsaWVudCB3aXRoIHRoZSBwcm92aWRlZCBVUkkgYW5kIEFQSSBrZXksIGVuYWJsaW5nIGludGVyYWN0aW9ucyB3aXRoIHRoZSBRZHJhbnQgdmVjdG9yIGRhdGFiYXNlLgojQiBTZXQgdXAgdGhlIE9wZW5BSSBjbGllbnQgdXNpbmcgdGhlIHByb3ZpZGVkIEFQSSBrZXkgdG8gYWNjZXNzIE9wZW5BSSdzIEdQVCBtb2RlbHMuCiNDIERlZmluZSB0aGUgZ2VuZXJhdGVfa2V5d29yZHMgZnVuY3Rpb24gdG8gZXh0cmFjdCBrZXl3b3JkcyBmcm9tIGEgZ2l2ZW4gY2h1bmsgb2YgdGV4dCB1c2luZyB0aGUgT3BlbkFJIEdQVCBtb2RlbC4KI0QgVXNlIHRoZSBPcGVuQUkgQVBJIHRvIGNhbGwgdGhlIEdQVCBtb2RlbCBhbmQgZ2VuZXJhdGUga2V5d29yZHMgYmFzZWQgb24gdGhlIGlucHV0IHRleHQgY2h1bmsuCiNFIFNwZWNpZnkgdGhlIEdQVCBtb2RlbCB0byB1c2UgZm9yIHRoZSBrZXl3b3JkIGdlbmVyYXRpb24gKGUuZy4sICJncHQtNG8tbWluaSIpLgojRiBQcm92aWRlIGEgc3lzdGVtIGluc3RydWN0aW9uIHRvIHRoZSBHUFQgbW9kZWwsIGVuc3VyaW5nIGl0IGV4dHJhY3RzIGtleXdvcmRzIGluIHRoZSBkZXNpcmVkIGZvcm1hdCAocGxhaW4gbGlzdCBzZXBhcmF0ZWQgYnkgY29tbWFzKS4KI0cgUHJvdmlkZSB0aGUgdXNlciBpbnB1dCB0byB0aGUgbW9kZWwsIGNvbnRhaW5pbmcgdGhlIHRleHQgY2h1bmsgZnJvbSB3aGljaCBrZXl3b3JkcyBhcmUgdG8gYmUgZXh0cmFjdGVkLgojSCBTZXQgdGhlIHRlbXBlcmF0dXJlIHBhcmFtZXRlciB0byBjb250cm9sIHRoZSByYW5kb21uZXNzIG9mIHRoZSBvdXRwdXQ7IGxvd2VyIHZhbHVlcyBsaWtlIDAuNSBtYWtlIHRoZSBvdXRwdXQgbW9yZSBkZXRlcm1pbmlzdGljLgojSSBFeHRyYWN0IHRoZSByZXNwb25zZSBjb250ZW50IGZyb20gdGhlIEdQVCBtb2RlbCwgY29udGFpbmluZyB0aGUgZ2VuZXJhdGVkIGtleXdvcmRzLgojSiBTcGxpdCB0aGUgZ2VuZXJhdGVkIGtleXdvcmRzIHN0cmluZyBpbnRvIGEgbGlzdCwgdHJpbW1pbmcgd2hpdGVzcGFjZSBhbmQgcmVtb3ZpbmcgYW55IGVtcHR5IGVsZW1lbnRzLgojSyBSZXR1cm4gdGhlIGNsZWFuZWQgbGlzdCBvZiBrZXl3b3JkcyB0byB0aGUgY2FsbGVyLgojTCBDYXRjaCBhbnkgZXhjZXB0aW9ucyB0aGF0IG1heSBvY2N1ciBkdXJpbmcgdGhlIEFQSSBjYWxsIHRvIGhhbmRsZSBlcnJvcnMgZ3JhY2VmdWxseS4KI00gUHJpbnQgdGhlIGVycm9yIG1lc3NhZ2UgaWYgYW4gZXhjZXB0aW9uIGlzIGVuY291bnRlcmVkLCBoZWxwaW5nIGRlYnVnIGlzc3VlcyB3aXRoIGtleXdvcmQgZ2VuZXJhdGlvbi4KI04gUmV0dXJuIGFuIGVtcHR5IGxpc3QgYXMgYSBmYWxsYmFjayB3aGVuIGFuIGVycm9yIG9jY3VycywgZW5zdXJpbmcgdGhlIGZ1bmN0aW9uIGhhcyBhIHNhZmUgZGVmYXVsdCBvdXRwdXQu"></div> 
</div> 
<div class="listing-environment-container">
<div class="listing-environment-toolbar">
<span class="listing-environment-runnable-script-container">
  
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
</span>
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
</span>
</span></div>
</div></div> 
<div class="readable-text " refid="107" id="107" data-hash="3540156bd7906ce1ab9689d52a07b89e"> 
<p>Once we tag our vector embeddings with metadata, the next step is to ingest these chunks in a vector database along with metadata (see figure 3.11). We use Qdrant’s payload data structure to add our metadata in a JSON format and push it to the vector database collection.</p> 
</div> 
<div class="browsable-container figure-container" refid="108" id="108" data-hash="509311f7d2e98f577ab77a11053e1225"> 
<h5>Figure 3.11 Ingesting chunks tagged with metadata into vector database</h5> 
<img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image010.png" data-alt="Title: dimensions:[257.4x493.95] - Description: 0311.png" loading="lazy" width="1200" height="2303" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image010.png" class="medium-zoom-image"> 
</div> 
<div class="readable-text " refid="109" id="109" data-hash="1328b2c535efbfa866b4157713e2ccae"> 
<p>Now we understand the process of ingesting chunks along with tagged metadata to vector database. Let’s go through the code to see how to tag each chunk with metadata.</p> 
<div class="paragraph-bubble" data-forums-active="true" data-comment-ids="577524">
  <div aria-haspopup="true" class="text-margin-icon-bubble bookmark-bubble" title="bookmark"><i class="fa fa-bookmark"></i></div>
  <div aria-haspopup="true" class="text-margin-icon-bubble forums-bubble" title="open discussion"><i class="fa fa-comments" aria-hidden="true"></i><span class="comment-count-container">1</span></div>
  <div aria-haspopup="true" class="text-margin-icon-bubble paragraph-notification-bubble" title="show text addons"><i class="fa fa-dot-circle" aria-hidden="true"></i></div>
   <div aria-haspopup="true" class="text-margin-icon-bubble live-chapter-bubble" title="activate interactive feature"><svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M.18216 26.4444H5.84882C5.71797 26.4421 5.58982 26.4068 5.47624 26.3417C5.36267 26.2767 5.26734 26.184 5.1991 26.0724C5.13085 25.9607 5.09189 25.8336 5.08582 25.7029C5.07975 25.5721 5.10677 25.442 5.16438 25.3244L9.76105 16.3333H4.6666C4.52643 16.3345 4.38856 16.2978 4.26755 16.227C4.14654 16.1563 4.0469 16.0541 3.97916 15.9314C3.91143 15.8087 3.87811 15.67 3.88275 15.5299C3.88738 15.3898 3.92979 15.2535 4.00549 15.1356L12.3122 1.91333C12.3803 1.80705 12.4732 1.71894 12.583 1.65661C12.6927 1.59428 12.816 1.5596 12.9422 1.55556H23.3877C23.543 1.54821 23.697 1.58758 23.8297 1.66858C23.9624 1.74958 24.0678 1.8685 24.1322 2.00999C24.1967 2.15147 24.2173 2.30903 24.1913 2.46233C24.1654 2.61563 24.0941 2.75763 23.9866 2.87L16.9399 10.8889H21.1244C21.2725 10.892 21.4167 10.9374 21.5399 11.0197C21.6632 11.102 21.7603 11.2178 21.82 11.3534C21.8796 11.489 21.8993 11.6389 21.8766 11.7853C21.854 11.9318 21.79 12.0687 21.6922 12.18L8.75771 26.18C8.6857 26.262 8.59723 26.3279 8.49807 26.3735C8.39891 26.419 8.29128 26.4432 8.18216 26.4444V26.4444ZM7.13994 24.8889H7.84771L19.3355 12.4444H15.2366C15.0813 12.4518 14.9273 12.4124 14.7946 12.3314C14.6619 12.2504 14.5565 12.1315 14.4921 11.99C14.4276 11.8485 14.407 11.691 14.433 11.5377C14.4589 11.3844 14.5303 11.2424 14.6377 11.13L21.6844 3.11111H13.3699L6.04327 14.7778H11.0444C11.1752 14.7801 11.3034 14.8155 11.417 14.8805C11.5305 14.9455 11.6259 15.0382 11.6941 15.1499C11.7624 15.2615 11.8013 15.3886 11.8074 15.5194C11.8135 15.6501 11.7864 15.7803 11.7288 15.8978L7.13994 24.8889Z" fill="#828282"></path>
  </svg></div>
   <div aria-haspopup="true" class="text-margin-icon-bubble live-test-thunder-chapter-bubble" title="activate liveTest"><svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M.18216 26.4444H5.84882C5.71797 26.4421 5.58982 26.4068 5.47624 26.3417C5.36267 26.2767 5.26734 26.184 5.1991 26.0724C5.13085 25.9607 5.09189 25.8336 5.08582 25.7029C5.07975 25.5721 5.10677 25.442 5.16438 25.3244L9.76105 16.3333H4.6666C4.52643 16.3345 4.38856 16.2978 4.26755 16.227C4.14654 16.1563 4.0469 16.0541 3.97916 15.9314C3.91143 15.8087 3.87811 15.67 3.88275 15.5299C3.88738 15.3898 3.92979 15.2535 4.00549 15.1356L12.3122 1.91333C12.3803 1.80705 12.4732 1.71894 12.583 1.65661C12.6927 1.59428 12.816 1.5596 12.9422 1.55556H23.3877C23.543 1.54821 23.697 1.58758 23.8297 1.66858C23.9624 1.74958 24.0678 1.8685 24.1322 2.00999C24.1967 2.15147 24.2173 2.30903 24.1913 2.46233C24.1654 2.61563 24.0941 2.75763 23.9866 2.87L16.9399 10.8889H21.1244C21.2725 10.892 21.4167 10.9374 21.5399 11.0197C21.6632 11.102 21.7603 11.2178 21.82 11.3534C21.8796 11.489 21.8993 11.6389 21.8766 11.7853C21.854 11.9318 21.79 12.0687 21.6922 12.18L8.75771 26.18C8.6857 26.262 8.59723 26.3279 8.49807 26.3735C8.39891 26.419 8.29128 26.4432 8.18216 26.4444V26.4444ZM7.13994 24.8889H7.84771L19.3355 12.4444H15.2366C15.0813 12.4518 14.9273 12.4124 14.7946 12.3314C14.6619 12.2504 14.5565 12.1315 14.4921 11.99C14.4276 11.8485 14.407 11.691 14.433 11.5377C14.4589 11.3844 14.5303 11.2424 14.6377 11.13L21.6844 3.11111H13.3699L6.04327 14.7778H11.0444C11.1752 14.7801 11.3034 14.8155 11.417 14.8805C11.5305 14.9455 11.6259 15.0382 11.6941 15.1499C11.7624 15.2615 11.8013 15.3886 11.8074 15.5194C11.8135 15.6501 11.7864 15.7803 11.7288 15.8978L7.13994 24.8889Z" fill="#828282"></path>
</svg></div>
  <div class="text-margin-icon-bubble editor-bubble"><i class="fa fa-edit fa-2x"></i></div>
</div></div> 
<div class="browsable-container listing-container" refid="110" id="110" data-hash="a4ff6b7c4108b9f6663e55ec1c799420"> 
<h5>Listing 3.8 Ingest chunks to vector database (with metadata)</h5> 
<div class="code-area-container"> 
<pre class="code-area"> 
from qdrant_client import QdrantClient
from qdrant_client.http.models import PointStruct

qdrant_client = QdrantClient(url=QDRANT_URI, api_key=QDRANT_API_KEY)  #A

def ingest_chunks_with_metadata_to_qdrant(all_chunks):  #B
try:
  collections = qdrant_client.get_collections()  #C
  if COLLECTION_NAME not in [col.name for col in collections.collections]:  #D
      qdrant_client.create_collection(  #E
          collection_name=COLLECTION_NAME,
          vectors_config={"size": 768, "distance": "Cosine"}  #F
      )
except Exception as e:  #G
  print("Error in collection handling:", e)  #H
  return  #I

points = []  #J
for i, item in enumerate(all_chunks):  #K
  chunk = item["chunk"]  #L
  keywords_list = generate_keywords(chunk)
  embedding = model.encode(chunk)  #M

  point = PointStruct(  #N
      id=i,
      vector=embedding,
      payload={
          "chunk": chunk,
          "keywords_list": keywords_list
      }
  )
  points.append(point)  #O
</pre> 
<div class="code-annotations-overlay-container" data-annotations="I0EgRGVmaW5lIHRoZSBpbmdlc3RfY2h1bmtzX3dpdGhfbWV0YWRhdGFfdG9fcWRyYW50IGZ1bmN0aW9uIHRvIHN0b3JlIHRleHQgY2h1bmtzLCBhbG9uZyB3aXRoIHRoZWlyIG1ldGFkYXRhLCBpbnRvIGEgUWRyYW50IGNvbGxlY3Rpb24uCiNCIEZldGNoIHRoZSBsaXN0IG9mIGV4aXN0aW5nIGNvbGxlY3Rpb25zIGluIHRoZSBRZHJhbnQgZGF0YWJhc2UgdG8gY2hlY2sgaWYgdGhlIHRhcmdldCBjb2xsZWN0aW9uIGV4aXN0cy4KI0MgVmVyaWZ5IGlmIHRoZSB0YXJnZXQgY29sbGVjdGlvbiAoQ09MTEVDVElPTl9OQU1FKSBpcyBhbHJlYWR5IHByZXNlbnQgaW4gdGhlIFFkcmFudCBkYXRhYmFzZS4KI0QgSWYgdGhlIGNvbGxlY3Rpb24gZG9lcyBub3QgZXhpc3QsIGNyZWF0ZSBpdCB3aXRoIHRoZSBzcGVjaWZpZWQgY29uZmlndXJhdGlvbi4KI0UgQ29uZmlndXJlIHRoZSBjb2xsZWN0aW9uIHdpdGggYSB2ZWN0b3Igc2l6ZSBvZiA3NjggKGUuZy4sIHR5cGljYWwgZW1iZWRkaW5nIHNpemUpIGFuZCB0aGUgQ29zaW5lIGRpc3RhbmNlIG1ldHJpYyBmb3Igc2ltaWxhcml0eSBzZWFyY2guCiNGIENhdGNoIGFueSBleGNlcHRpb25zIGR1cmluZyBjb2xsZWN0aW9uIGhhbmRsaW5nIHRvIHByZXZlbnQgdGhlIHByb2dyYW0gZnJvbSBjcmFzaGluZy4KI0cgUHJpbnQgYW4gZXJyb3IgbWVzc2FnZSBpZiB0aGVyZeKAmXMgYW4gaXNzdWUgd2l0aCBjb2xsZWN0aW9uIGNyZWF0aW9uIG9yIHJldHJpZXZhbC4KI0ggRXhpdCB0aGUgZnVuY3Rpb24gZWFybHkgaWYgYW4gZXhjZXB0aW9uIG9jY3VycyBkdXJpbmcgY29sbGVjdGlvbiBoYW5kbGluZy4KI0kgSW5pdGlhbGl6ZSBhbiBlbXB0eSBsaXN0IHRvIHN0b3JlIHRoZSBQb2ludFN0cnVjdCBvYmplY3RzIHJlcHJlc2VudGluZyB0aGUgY2h1bmtzIGFuZCB0aGVpciBtZXRhZGF0YS4KI0ogTG9vcCB0aHJvdWdoIGFsbCB0aGUgY2h1bmtzIGFuZCB0aGVpciBhc3NvY2lhdGVkIG1ldGFkYXRhIHByb3ZpZGVkIGluIGFsbF9jaHVua3MuCiNLIEV4dHJhY3QgdGhlIGNodW5rIHRleHQgZnJvbSB0aGUgY3VycmVudCBtZXRhZGF0YSBlbnRyeS4KI0wgRXh0cmFjdCB0aGUgYXNzb2NpYXRlZCBmaWxlbmFtZSBmcm9tIHRoZSBjdXJyZW50IG1ldGFkYXRhIGVudHJ5LgojTSBFeHRyYWN0IHRoZSBsaXN0IG9mIGtleXdvcmRzIGZyb20gdGhlIGN1cnJlbnQgbWV0YWRhdGEgZW50cnkuCiNOIEdlbmVyYXRlIHRoZSBlbWJlZGRpbmcgZm9yIHRoZSBjaHVuayB1c2luZyB0aGUgcHJlLXRyYWluZWQgU2VudGVuY2VUcmFuc2Zvcm1lciBtb2RlbC4KI08gQ3JlYXRlIGEgUG9pbnRTdHJ1Y3Qgb2JqZWN0IGZvciBlYWNoIGNodW5rLCBpbmNsdWRpbmcgaXRzIHZlY3RvciAoZW1iZWRkaW5nKSBhbmQgbWV0YWRhdGEgKHBheWxvYWQpLg=="></div> 
</div> 
<div class="listing-environment-container">
<div class="listing-environment-toolbar">
<span class="listing-environment-runnable-script-container">
  
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
</span>
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
</span>
</span></div>
</div></div> 
<div class="readable-text " refid="111" id="111" data-hash="8eb6e361f13219936122f1af8bc524ea"> 
<p>The final step: push to a vector database</p> 
</div> 
<div class="readable-text  intended-text" refid="112" id="112" data-hash="d6627883cfe1a5e090e1008d892ee0d3"> 
<p>Once our PointStruct is prepared with the payload, the final step is to upload it to Qdrant using the upsert operation. Upsert lets you batch-upload all your payload data to the vector database efficiently. If you find that the vectors you're uploading are larger than what fits into your machine's RAM, Qdrant offers a handy feature called "memmap" support. Think of memmap as a way to store data directly on the disk instead of in memory. Instead of holding everything in RAM, Qdrant creates a virtual address space that points to a file on disk, so whenever you need to access your vectors, the system can read them directly from the storage drive. This approach means you can handle much larger datasets without worrying about running out of memory—especially if you’re dealing with billions of vectors. To enable memmap, you can set the on_disk parameter when creating your collection, ensuring that vector data stays on disk at all times.</p> 
</div> 
<div class="readable-text  intended-text" refid="113" id="113" data-hash="33816d83efddb9117c1bd9e72f69c718"> 
<p>Behind the scenes, Qdrant splits each collection into shards, and each shard has its own Write-Ahead Log (WAL) that keeps track of operation order. By using multiple shards, you can parallelize the upload process, making it faster to handle large volumes of data. Usually, having two to four shards per machine works well.</p> 
</div> 
<div class="readable-text  intended-text" refid="114" id="114" data-hash="cd4bf0626b1eb7991764282e8227677d"> 
<p>While there are other vector databases out there, like Pinecone and Milvus, Qdrant stands out for several reasons. It's open-source, gives you a free 1 GB of cloud storage, and can even be hosted on your own server, giving you more control over your setup.</p> 
</div> 
<div class="readable-text  intended-text" refid="115" id="115" data-hash="889575f72451054e91b3bc70463851c4"> 
<p>In the listing 3.9, you'll see how we use Qdrant’s upsert function to push all the PointStruct objects—including their embeddings and metadata—into a Qdrant collection. First, though, the diagram in figure 3.12 shows how the following code will work.</p> 
</div> 
<div class="browsable-container figure-container" refid="116" id="116" data-hash="832484ec299381b7439d8423409350aa"> 
<h5>Figure 3.12 Pushing vector embeddings to Qdrant to make it searchable for inference</h5> 
<img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image011.png" data-alt="Title: dimensions:[241.9x493.35] - Description: 0312.png" loading="lazy" width="1200" height="2447" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/03__image011.png" class="medium-zoom-image"> 
</div> 
<div class="readable-text " refid="117" id="117" data-hash="47d5be15f9cb25aa55ea67c69dde4823"> 
<p>As evident in the flowchart in figure 3.12, all the PointStruct that we created using qdrant_client, needs to be pushed to Qdrant. Lets see how can we actually push our data-points (with or without metadata) to our Qdrant vector database.</p> 
</div> 
<div class="browsable-container listing-container" refid="118" id="118" data-hash="630509386f324670c5afe573d22aaa4a"> 
<h5>Listing 3.9 prepare chunks to ingest into vector database</h5> 
<div class="code-area-container"> 
<pre class="code-area">from qdrant_client import QdrantClient
from qdrant_client.http.models import PointStruct

qdrant_client = QdrantClient(url=QDRANT_URI, api_key=QDRANT_API_KEY)  #A

def ingest_chunks_without_metadata_to_qdrant(all_chunks):  #B
try:
  collections = qdrant_client.get_collections()  #C
  if COLLECTION_NAME not in [col.name for col in collections.collections]:  #D
      qdrant_client.create_collection(  #E
          collection_name=COLLECTION_NAME,
          vectors_config={"size": 768, "distance": "Cosine"}  #F
      )
except Exception as e:  #G
  print("Error in collection handling:", e)  #H
  return  #I

points = []  #J
for i, item in enumerate(all_chunks):  #K
  chunk = item["chunk"]  #L
  embedding = model.encode(chunk)  #M

  point = PointStruct(  #N
      id=i,
      vector=embedding,
      payload={
          "chunk": chunk,
      }
  )
  points.append(point)  #O

</pre> 
<div class="code-annotations-overlay-container" data-annotations="I0EgSW5pdGlhbGl6ZSB0aGUgUWRyYW50IGNsaWVudCB3aXRoIHRoZSBzcGVjaWZpZWQgVVJJIGFuZCBBUEkga2V5IGZvciBkYXRhYmFzZSBvcGVyYXRpb25zLgojQiBEZWZpbmUgdGhlIGluZ2VzdF9jaHVua3Nfd2l0aG91dF9tZXRhZGF0YV90b19xZHJhbnQgZnVuY3Rpb24gdG8gaW5nZXN0IHRleHQgY2h1bmtzIHdpdGhvdXQgbWV0YWRhdGEgaW50byBhIFFkcmFudCBjb2xsZWN0aW9uLgojQyBSZXRyaWV2ZSB0aGUgbGlzdCBvZiBleGlzdGluZyBjb2xsZWN0aW9ucyBmcm9tIHRoZSBRZHJhbnQgY2xpZW50LgojRCBDaGVjayBpZiB0aGUgdGFyZ2V0IGNvbGxlY3Rpb24gKENPTExFQ1RJT05fTkFNRSkgZXhpc3RzIGluIHRoZSBkYXRhYmFzZS4KI0UgQ3JlYXRlIGEgbmV3IGNvbGxlY3Rpb24gaW4gUWRyYW50IGlmIGl0IGRvZXNuJ3QgYWxyZWFkeSBleGlzdC4KI0YgQ29uZmlndXJlIHRoZSBjb2xsZWN0aW9uIHdpdGggYSB2ZWN0b3Igc2l6ZSBvZiA3NjggKGVtYmVkZGluZyBkaW1lbnNpb24pIGFuZCB1c2UgQ29zaW5lIGRpc3RhbmNlIGZvciBzaW1pbGFyaXR5IGNvbXB1dGF0aW9uLgojRyBIYW5kbGUgZXhjZXB0aW9ucyB0aGF0IG1heSBvY2N1ciBkdXJpbmcgY29sbGVjdGlvbiByZXRyaWV2YWwgb3IgY3JlYXRpb24uCiNIIFByaW50IGFuIGVycm9yIG1lc3NhZ2UgaWYgdGhlcmUgaXMgYW4gaXNzdWUgd2l0aCBjb2xsZWN0aW9uIGhhbmRsaW5nLgojSSBFeGl0IHRoZSBmdW5jdGlvbiBlYXJseSBpZiBhbiBleGNlcHRpb24gb2NjdXJzIGR1cmluZyBjb2xsZWN0aW9uIG9wZXJhdGlvbnMuCiNKIEluaXRpYWxpemUgYW4gZW1wdHkgbGlzdCB0byBzdG9yZSBQb2ludFN0cnVjdCBvYmplY3RzIGZvciBpbmdlc3Rpb24uCiNLIEl0ZXJhdGUgb3ZlciBhbGwgdGhlIGNodW5rcyBwcm92aWRlZCBpbiB0aGUgYWxsX2NodW5rcyBsaXN0LgojTCBFeHRyYWN0IHRoZSB0ZXh0IGNodW5rIGZyb20gdGhlIGN1cnJlbnQgZGF0YSBlbnRyeS4KI00gR2VuZXJhdGUgdGhlIGVtYmVkZGluZyBmb3IgdGhlIGNodW5rIHVzaW5nIHRoZSBwcmUtdHJhaW5lZCBtb2RlbC4KI04gQ3JlYXRlIGEgUG9pbnRTdHJ1Y3Qgb2JqZWN0LCBhc3NpZ25pbmcgYSB1bmlxdWUgSUQgYW5kIGVtYmVkZGluZyB2ZWN0b3IsIGFuZCBhZGQgdGhlIGNodW5rIGFzIHBheWxvYWQuCiNPIEFwcGVuZCB0aGUgUG9pbnRTdHJ1Y3Qgb2JqZWN0IHRvIHRoZSBsaXN0IG9mIHBvaW50cyBmb3IgYmF0Y2ggaW5nZXN0aW9uLg=="></div> 
</div> 
<div class="listing-environment-container">
<div class="listing-environment-toolbar">
<span class="listing-environment-runnable-script-container">
  
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
</span>
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
</span>
</span></div>
</div></div> 
<div class="readable-text " refid="119" id="119" data-hash="a06a28e2abc786fb28b38032814e7cc8"> 
<p>Since vector databases require all the data points in embeddings form, we use an encoder model to convert our data into vector embeddings. We need to configure Qdrant by specifying vector size, which is the size of our embeddings. We convert each data point into PointStruct which itself contains vector embeddings of our text-data. The next step is to push these data points to the vector database collection. Please add the following code just under the ”for” loop in listing 3.9. This code should execute immediately after the “for” loop is done.</p> 
</div> 
<div class="browsable-container listing-container" refid="120" id="120" data-hash="3ed9befcda47d37fd4bb7ec389c17b2a"> 
<h5>Listing 3.10 Upsert vector embeddings into vector database</h5> 
<div class="code-area-container"> 
<pre class="code-area"> 
try:
  qdrant_client.upsert(  #A
      collection_name=COLLECTION_NAME,
      points=points
  )
  print(f"Ingested {len(points)} chunks into Qdrant collection '{COLLECTION_NAME}' without metadata.")  #B
except Exception as e:  #C
  print(f"Error ingesting chunks: {e}")  #D
</pre> 
<div class="code-annotations-overlay-container" data-annotations="I0EgVXNlIHRoZSBRZHJhbnQgdXBzZXJ0IG9wZXJhdGlvbiB0byBpbnNlcnQgb3IgdXBkYXRlIHRoZSBwb2ludHMgaW4gdGhlIHNwZWNpZmllZCBjb2xsZWN0aW9uLgojQiBQcmludCBhIHN1Y2Nlc3MgbWVzc2FnZSBpbmRpY2F0aW5nIHRoZSBudW1iZXIgb2YgY2h1bmtzIGluZ2VzdGVkIHdpdGhvdXQgbWV0YWRhdGEuCiNDIENhdGNoIGFueSBleGNlcHRpb25zIHRoYXQgbWF5IG9jY3VyIGR1cmluZyB0aGUgdXBzZXJ0IG9wZXJhdGlvbi4KI0QgUHJpbnQgYW4gZXJyb3IgbWVzc2FnZSBpZiB0aGVyZSBpcyBhbiBpc3N1ZSB3aXRoIGNodW5rIGluZ2VzdGlvbi4="></div> 
</div> 
<div class="listing-environment-container">
<div class="listing-environment-toolbar">
<span class="listing-environment-runnable-script-container">
  
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
</span>
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
</span>
</span></div>
</div></div> 
<div class="readable-text " refid="121" id="121" data-hash="367cfc56e736650b4cfaeb50cf67f27f"> 
<p>Now that we have all our pieces in place, let’s put them all together in one script. This script will: extract information from a PDF, convert that information into chunks, embed each chunk, and upsert it to Qdrant.</p> 
</div> 
<div class="browsable-container listing-container" refid="122" id="122" data-hash="1d2adcca4d32524865362ff8d6b55739"> 
<h5>Listing 3.11 Tie it all together</h5> 
<div class="code-area-container"> 
<pre class="code-area">if __name__ == "__main__":
pdf_path = "my_document.pdf"  #A
CHUNK_SIZE = 500  #A
OVERLAP = 50   #A

pdf_text = extract_text_from_pdf(pdf_path)  #B

chunks = fixed_size_chunking_with_overlap(  #C
pdf_text,
chunk_size=CHUNK_SIZE,
overlap=OVERLAP
)

all_chunks = [{"chunk": c} for c in chunks]  #D

ingest_chunks_without_metadata_to_qdrant(all_chunks)  #E

print(f"Done. Ingested {len(all_chunks)} chunks from {pdf_path} into Qdrant.")</pre> 
<div class="code-annotations-overlay-container" data-annotations="I0EgU2V0IHlvdXIgUERGIGZpbGUgcGF0aCBhbmQgZGVzaXJlZCBjaHVua2luZyBwYXJhbWV0ZXJzCiNCIEV4dHJhY3QgdGV4dCBmcm9tIHRoZSBQREYKI0MgQnJlYWsgdGhlIHRleHQgaW50byBvdmVybGFwcGluZyBjaHVua3MKI0QgQ29udmVydCBlYWNoIGNodW5rIHRvIHRoZSBkaWN0IGZvcm1hdCBleHBlY3RlZCBieSB5b3VyIGluZ2VzdCBmdW5jdGlvbgojRSBJbmdlc3QgY2h1bmtzIGludG8gUWRyYW50ICh0aGlzIGZ1bmN0aW9uIHdpbGwgZW5jb2RlIGFuZCB1cHNlcnQp"></div> 
</div> 
<div class="listing-environment-container">
<div class="listing-environment-toolbar">
<span class="listing-environment-runnable-script-container">
  
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
</span>
<span class="listing-environment-standard-mode-container">
    <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
      <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
        <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
      </svg>
    </a>
</span>
</span></div>
</div></div> 
<div class="readable-text " refid="123" id="123" data-hash="cb652804a4c2b5b2a218860cfe05d576"> 
<p>Once all the data is pushed to Qdrant, our data points are ready for search. You might be wondering why we went through all these steps just to ingest data into a database. As we look into the search functions in the upcoming chapters, the true value of this engineering effort will become clear, and you'll experience the magic it enables during retrieval.</p> 
</div> 

<div class="readable-text" refid="124" id="124" data-hash="8ec378270e450ea73220a175f658218a"> 
<h2>3.6 Summary</h2> 
</div> 
<ul> 
<li class="readable-text" refid="125" id="125" data-hash="f16149521c032446f05aa2ca2453de76">In real-world scenarios, raw data can be unstructured, so it needs to be preprocessed before being converted into embeddings and ingested into a vector database.</li> 
<li class="readable-text" refid="126" id="126" data-hash="9d8ea9f9c1ea7b7adb142d869dfc5e35">We build separate ETL pipelines for different kinds of data, extracting text while retaining its structure. This text is then converted into vector embeddings using a pre-trained embedding model.</li> 
<li class="readable-text" refid="127" id="127" data-hash="90e082dff8d64979082343a8a8663c29">Cosine similarity is a statistical method to calculate distances between two vectors (two texts phrases converted to vector embeddings in our case) in a vector space.</li> 
<li class="readable-text" refid="128" id="128" data-hash="381b2c0c2ded353efe18ab4a965fe03d">Cosine distance determines semantic similarity between two sentences or phrases. The smaller the distance, the more similarity they have.</li> 
<li class="readable-text" refid="129" id="129" data-hash="532ae6dbdbef959d7d303e1180ebbc2a">Semantic chunking aims to introduce breakpoints where it recognizes slight changes in the semantics of consecutive sentences.</li> 
<li class="readable-text" refid="130" id="130" data-hash="4321078e8d0e055e09f69f6946b2d642">Metadata tagging makes retrieval more relevant and also helps provide sources and other useful information to the user during inference.</li> 
<li class="readable-text" refid="131" id="131" data-hash="2fbb805e146b0e06bc20a015d068744d">Once our data is prepared in pairs of vector embeddings and metadata, we push it to the vector database using specific functions, making it ready for search.</li> 
<li class="readable-text" refid="132" id="132" data-hash="b5e8562410190091fbe6371274a79a67">Vector database allows us to search through our data in a semantic manner, going beyond traditional keyword-based searching.</li> 
</ul></div>
          <div id="right-margin-column"></div>
          <div id="right-margin-menu-column"></div>
      </div>
    </div>

    <div class="large-12 columns">
        <div id="book-main-content-container" style="" class="">
            <div id="track-point-column" class="hidden">
                <div class="track-point-wrapper" id="pointing-start-point">
                    <i class="fal fa-level-down fa-flip-horizontal" aria-hidden="true"></i>
                </div>
                <div class="track-point-wrapper" id="pointing-end-point">
                    <i class="fal fa-level-up fa-flip-horizontal" aria-hidden="true"></i>
                </div>
                <div class="track-point-wrapper" id="play-point">
                    <div class="track-point">
                        <i class="icon-i-play-triangle"></i>
                    </div>
                </div>
                <div class="track-point-wrapper" id="current-position-point">
                    <div class="track-point">
                        <div class="track-point-play">
                            <i></i>
                        </div>
                    </div>
                </div>
                <div class="track-point-wrapper" id="off-screen-position-point">
                    <div class="track-point">
                        <div class="off-screen-position-point-arrow-container">
                            <i class=""></i>
                        </div>
                    </div>
                </div>
                <div class="track-point-wrapper" id="restart-paragraph-point">
                    <div class="track-point">
                        <i class="fa fa-redo"></i>
                    </div>
                </div>
            </div>
            <div id="book-markup-container"><div class="readable-text " refid="1" id="1" data-hash="51435a83d7f0284009b919c002f2c50c"> 
    <h1><span class="chapter-title-numbering"><span class="num-string">4</span></span> Search service ingestion</h1> 

    <div class="book-element-head-commands">
    <div class="_left">
        <button class="_head-icon-container _audio-icon" title="play audio">
            <i class="fa fa-play"></i>
        </button>
        <button class="_head-icon-container _generate-audio-icon _edit-audio-icon" title="generate audio">
            <i class="fa fa-microphone"></i>
            <i class="fa fa-cog"></i>
        </button>
        <button class="_head-icon-container _join-audio-icon _edit-audio-icon" title="join audio">
            <i class="fa fa-microphone"></i>
            <i class="fa fa-plus"></i>
        </button>
        <button class="_head-icon-container _create-timeline-icon _edit-audio-icon" title="create timeline">
            <i class="fa fa-stream"></i>
        </button>
        <button class="_head-icon-container _generate-subtitles-icon _edit-audio-icon" title="generate subtitles">
            <i class="fa fa-closed-captioning"></i>
            <i class="fa fa-cog"></i>
        </button>
        <button class="_head-icon-container _discussions-icon" title="discussions"><div class="_label">1</div>
            <svg width="25" height="23" viewBox="0 0 25 23" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M0.443717 21.8455C0.536061 21.8944 0.636353 21.9481 0.832775 21.9481C1.45724 21.9473 3.05396 21.4122 8.43833 18.5071C8.75926 18.5794 8.93676 18.6335 9.18087 18.7088L9.54306 18.8182C9.95217 18.9363 10.3753 18.7051 10.4953 18.3009C10.6141 17.8982 10.3813 17.4743 9.97601 17.3555L9.63351 17.2529C9.30992 17.1541 9.0556 17.0754 8.47466 16.9581C8.29678 16.921 8.11361 16.949 7.95465 17.0349C6.09717 18.0397 3.99065 19.1123 2.54153 19.7776C2.76103 19.4949 2.98508 19.2114 3.17696 18.9681C4.83273 16.8703 5.21157 16.3242 5.1355 15.7746C5.10749 15.571 4.96973 15.336 4.80321 15.2138C2.72016 13.6954 1.57229 11.6608 1.57229 9.48537C1.57229 5.09522 6.30116 1.52368 12.1136 1.52368C17.926 1.52368 22.6548 5.09522 22.6548 9.48499C22.6548 9.90622 22.9985 10.2472 23.4208 10.2472C23.844 10.2472 24.1876 9.9066 24.1876 9.48499C24.1876 4.25542 18.7707 0 12.1128 0C5.45492 0 0.0391419 4.25542 0.0391419 9.48499C0.0391419 11.9514 1.27028 14.3304 3.43848 16.0903C3.10846 16.5861 2.4454 17.4251 1.97005 18.0276C0.257892 20.1977 -0.0993748 20.7166 0.0213542 21.2831C0.0679049 21.5034 0.244646 21.7392 0.443717 21.8455Z" fill="currentColor"></path>
                <path d="M24.1695 15.4458C24.1695 12.6649 21.336 10.4028 17.853 10.4028C14.3704 10.4028 11.5369 12.6653 11.5369 15.4458C11.5369 18.1473 14.2096 20.3594 17.5555 20.4843C18.1982 21.0164 20.0931 22.3524 23.3244 22.7619C23.3566 22.7656 23.3922 22.7679 23.4243 22.7679C23.6998 22.7679 23.9682 22.6146 24.1044 22.3773C24.3728 21.9137 24.2074 21.6348 23.2957 20.0869C23.0792 19.719 22.7616 19.1786 22.5648 18.8119C23.5916 17.893 24.1695 16.6921 24.1695 15.4458ZM21.2111 17.944C20.5439 18.4292 20.8746 18.9916 21.9722 20.8555C21.9949 20.8942 22.0168 20.9316 22.0414 20.971C19.6091 20.3522 18.4082 19.2021 18.3965 19.1911C18.2527 19.0476 18.0566 18.9663 17.853 18.9663C15.2159 18.9663 13.0704 17.387 13.0704 15.4458C13.0704 13.5051 15.2159 11.9261 17.853 11.9261C20.4905 11.9261 22.6368 13.5051 22.6368 15.4458C22.6364 16.3867 22.1292 17.2746 21.2111 17.944Z" fill="currentColor"></path>
            </svg>
        </button>
        
        <button class="_head-icon-container _share-icon" title="share">
            <svg width="25" height="24" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4.22095 12V20C4.22095 20.5304 4.43166 21.0391 4.80673 21.4142C5.18181 21.7893 5.69051 22 6.22095 22H18.2209C18.7514 22 19.2601 21.7893 19.6352 21.4142C20.0102 21.0391 20.2209 20.5304 20.2209 20V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M16.2209 6L12.2209 2L8.22095 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12.2209 2V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
        
        <button class="_head-icon-container _livecards-icon hidden" title="livecards deck start">
            <svg class="add-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21.25 15.38C21.25 15.38 21.22 15.4 21.21 15.4C21.23 15.4 21.24 15.38 21.25 15.38Z" fill="white"></path>
                <path d="M22.05 5.45001L22.41 7.65001L22.05 5.45001C21.79 3.87001 20.36 2.79001 18.79 2.92001C20.36 2.80001 21.79 3.88001 22.05 5.45001V5.45001Z" fill="white"></path>
                <path d="M4.91 18.06C4.86 18.06 4.81 18.06 4.75 18.05C4.8 18.05 4.85 18.06 4.91 18.06Z" fill="white"></path>
                <path d="M2.17001 16.17C2.17001 16.17 2.15001 16.13 2.14001 16.1C2.14001 16.12 2.16001 16.14 2.17001 16.17Z" fill="white"></path>
                <path d="M4.36001 18C4.31001 17.99 4.25001 17.98 4.20001 17.96C4.25001 17.97 4.31001 17.99 4.36001 18Z" fill="white"></path>
                <path d="M3.79999 17.82C3.79999 17.82 3.71999 17.79 3.67999 17.77C3.71999 17.79 3.75999 17.8 3.79999 17.82Z" fill="white"></path>
                <path d="M18.97 17.85C18.82 19.06 17.8 20 16.56 20C16.56 20 6.1 20 5.8 20C5.5 20 5.27 20 5 20C4.65 20 4.29 20.02 3.96 19.95H3.95C3.27 19.8 2.62 19.53 2.05 19.12C0.94 18.33 0.22 17.16 0 15.83V17.56C0 20.01 1.99 22 4.44 22H16.56C19.01 22 21 20.01 21 17.56V17.52C21 17.52 20.95 17.53 20.93 17.54L18.97 17.86V17.85Z" fill="currentColor"></path>
                <path d="M4.56001 5.20999L3.42001 5.39999C3.42001 5.39999 3.40001 5.39999 3.39001 5.39999C3.40001 5.39999 3.41001 5.39999 3.42001 5.39999L4.56001 5.20999Z" fill="currentColor"></path>
                <path d="M0.940002 7.7C0.940002 7.7 0.960002 7.65 0.960002 7.63C0.960002 7.65 0.940002 7.68 0.940002 7.7Z" fill="currentColor"></path>
                <path d="M1.14001 7.13999C1.14001 7.13999 1.15001 7.11999 1.16001 7.10999C1.16001 7.11999 1.15001 7.12999 1.14001 7.13999Z" fill="currentColor"></path>
                <path d="M0.859985 8.29001C0.859985 8.29001 0.869985 8.21001 0.879985 8.17001C0.879985 8.21001 0.869985 8.25001 0.859985 8.29001Z" fill="currentColor"></path>
                <path d="M1.79001 6.22C1.79001 6.22 1.81001 6.2 1.82001 6.19C1.82001 6.19 1.80001 6.21 1.79001 6.22Z" fill="currentColor"></path>
                <path d="M2.23001 5.87999C2.23001 5.87999 2.27001 5.84999 2.29001 5.82999C2.27001 5.83999 2.25001 5.85999 2.23001 5.87999Z" fill="currentColor"></path>
                <path d="M2.72 5.61C2.72 5.61 2.79 5.57 2.83 5.56C2.79 5.57 2.76 5.6 2.72 5.61Z" fill="currentColor"></path>
                <path d="M1.25 11.06L1.98 15.51C1.98 15.51 1.99 15.54 1.99 15.56C1.99 15.54 1.98 15.53 1.98 15.51L1.25 11.06V11.06Z" fill="currentColor"></path>
                <path d="M18.79 2.91999C18.71 2.91999 18.63 2.91999 18.54 2.93999L4.56001 5.20999L3.42001 5.39999C3.42001 5.39999 3.40001 5.39999 3.39001 5.39999C3.20001 5.42999 3.01001 5.47999 2.83001 5.54999C2.79001 5.55999 2.76001 5.58999 2.72001 5.59999C2.57001 5.65999 2.43001 5.72999 2.29001 5.80999C2.27001 5.81999 2.25001 5.83999 2.23001 5.85999C2.09001 5.95999 1.95001 6.05999 1.82001 6.16999C1.82001 6.16999 1.80001 6.18999 1.79001 6.19999C1.53001 6.44999 1.31001 6.74999 1.15001 7.08999C1.15001 7.09999 1.14001 7.10999 1.13001 7.11999C1.06001 7.27999 1.00001 7.43999 0.960006 7.60999C0.960006 7.62999 0.940006 7.65999 0.940006 7.67999C0.900006 7.83999 0.890006 7.99999 0.870006 8.15999C0.870006 8.19999 0.860006 8.23999 0.850006 8.27999C0.850006 8.47999 0.850006 8.68999 0.890006 8.88999L1.24001 11.05L1.97001 15.5C1.97001 15.5 1.98001 15.53 1.98001 15.55C2.01001 15.74 2.06001 15.92 2.13001 16.09C2.13001 16.11 2.15001 16.13 2.16001 16.16C2.45001 16.87 3.00001 17.44 3.67001 17.76C3.71001 17.78 3.75001 17.79 3.79001 17.81C3.92001 17.86 4.05001 17.91 4.18001 17.95C4.23001 17.96 4.29001 17.98 4.34001 17.99C4.47001 18.02 4.60001 18.04 4.74001 18.05C4.79001 18.05 4.84001 18.06 4.90001 18.06C5.09001 18.06 5.28001 18.06 5.47001 18.02L20.6 15.55C20.81 15.52 21.01 15.46 21.19 15.39C21.21 15.39 21.22 15.37 21.23 15.37C22.34 14.93 23.09 13.87 23.15 12.68C23.15 12.46 23.15 12.26 23.11 12.05L22.39 7.64999L22.03 5.44999C21.77 3.86999 20.34 2.79999 18.77 2.91999H18.79ZM3.95001 15.19L2.87001 8.57999C2.83001 8.29999 2.89001 8.01999 3.05001 7.79999C3.21001 7.56999 3.46001 7.41999 3.73001 7.37999L18.86 4.90999C18.92 4.90999 18.97 4.89999 19.03 4.89999C19.54 4.89999 19.98 5.26999 20.07 5.77999L21.15 12.39C21.24 12.96 20.85 13.5 20.28 13.6L5.15001 16.07C4.87001 16.12 4.59001 16.05 4.37001 15.89C4.14001 15.73 3.99001 15.48 3.95001 15.21V15.19Z" fill="currentColor"></path>
                <path d="M4.49001 9.268L17.34 6.998C17.61 6.948 17.79 6.688 17.75 6.418C17.7 6.148 17.44 5.958 17.17 6.008L4.32001 8.278C4.05001 8.328 3.87001 8.588 3.91001 8.858C3.95001 9.098 4.16001 9.268 4.40001 9.268C4.43001 9.268 4.46001 9.268 4.49001 9.268V9.268Z" fill="currentColor"></path>
                <path d="M13.88 9.478C13.83 9.208 13.58 9.028 13.3 9.068L4.73002 10.528C4.46002 10.578 4.27002 10.828 4.32002 11.108C4.36002 11.348 4.57001 11.528 4.81001 11.528C4.84001 11.528 4.87001 11.528 4.89001 11.528L13.46 10.068C13.73 10.018 13.92 9.768 13.87 9.488L13.88 9.478Z" fill="currentColor"></path>
                <path d="M5.51001 14.158L16.93 12.288C17.2 12.248 17.39 11.988 17.34 11.718C17.3 11.448 17.04 11.258 16.77 11.308L5.35001 13.178C5.08001 13.218 4.89001 13.478 4.94001 13.748C4.98001 13.998 5.19001 14.168 5.43001 14.168C5.46001 14.168 5.48001 14.168 5.51001 14.168V14.158Z" fill="currentColor"></path>
            </svg>
        </button>
        <button class="_head-icon-container _ask-manning-icon hidden" title="ask manning">
            <svg width="29" height="29" viewBox="0 0 29 29" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M0.431152 5.56144C0.431152 2.98412 2.52049 0.894775 5.09782 0.894775H23.7645C26.3418 0.894775 28.4312 2.98412 28.4312 5.56144V24.2281C28.4312 26.8054 26.3418 28.8948 23.7645 28.8948H5.09782C2.52049 28.8948 0.431152 26.8054 0.431152 24.2281V5.56144ZM5.09782 2.76144C3.55142 2.76144 2.29782 4.01504 2.29782 5.56144V24.2281C2.29782 25.7745 3.55142 27.0281 5.09782 27.0281H23.7645C25.3108 27.0281 26.5645 25.7745 26.5645 24.2281V5.56144C26.5645 4.01504 25.3108 2.76144 23.7645 2.76144H5.09782Z" fill="#4087D4"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M11.5346 10.744C11.3765 10.4278 11.0534 10.228 10.6998 10.228C10.3463 10.228 10.0231 10.4278 9.86504 10.744L6.13171 18.2106C5.90117 18.6717 6.08804 19.2323 6.54909 19.4628C7.01014 19.6933 7.57078 19.5065 7.80129 19.0454L8.47667 17.6947H12.923L13.5984 19.0454C13.8289 19.5065 14.3895 19.6933 14.8505 19.4628C15.3116 19.2323 15.4985 18.6717 15.2679 18.2106L11.5346 10.744ZM11.9897 15.828L10.6998 13.2483L9.41 15.828H11.9897Z" fill="#4087D4"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M20.0295 10.228C20.5449 10.228 20.9629 10.6459 20.9629 11.1614V18.628C20.9629 19.1434 20.5449 19.5614 20.0295 19.5614C19.5141 19.5614 19.0962 19.1434 19.0962 18.628V11.1614C19.0962 10.6459 19.5141 10.228 20.0295 10.228Z" fill="#4087D4"></path>
            </svg>
        </button>
        <button class="_head-icon-container _reading-list-icon hidden" title="manage in reading list">
            <svg class="add-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 10.111C20 10.6633 19.5523 11.111 19 11.111H11.1111V19C11.1111 19.5523 10.6634 20 10.1111 20H9.8889C9.33662 20 8.8889 19.5523 8.8889 19V11.111H1C0.447717 11.111 0 10.6633 0 10.111V9.88883C0 9.33654 0.447715 8.88883 1 8.88883H8.8889V1C8.8889 0.447715 9.33662 0 9.8889 0H10.1021C10.6579 0 11.1071 0.45318 11.1021 1.00893L11.0317 8.88883H19C19.5523 8.88883 20 9.33654 20 9.88883V10.111Z" fill="currentColor"></path>
            </svg>

            <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="25" height="23" viewBox="0 0 448 512">
                <path d="M443.3 100.7C449.6 106.9 449.6 117.1 443.3 123.3L171.3 395.3C165.1 401.6 154.9 401.6 148.7 395.3L4.686 251.3C-1.562 245.1-1.562 234.9 4.686 228.7C10.93 222.4 21.06 222.4 27.31 228.7L160 361.4L420.7 100.7C426.9 94.44 437.1 94.44 443.3 100.7H443.3z" fill="currentColor"></path>
            </svg>
        </button>
    </div>
    <div class="_right">
        <div class="_date-container" data-tooltip-y-offset="10" data-more-info="<div class='date-popup-container'><div>livebook updated March 2025</div><div>Publication estimate October 2025</div></div>"><span class="hide-small">MEAP</span> v1</div>
        <button class="_head-icon-container _subscription-cart-button hidden" title="cart">
            buy <span class="hide-small">the book</span>
        </button>
    </div>
    </div></div> 
    <div class="introduction-summary"> 
    <h3>This chapter covers</h3> 
    <ul> 
    <li class="readable-text" refid="2" id="2" data-hash="5fcfac2bbf07406814135ce3580a8963">Preparing structured data like SQL records for uploading to a search engine</li> 
    <li class="readable-text" refid="3" id="3" data-hash="e7b06fbdd6c7bf23a1d0aeabab878073">Building the search engine and uploading the processed records</li> 
    <li class="readable-text" refid="4" id="4" data-hash="2f6d9f708514af3595a4d9406b8f8e84">Building a hybrid search function to search the records by vector and keywords</li> 
    <li class="readable-text" refid="5" id="5" data-hash="a719e8262281466238f4d0f6f0a41b58">Assessing which search services to use and which ones to avoid</li> 
    </ul> 
    </div> 
    <div class="readable-text " refid="6" id="6" data-hash="ed07a1ef77b1f5367b84d479a2a4d7cc"> 
    <p>Welcome to Chapter 4! In the last chapter, we ventured into the realm of vector databases, breaking down PDFs into chunks, vectorizing their content, and storing it all for future retrieval. Vector databases certainly have their place and can be quite powerful. However, they often lack full-featured text search capabilities, requiring a separate solution for keyword queries. Moreover, even the best embedding models are only about 60% accurate for retrieval, which might limit their effectiveness in building Retrieval Augmented Generation (RAG) systems (see <a href="https://huggingface.co/spaces/mteb/leaderboard">https://huggingface.co/spaces/mteb/leaderboard</a>).</p> 
    </div> 
    <div class="readable-text  intended-text" refid="7" id="7" data-hash="cc0dc3138426cdef87e5355755ad6668"> 
    <p>If you want to build an effective RAG system, you can’t use just vector search, or just text search; you have to use both. Vector search provides the flexibility while text search provides the precision. If you’ve already tried the methods in the last chapter and still aren’t seeing the search results you need, it might be worth exploring a text search service like Azure AI Search, Amazon OpenSearch, or Google Cloud Search. While our tutorials will be using Azure</p> 
    <div class="paragraph-bubble" data-forums-active="true" data-comment-ids="577746">
    <div aria-haspopup="true" class="text-margin-icon-bubble bookmark-bubble" title="bookmark"><i class="fa fa-bookmark"></i></div>
    <div aria-haspopup="true" class="text-margin-icon-bubble forums-bubble" title="open discussion"><i class="fa fa-comments" aria-hidden="true"></i><span class="comment-count-container">1</span></div>
    <div aria-haspopup="true" class="text-margin-icon-bubble paragraph-notification-bubble" title="show text addons"><i class="fa fa-dot-circle" aria-hidden="true"></i></div>
    <div aria-haspopup="true" class="text-margin-icon-bubble live-chapter-bubble" title="activate interactive feature"><svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M.18216 26.4444H5.84882C5.71797 26.4421 5.58982 26.4068 5.47624 26.3417C5.36267 26.2767 5.26734 26.184 5.1991 26.0724C5.13085 25.9607 5.09189 25.8336 5.08582 25.7029C5.07975 25.5721 5.10677 25.442 5.16438 25.3244L9.76105 16.3333H4.6666C4.52643 16.3345 4.38856 16.2978 4.26755 16.227C4.14654 16.1563 4.0469 16.0541 3.97916 15.9314C3.91143 15.8087 3.87811 15.67 3.88275 15.5299C3.88738 15.3898 3.92979 15.2535 4.00549 15.1356L12.3122 1.91333C12.3803 1.80705 12.4732 1.71894 12.583 1.65661C12.6927 1.59428 12.816 1.5596 12.9422 1.55556H23.3877C23.543 1.54821 23.697 1.58758 23.8297 1.66858C23.9624 1.74958 24.0678 1.8685 24.1322 2.00999C24.1967 2.15147 24.2173 2.30903 24.1913 2.46233C24.1654 2.61563 24.0941 2.75763 23.9866 2.87L16.9399 10.8889H21.1244C21.2725 10.892 21.4167 10.9374 21.5399 11.0197C21.6632 11.102 21.7603 11.2178 21.82 11.3534C21.8796 11.489 21.8993 11.6389 21.8766 11.7853C21.854 11.9318 21.79 12.0687 21.6922 12.18L8.75771 26.18C8.6857 26.262 8.59723 26.3279 8.49807 26.3735C8.39891 26.419 8.29128 26.4432 8.18216 26.4444V26.4444ZM7.13994 24.8889H7.84771L19.3355 12.4444H15.2366C15.0813 12.4518 14.9273 12.4124 14.7946 12.3314C14.6619 12.2504 14.5565 12.1315 14.4921 11.99C14.4276 11.8485 14.407 11.691 14.433 11.5377C14.4589 11.3844 14.5303 11.2424 14.6377 11.13L21.6844 3.11111H13.3699L6.04327 14.7778H11.0444C11.1752 14.7801 11.3034 14.8155 11.417 14.8805C11.5305 14.9455 11.6259 15.0382 11.6941 15.1499C11.7624 15.2615 11.8013 15.3886 11.8074 15.5194C11.8135 15.6501 11.7864 15.7803 11.7288 15.8978L7.13994 24.8889Z" fill="#828282"></path>
    </svg></div>
    <div aria-haspopup="true" class="text-margin-icon-bubble live-test-thunder-chapter-bubble" title="activate liveTest"><svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M.18216 26.4444H5.84882C5.71797 26.4421 5.58982 26.4068 5.47624 26.3417C5.36267 26.2767 5.26734 26.184 5.1991 26.0724C5.13085 25.9607 5.09189 25.8336 5.08582 25.7029C5.07975 25.5721 5.10677 25.442 5.16438 25.3244L9.76105 16.3333H4.6666C4.52643 16.3345 4.38856 16.2978 4.26755 16.227C4.14654 16.1563 4.0469 16.0541 3.97916 15.9314C3.91143 15.8087 3.87811 15.67 3.88275 15.5299C3.88738 15.3898 3.92979 15.2535 4.00549 15.1356L12.3122 1.91333C12.3803 1.80705 12.4732 1.71894 12.583 1.65661C12.6927 1.59428 12.816 1.5596 12.9422 1.55556H23.3877C23.543 1.54821 23.697 1.58758 23.8297 1.66858C23.9624 1.74958 24.0678 1.8685 24.1322 2.00999C24.1967 2.15147 24.2173 2.30903 24.1913 2.46233C24.1654 2.61563 24.0941 2.75763 23.9866 2.87L16.9399 10.8889H21.1244C21.2725 10.892 21.4167 10.9374 21.5399 11.0197C21.6632 11.102 21.7603 11.2178 21.82 11.3534C21.8796 11.489 21.8993 11.6389 21.8766 11.7853C21.854 11.9318 21.79 12.0687 21.6922 12.18L8.75771 26.18C8.6857 26.262 8.59723 26.3279 8.49807 26.3735C8.39891 26.419 8.29128 26.4432 8.18216 26.4444V26.4444ZM7.13994 24.8889H7.84771L19.3355 12.4444H15.2366C15.0813 12.4518 14.9273 12.4124 14.7946 12.3314C14.6619 12.2504 14.5565 12.1315 14.4921 11.99C14.4276 11.8485 14.407 11.691 14.433 11.5377C14.4589 11.3844 14.5303 11.2424 14.6377 11.13L21.6844 3.11111H13.3699L6.04327 14.7778H11.0444C11.1752 14.7801 11.3034 14.8155 11.417 14.8805C11.5305 14.9455 11.6259 15.0382 11.6941 15.1499C11.7624 15.2615 11.8013 15.3886 11.8074 15.5194C11.8135 15.6501 11.7864 15.7803 11.7288 15.8978L7.13994 24.8889Z" fill="#828282"></path>
    </svg></div>
    <div class="text-margin-icon-bubble editor-bubble"><i class="fa fa-edit fa-2x"></i></div>
    </div></div> 
    <div class="readable-text  intended-text" refid="8" id="8" data-hash="a0b3ce4d739948997ce61ab8c83e82b6"> 
    <p>Unlike vector databases, which primarily rely on embeddings that can be around 60% accurate, text-based search engines zero in on the actual text of your data. This hybrid focus often translates into better precision and more flexibility for your queries. Some text search tools do support vectors, but their real advantage lies in powerful text-based searching—which may be exactly what you need to improve your results.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="9" id="9" data-hash="d06138498dba4ba0ec4a2ebd3556654a"> 
    <p>To learn this hybrid approach, we'll download some example SQL records, transform them into string summaries to be more easily searchable, and store them in Azure AI Search—a full-text search service with added support for vector search. It's optimized for hybrid search, blending traditional keyword-based search with vector search, and it handles both structured (for example, SQL records) and unstructured data (for example, PDF documents) effortlessly. In practice, you get the data you are searching for in the top few results—often within the first one or two—without the cumbersome speed or accuracy trade-offs you might face elsewhere. We tried many different retrieval solutions, and since we started using Azure AI Search, we haven’t had any problems retrieving the data we need. For the rest of this chapter, any time we mention “AI Search”, we are specifically referring to Azure’s AI Search service.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="10" id="10" data-hash="1f8edbd8f55bf5c79c4c9fc8314ab918"> 
    <p>You may be wondering why we do not provide tutorials for AWS, GCP or open-source search tools. The answer is simple: I haven’t used them at scale for RAG. I can’t vouch for their real-world performance in a large, demanding environment, so you won’t find any step-by-step guides for those platforms in this book. The focus is on what I’ve personally tested under stress—Azure AI Search—and how that approach has reliably met Fortune 500 needs. Right now we have over 50 million records split across 10 different AI Search indexes. We usually get answers back in 1-10 seconds, and most importantly, the results are always the exact information we are looking for.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="11" id="11" data-hash="0f16300d448d0efe56ba71e8ce772bb7"> 
    <p>Although I’m recommending Azure AI Search in this book, it’s not the only search-as-a-service platform out there. Each alternative has its own sweet spot. Elasticsearch is prized for its powerful API and open-source roots, though its complexity can make setup and maintenance more cumbersome. Algolia has fast performance and a simple interface, but the price tag can rise quickly if you’re on a tight budget. Amazon Kendra taps into AI-driven, highly accurate enterprise search that plugs seamlessly into the AWS ecosystem, yet its pricing might be steep for smaller teams. Amazon CloudSearch tries to reduce hassle by fully managing your search infrastructure—albeit at the cost of missing some advanced features other services offer. Finally, Swiftype has an easier integration process and plenty of quick-start customization, but it may not be quite as deep or feature-rich as some of its heavier-duty counterparts. Ultimately, your choice should reflect your project’s scale, complexity, and resource constraints.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="12" id="12" data-hash="5b1cd12713eae45cd3192c3fbd4213b1"> 
    <p>You’re free to explore AWS, Algolia, or open-source/local options, but I can’t promise the same level of success using those platforms because I haven’t built an enterprise RAG solution on them. Managing a single set of Azure credentials is also minimal overhead compared to what you’ll gain: experience with a system that can handle enterprise loads. You can always adapt these strategies later to your preferred platform.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="13" id="13" data-hash="a48a237d32da2e91308908354700b501"> 
    <p>With that in mind, you might also be wondering why we're transforming SQL records into string summaries and uploading them to Azure AI Search. Isn't this just a big waste of resources? Can't we just keep our data in the SQL database and search it that way? Great questions! Let me explain.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="14" id="14" data-hash="d98ec05f3db74ce0dfb6850d153ce751"> 
    <p>The short answer is that SQL searches tend to be slow and rigid. If you have millions of records, a SQL query might take 30 seconds or more to return results, which is far too long in a RAG system where users expect a quick response. There’s also the issue of exact matching: SQL queries typically require precise terms or structured conditions. Searching for “inflatable pool toys” won’t get you “air-filled fun water floats” if the database calls them by that name. By contrast, a search service like Azure AI Search can interpret fuzzy or partial matches and still bring up relevant records, thanks to its integrated text search capabilities.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="15" id="15" data-hash="947d8576263f4c095adb59292eb27f2e"> 
    <p>Azure AI Search does come with some tradeoffs. It can be tricky to set up (as you’ll see later in this chapter), and its costs can climb significantly once your data grows. It also isn’t ideal for running aggregate queries—like counting how many records contain the word "cat"—which SQL handles more gracefully with GROUP BY and similar operations. Instead, Azure AI Search excels at finding individual records quickly, such as locating a single product’s description or spotting a reference to a product buried in a large PDF catalog.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="16" id="16" data-hash="ed22a35c775a5beee31c14eb73771c7f"> 
    <p>Despite these limitations, we still suggest using a text-based search service instead of a pure vector database, because it usually delivers more consistent and accurate results for everyday searches. Of course, you can use whichever solution best fits your needs, but keep in mind that text search services often strike a balance that purely vector-focused tools can’t easily match.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="17" id="17" data-hash="8ab3da72d44d64e574fb91b7634a1ba9"> 
    <p>Take a look at the flowchart in figure 4.1 to see where we are now in the overall RAG pipeline: we are at Ingestion 2, which is enclosed in a dashed rectangle. In Ingestion 1, you</p> 
    </div> 
    <div class="browsable-container figure-container" refid="18" id="18" data-hash="c7b8bd58f6e3d19eff8c7a4e3713718b"> 
    <h5>Figure 4.1 This flowchart shows the key stages of the RAG pipeline. The focus is on Ingestion 2 (dashed rectangle), where raw data is preprocessed and embedded before being added to Azure AI Search for semantic search. This step bridges the transition from data preparation to retrieval.</h5> 
    <img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/04__image001.png" data-alt="Title: dimensions:[378x300.35] - Description: 041.png" loading="lazy" width="1200" height="953" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/04__image001.png" class="medium-zoom-image"> 
    </div> 
    <div class="readable-text " refid="19" id="19" data-hash="b372ccd3fe41aad1ff9041903469bad1"> 
    <p>learned how to split up documents, embed them, and store them in a vector database—an approach that can work well for certain kinds of data. In this chapter, we will be setting up a text search service.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="20" id="20" data-hash="f6617c9c904913e31828eb1c5d5a6de5"> 
    <p>We’ll also be working with structured data, specifically SQL records. Our sample database holds 500 records, each one has a product name, a description, and some technical specs. To follow along, just download the database file from this link:</p> 
    </div> 
    <div class="readable-text " refid="21" id="21" data-hash="b12946ce4682066cadccd8b7754e45f3"> 
    <p><a href="https://github.com/Tylersuard/RAGforBusiness/raw/refs/heads/main/products.db">https://github.com/Tylersuard/RAGforBusiness/raw/refs/heads/main/products.db</a></p> 
    </div> 
    <div class="readable-text " refid="22" id="22" data-hash="39d91d0f3065b041ef09162e2c5d8b74"> 
    <p>We’re using sqlite3 here because it’s straightforward and gets the job done. Plus, sqlite3’s syntax is close enough to other SQL systems that the code will feel familiar if you’re used to a larger, enterprise-level database.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="23" id="23" data-hash="5f9c52025a7d6dec02b0ac74d880bc9a"> 
    <p>Ready to jump in? Let’s go.</p> 
    </div> 
    <div class="readable-text" refid="24" id="24" data-hash="2f2225a5621521441fca667e741a8296"> 
    <h2>4.1 Setting up Azure AI Search</h2> 
    </div> 
    <div class="readable-text " refid="25" id="25" data-hash="f44c419c1117643bbe441b98dd4d2af1"> 
    <p>Now we’re going to set up an Azure AI Search index so we can process our example SQL records and search through them quickly and accurately. To start, you’ll need an Azure account. If you don’t have one yet, go to the Azure portal and sign up (www.portal.azure.com). Don’t worry, there’s a free tier available for you to experiment with. Once you’ve logged in, head to the search bar in the Azure portal, type Azure AI Search, and click the icon that appears. In the page that opens, create a new search service. If you don’t already have a resource group, create one and give it a name—whatever makes sense to you. Let’s call your new search service something like “products-ai-search” (assuming that name is available) and pick a location close to you for better performance. Keep in mind that higher-level tiers can cost as much as $300 a month. If you’re just experimenting, it’s best to stick to the free tier or remember to delete the service once you’re done with this tutorial. After you’ve settled on your settings, just click Create and give it a minute to spin up.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="26" id="26" data-hash="4de09a9666d04c23d299f6773876a2b2"> 
    <p>Once it’s ready, open the service in the Azure portal and create a new index. Let’s call it “product-search-index.” You’ll need to define the fields for this index, including “ProductName,” “ProductDescription,” “TechnicalSpecifications,” “Manufacturer,” “Summary,” and “DateModified.” We’re using strings for all of these, partly because Azure AI Search supports several data types, but going beyond strings can get complicated. For example, if you choose int64 or float, you’d have to convert those numbers whenever you send or retrieve data, which can be more trouble than it’s worth. Sticking to strings keeps everything simpler, so we recommend it unless you absolutely need to use specific data types in your search index. The first four fields—ProductName, ProductDescription, TechnicalSpecifications, and Manufacturer—will come directly from the SQL records you downloaded earlier. We’ll also combine those fields into a single string called “Summary,” which makes it easy to embed the entire record. Finally, add a “Vector” field of type <kbd>collection(Edm.Single)</kbd> so you can store embeddings for each record. This gives you the best of both worlds: you can use both text-based and vector-based lookups for a more flexible, accurate search experience.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="27" id="27" data-hash="e29486c037aea98fdd2a84ef82738ac7"> 
    <p>You’ll see a few different options for each field when you’re setting up your index. If a field is retrievable, it means that when you run a search and get results, that field’s information won’t be hidden. For important text fields, you will want to leave this checked. You may want to leave it un-checked for vectors, because even though vectors are helping you to search, you don’t necessarily want to get a 1,536-element list coming back in your search results. A filterable field can be used to include or exclude records during a search. For example, if a product has a field like “SOLD_OUT”, you may want to set that field as filterable, so you can find only the records that are still available for sale. A sortable field lets you arrange the results by that field. For example you may want to alphabetize your product names. A searchable field is one you can look up by keywords, while a facetable field is useful when you want to group or tally results, like finding out how many products belong to a certain category. You should set searchable to on for any important fields.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="28" id="28" data-hash="567941f41b20ef9367d681c9308aeeff"> 
    <p>For ProductName, it’s best to enable retrievability, filterability, sortability, and searchability, since people will probably look up items by name. ProductDescription usually just needs to be retrievable and searchable, because it’s often a paragraph or two that you wouldn’t need to filter or sort by. TechnicalSpecifications is similar—retrievable and searchable are usually enough. Manufacturer, on the other hand, should be filterable and sortable so that users can narrow results to one brand or list them all in alphabetical order. We also mark it as facetable, because you might someday want to count how many products each manufacturer has. Summary can remain retrievable and searchable, since it’s basically an all-in-one text field. DateModified should be filterable and sortable, so you can locate the newest or oldest records as needed.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="29" id="29" data-hash="351be6e4d78a1fb9695e5d10cd6e6f91"> 
    <p>For the “Vector” field, you’ll want to set the dimensions to 1536 so they match the embeddings we’ll generate with OpenAI’s models. We are choosing 1536 dimensions to optimize the balance between performance and efficiency. Higher-dimensional embeddings can capture more nuanced semantic relationships but also require more computational resources. Be sure to turn off the retrievable option so you don’t end up with a massive 1,536-element array every time you run a search. Next, create a vector search profile and pick Exhaustive KNN with cosine similarity. We’re using cosine for two reasons: first, Cosine similarity is employed to measure the similarity between two embedding vectors by calculating the cosine of the angle between them. This approach focuses on the direction rather than the magnitude of the vectors, making it effective for assessing semantic similarity regardless of text length. Second, switching to HNSW in Azure doubles the space taken by your vector index. The Hierarchical Navigable Small World (HNSW) algorithm is great for searching huge datasets quickly, but it requires additional in-memory data structures for efficient searches. We are just working with a small dataset right now, so we will use Exhaustive KNN, because it performs well on smaller datasets without HNSW’s memory overhead. After you’ve saved all these settings, your index should be good to go. Just be careful, because if you make a single mistake, Azure won’t let you edit the index later, and you’ll have to start over. Once everything is set up, your finished index should look like figure 4.2.</p> 
    </div> 
    <div class="browsable-container figure-container" refid="30" id="30" data-hash="66df27d5cc9f5ac64461e6c4e9b41f4e"> 
    <h5>Figure 4.2 A correctly set-up Azure AI Search Index. Make sure to set the Retrievable, Filterable, Sortable, Facetable, and Searchable columns exactly as shown in this image.</h5> 
    <img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/04__image002.png" data-alt="Title: dimensions:[378x128.5] - Description: 042.png" loading="lazy" width="1200" height="407" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/04__image002.png" class="medium-zoom-image"> 
    </div> 
    <div class="readable-text " refid="31" id="31" data-hash="d8ec7cc2c40a4b01f6eebe2458eae1bb"> 
    <p>Next, you’ll need your credentials to connect to the Azure AI Search service. Open your search service, click on “Settings,” and then select “Keys” to find your primary admin key. After that, head to the “Overview” page to grab your service’s URL endpoint. You’ll rely on these two pieces of information, your key and your endpoint, when writing code that interacts with Azure AI Search.</p> 
    </div> 

    <div class="readable-text" refid="32" id="32" data-hash="1625b41a1df41716c368b9804524fb24"> 
    <h2>4.2 Preparing and uploading SQL records to AI Search</h2> 
    </div> 
    <div class="readable-text " refid="33" id="33" data-hash="9d1a8e4b0aa35fd3ab91018b2c267f7d"> 
    <p>Figure 4.3 shows how to ingest structured data like SQL records into Azure AI Search. The process starts by connecting to your SQL database, then fetching the data in batches. Batch querying is much more efficient than trying to retrieve millions of rows at once, and it avoids bottlenecks that could slow down both your database and your RAG system. After fetching each batch, you summarize every SQL record into text, clean that text to remove odd characters, and convert it into a vector using OpenAI’s embedding API. Once you have a vector, you wrap the text and vector together in a dictionary and upload it to Azure AI Search. If there are more records to process, you continue the loop; if not, you simply finish. This pipeline ensures that your structured data is fully prepared for hybrid text-and-vector searches, making queries both flexible and fast.</p> 
    </div> 
    <div class="browsable-container figure-container" refid="34" id="34" data-hash="2275b2bd0ecbe341dbdafce70569c653"> 
    <h5>Figure 4.3 Workflow for ingesting structured SQL data into Azure AI Search. The process begins by connecting to an SQL database and fetching records in batches. Each batch is summarized, cleaned, embedded, and prepared as documents for upload. The pipeline loops through remaining records until all data is processed and uploaded.</h5> 
    <img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/04__image003.png" data-alt="Title: dimensions:[237x283.5] - Description: 043.png" loading="lazy" width="1200" height="1435" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/04__image003.png" class="medium-zoom-image"> 
    </div> 
    <div class="readable-text" refid="35" id="35" data-hash="4e7bd212af7d191d8445697a753da2ac"> 
    <h3>4.2.1 Code setup</h3> 
    </div> 
    <div class="readable-text " refid="36" id="36" data-hash="33c4017a03c7ace9e1636b6472fa452b"> 
    <p>Now we can dive into the code. With your Azure AI Search index ready and your credentials handy, the next step is setting up OpenAI for generating embeddings from your SQL records.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="37" id="37" data-hash="aec2d09f5996949efd51e1ea2563f2af"> 
    <p>First, install the necessary libraries:</p> 
    </div> 
    <div class="browsable-container listing-container no-annotations" refid="38" id="38" data-hash="03b8cf62439c95d33faf9b32e9bf5333"> 
    <div class="code-area-container"> 
    <pre class="code-area" data-code-area-highlighted="true"><code class="hljs hljs-line-numbers" style="float:left"><div class="line-number line-number-1">1</div><div class="line-number line-number-2">2</div></code><code class="hljs">pip <span class="hljs-keyword">install</span> azure-core azure-<span class="hljs-keyword">search</span>-documents openai
    </code></pre> 
    <div class="code-annotations-overlay-container" data-annotations-created="true"></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="39" id="39" data-hash="010c0a8146ddf3ebdf6c24cad1c5be8f"> 
    <p>In your local Git repository (the same one you created in Chapter 2), open up the .env file we created in chapter 2. Then add to it the following:</p> 
    </div> 
    <div class="browsable-container listing-container no-annotations" refid="40" id="40" data-hash="7e9a807cdbcaba369319ee5399b598d9"> 
    <div class="code-area-container"> 
    <pre class="code-area" data-code-area-highlighted="true"><code class="hljs hljs-line-numbers" style="float:left"><div class="line-number line-number-1">1</div><div class="line-number line-number-2">2</div><div class="line-number line-number-3">3</div><div class="line-number line-number-4">4</div></code><code class="hljs"><span class="hljs-attr">AI_SEARCH_ENDPOINT</span>=&lt;your search endpoint here&gt;
    <span class="hljs-attr">AI_SEARCH_KEY</span>=&lt;your search key here&gt;
    <span class="hljs-attr">AI_SEARCH_NAME</span>=&lt;the name of your index&gt;
    </code></pre> 
    <div class="code-annotations-overlay-container" data-annotations-created="true"></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="41" id="41" data-hash="b58dac28002cabc500886696471ff51a"> 
    <p>Now create a new file called upload_sql_records_to_ai_search.py. At the top of this file, add the following imports:</p> 
    </div> 
    <div class="browsable-container listing-container" refid="42" id="42" data-hash="8ea67dff93b3003f09f02836476a6c1a" data-annotation-type="letters"> 
    <h5>Listing 4.1 Import necessary libraries</h5> 
    <div class="code-area-container"> 
    <pre class="code-area" data-code-area-highlighted="true"><div class="line-container listing-line-group groupA" style="top: 0px; height:16px; line-height:16px;" data-code="aW1wb3J0IG9z"></div><div class="line-container listing-line-group groupB" style="top: 17px; height:16px; line-height:16px;" data-code="ZnJvbSBhenVyZS5zZWFyY2guZG9jdW1lbnRzIGltcG9ydCBTZWFyY2hDbGllbnQ="></div><div class="line-container listing-line-group groupC" style="top: 34px; height:16px; line-height:16px;" data-code="ZnJvbSBhenVyZS5jb3JlLmNyZWRlbnRpYWxzIGltcG9ydCBBenVyZUtleUNyZWRlbnRpYWw="></div><div class="line-container listing-line-group groupD" style="top: 51px; height:16px; line-height:16px;" data-code="ZnJvbSBvcGVuYWkgaW1wb3J0IE9wZW5BSQ=="></div><div class="line-container listing-line-group groupE" style="top: 68px; height:16px; line-height:16px;" data-code="aW1wb3J0IHNxbGl0ZTM="></div><code class="hljs hljs-line-numbers" style="float:left"><div class="line-number line-number-1">1</div><div class="line-number line-number-2">2</div><div class="line-number line-number-3">3</div><div class="line-number line-number-4">4</div><div class="line-number line-number-5">5</div><div class="line-number line-number-6">6</div><div class="line-number line-number-7">7</div><div class="line-number line-number-8">8</div></code><code class="hljs"><span class="hljs-keyword">import</span> os
    <span class="hljs-keyword">from</span> azure.search.documents <span class="hljs-keyword">import</span> SearchClient
    <span class="hljs-keyword">from</span> azure.core.credentials <span class="hljs-keyword">import</span> AzureKeyCredential
    <span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI
    <span class="hljs-keyword">import</span> sqlite3
    <span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
    load_dotenv()
    </code></pre> 
    <div class="code-annotations-overlay-container" data-annotations="I0EgVGhpcyB3aWxsIGFsbG93IHVzIHRvIGFjY2VzcyBlbnZpcm9ubWVudCB2YXJpYWJsZXMgIGxhdGVyIG9uCiNCIFRoaXMgaXMgQXp1cmXigJlzIFB5dGhvbiBTREsgZm9yIEFJIFNlYXJjaAojQyBIZWxwcyBhdXRoZW50aWNhdGUgcmVxdWVzdHMgdG8gQUkgU2VhcmNoCiNEIEFsbG93cyB1cyB0byBpbnRlcmFjdCB3aXRoIE9wZW5BSeKAmXMgQVBJCiNFIFdlIHdpbGwgdXNlIHRoaXMgdG8gb3BlbiBvdXIgZG93bmxvYWRlZCBkYXRhYmFzZSBmaWxl" data-annotations-created="true"><div class="annotation-container" data-annotation-label="A" style="top:0px; height:16px; line-height:16px" data-start-line-index="0" data-end-line-index="0" title="This will allow us to access environment variables  later on">
                                                <span class="annotation-label" id="A">A</span>
                                            </div><div class="annotation-container" data-annotation-label="B" style="top:17px; height:16px; line-height:16px" data-start-line-index="1" data-end-line-index="1" title="This is Azure’s Python SDK for AI Search">
                                                <span class="annotation-label" id="B">B</span>
                                            </div><div class="annotation-container" data-annotation-label="C" style="top:34px; height:16px; line-height:16px" data-start-line-index="2" data-end-line-index="2" title="Helps authenticate requests to AI Search">
                                                <span class="annotation-label" id="C">C</span>
                                            </div><div class="annotation-container" data-annotation-label="D" style="top:51px; height:16px; line-height:16px" data-start-line-index="3" data-end-line-index="3" title="Allows us to interact with OpenAI’s API">
                                                <span class="annotation-label" id="D">D</span>
                                            </div><div class="annotation-container" data-annotation-label="E" style="top:68px; height:16px; line-height:16px" data-start-line-index="4" data-end-line-index="4" title="We will use this to open our downloaded database file">
                                                <span class="annotation-label" id="E">E</span>
                                            </div></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="43" id="43" data-hash="4ecd67371332ae80d28f8f1797717f95"> 
    <p>And now we set up our search client and our openai client using our environment variables which we defined earlier:</p> 
    </div> 
    <div class="browsable-container listing-container" refid="44" id="44" data-hash="cc52817f16db9b697595bdf19a6c5d08" data-annotation-type="letters"> 
    <h5>Listing 4.2 Set your credentials</h5> 
    <div class="code-area-container"> 
    <pre class="code-area" data-code-area-highlighted="true"><div class="line-container listing-line-group groupA" style="top: 0px; height:16px; line-height:16px;" data-code="b3BlbmFpX2NsaWVudCA9IE9wZW5BSShhcGlfa2V5PW9zLmVudmlyb24uZ2V0KCJPUEVOQUlfQVBJX0tFWSIpKQ=="></div><div class="line-container listing-line-group groupB" style="top: 34px; height:33px; line-height:33px;" data-code="ICBlbmRwb2ludD1vcy5lbnZpcm9uLmdldCgiQUlfU0VBUkNIX0VORFBPSU5UIiksDQogIGluZGV4X25hbWU9b3MuZW52aXJvbi5nZXQoIkFJX1NFQVJDSF9OQU1FIiks"></div><div class="line-container listing-line-group groupC" style="top: 68px; height:16px; line-height:16px;" data-code="ICBjcmVkZW50aWFsPUF6dXJlS2V5Q3JlZGVudGlhbChvcy5lbnZpcm9uLmdldCgiQUlfU0VBUkNIX0tFWSIpKSw="></div><code class="hljs hljs-line-numbers" style="float:left"><div class="line-number line-number-1">1</div><div class="line-number line-number-2">2</div><div class="line-number line-number-3">3</div><div class="line-number line-number-4">4</div><div class="line-number line-number-5">5</div><div class="line-number line-number-6">6</div></code><code class="hljs">openai_client = OpenAI(api_key=os.environ.<span class="hljs-keyword">get</span>(<span class="hljs-string">"OPENAI_API_KEY"</span>))
    search_client = SearchClient(
    endpoint=os.environ.<span class="hljs-keyword">get</span>(<span class="hljs-string">"AI_SEARCH_ENDPOINT"</span>),
    index_name=os.environ.<span class="hljs-keyword">get</span>(<span class="hljs-string">"AI_SEARCH_NAME"</span>),
    credential=AzureKeyCredential(os.environ.<span class="hljs-keyword">get</span>(<span class="hljs-string">"AI_SEARCH_KEY"</span>)),
    )</code></pre> 
    <div class="code-annotations-overlay-container" data-annotations="I0EgRmluZCB0aGlzIGluIHlvdXIgQVBJIEtleSBwYWdlIG9uIG9wZW5haS5jb20KI0IgRmluZCBhbGwgb2YgdGhpcyBpbmZvcm1hdGlvbiBpbiB0aGUg4oCcT3ZlcnZpZXfigJ0gcGFnZSBvZiB0aGUgQUkgU2VhcmNoIFNlcnZpY2UKI0MgRmluZCB0aGlzIGluIHRoZSBTZXR0aW5ncyB0YWIgaW4geW91ciBBSSBTZWFyY2ggU2VydmljZQ==" data-annotations-created="true"><div class="annotation-container" data-annotation-label="A" style="top:0px; height:16px; line-height:16px" data-start-line-index="0" data-end-line-index="0" title="Find this in your API Key page on openai.com">
                                                <span class="annotation-label" id="A">A</span>
                                            </div><div class="annotation-container" data-annotation-label="B" style="top:34px; height:33px; line-height:33px" data-start-line-index="2" data-end-line-index="3" title="Find all of this information in the “Overview” page of the AI Search Service">
                                                <span class="annotation-label" id="B">B</span>
                                            </div><div class="annotation-container" data-annotation-label="C" style="top:68px; height:16px; line-height:16px" data-start-line-index="4" data-end-line-index="4" title="Find this in the Settings tab in your AI Search Service">
                                                <span class="annotation-label" id="C">C</span>
                                            </div></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="45" id="45" data-hash="1d82c63b8bdf167e4b8a32eb76121f40"> 
    <p>Great! Now your code is ready to communicate with both Azure AI Search and OpenAI’s API.</p> 
    </div> 
    <div class="readable-text" refid="46" id="46" data-hash="2cdb1c2a83dcc8637c8d8971a4563396"> 
    <h3>4.2.2 Summarize one SQL record</h3> 
    </div> 
    <div class="readable-text " refid="47" id="47" data-hash="24a7b1e9c063c98d26f20280d59627e4"> 
    <p>Now let’s look at how to summarize each SQL record before we embed it as text. In Listing 4.3, we define a summarize_SQL_record() function that combines key fields into a single, coherent string, which makes it easier for the embedding model to capture its meaning. Figure 4.4 shows an outline of our overall process (note that these embeddings are just made-up numbers for example).</p> 
    </div> 
    <div class="browsable-container figure-container" refid="48" id="48" data-hash="ac76772b64715d9adfc3578dfc143a27"> 
    <h5>Figure 4.4 Converting an SQL record into a vector embedding. The process begins by transforming the raw SQL record into a natural language string summary. This summary is then passed through an embedding model to generate a vector representation, which can be used for vector search.</h5> 
    <img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/04__image004.png" data-alt="Title: dimensions:[219.6x320.4] - Description: 044.png" loading="lazy" width="1200" height="1750" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/04__image004.png" class="medium-zoom-image"> 
    </div> 
    <div class="browsable-container listing-container" refid="49" id="49" data-hash="ba6ca1607a4cc8f20d0ed94556a9c40b"> 
    <h5>Listing 4.3 Summarize a SQL record</h5> 
    <div class="code-area-container"> 
    <pre class="code-area">def summarize_SQL_record(sql_record):
    record_summary_string = f"""
    Product_Name: {sql_record[1]}  #A
    Product Description: {sql_record[2]}
    Technical Specs: {sql_record[3]}
    Manufacturer: {sql_record[4]}"""
    print(f"Summarized record for {sql_record[1]}: 
    ➥{record_summary_string}")

    return record_summary_string
    </pre> 
    <div class="code-annotations-overlay-container" data-annotations="I0EgV2UgY29udmVydCBvbmUgU1FMIHJlY29yZCB0byB0ZXh0LCBpbmNsdWRpbmcgaXRzIGNvbHVtbiBuYW1lcy4="></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="50" id="50" data-hash="5bd3f6df15cfdefd315a48691e99080f"> 
    <p>By blending columns like the product name, description, technical specs, and manufacturer, we end up with a meaningful summary that’s easy for the embedding model to handle. This step ensures our text is clear and consistent, laying the groundwork for generating quality embeddings. Once the summary is created, our next task is to clean up any unwanted characters or symbols that might interfere with the embedding process. You want to remove all emojis, non-ASCII characters, and anything else that might confuse the embedding model.</p> 
    </div> 
    <div class="browsable-container listing-container" refid="51" id="51" data-hash="f2ab8a7036309fa7fceaf5900dccda18"> 
    <h5>Listing 4.4 Clean the string summary</h5> 
    <div class="code-area-container"> 
    <pre class="code-area">def clean_record_summary(record_summary):
    cleaned_record_summary = record_summary.
    ➥replace("--", "")  #A
    return cleaned_record_summary
    </pre> 
    <div class="code-annotations-overlay-container" data-annotations="I0EgUmVtb3ZlIGFueSB1bm5lY2Vzc2FyeSBjaGFyYWN0ZXJzLiAgT3RoZXIgZXhhbXBsZXMgbWF5IGluY2x1ZGU6ICosIOKApiAsIPCfmIosIGV0Yy4="></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="52" id="52" data-hash="564eab40863b04f806aa20d95326ac3e"> 
    <p>If you notice errors from OpenAI’s embedding model later on, you may need to come back here and expand the cleaning function to remove additional characters.</p> 
    </div> 
    <div class="readable-text" refid="53" id="53" data-hash="dd2be68476f9f611219ac73b74b5538c"> 
    <h3>4.2.3 Embed the record summary</h3> 
    </div> 
    <div class="readable-text " refid="54" id="54" data-hash="5af5ab0445a8c64ba8d0e23e271529bb"> 
    <p>Next, let’s convert the cleaned text summary into an embedding. Be sure to use 1536 dimensions so it matches the embedding size defined in your AI Search index; otherwise, your vectors won’t be compatible. As we mentioned in Chapter 3, embeddings capture the meaning of words in a format that AI can interpret. We’re using text-embedding-3-small because it strikes a good balance between cost and accuracy. Although OpenAI offers a larger model, we’ve found the performance difference doesn’t justify the extra expense for most use cases. We’ve also tried various open-source models fine-tuned for specific domains, but they generally haven’t matched the quality of OpenAI’s more general-purpose models.</p> 
    </div> 
    <div class="browsable-container listing-container" refid="55" id="55" data-hash="7e3f3ddcc2bc0ce7b0e6ff85c86602c7"> 
    <h5>Listing 4.5 Embed the cleaned record summary</h5> 
    <div class="code-area-container"> 
    <pre class="code-area">def embed_text(cleaned_record_summary):
    response = openai_client.embeddings.create(  #A
    input=cleaned_record_summary,  #B
    model="text-embedding-3-small",  #C
    dimensions=1536  #D
    )
    return response.data[0].embedding</pre> 
    <div class="code-annotations-overlay-container" data-annotations="I0EgQ3JlYXRpbmcgZW1iZWRkaW5ncyBpcyBlYXN5OiB5b3UganVzdCBzZW5kIHlvdXIgdGV4dCB0byBhbiBBUEkgYW5kIGdldCBhIGxpc3Qgb2YgbnVtYmVycyBiYWNrLgojQiBJbnB1dCB0aGUgY2xlYW5lZCBzdW1tYXJ5IHN0cmluZyB3ZSBjcmVhdGVkIGVhcmxpZXIuCiNDIFdlIGFyZSB1c2luZyB0ZXh0LWVtYmVkZGluZy0zLXNtYWxsLiAKI0QgV2UgbmVlZCB0byB1c2UgdGhlIHNhbWUgbnVtYmVyIG9mIGRpbWVuc2lvbnMgYXMgd2Ugc2V0IHVwIGVhcmxpZXIgaW4gb3VyIEFJIFNlYXJjaCBpbmRleC4="></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text" refid="56" id="56" data-hash="709e15074d90de71323641f79159dd1d"> 
    <h3>4.2.4 Upload the record and embedding to Azure AI Search</h3> 
    </div> 
    <div class="readable-text " refid="57" id="57" data-hash="359bb694bc61f37407416252a1b6a2cd"> 
    <p>Once each SQL record is summarized and embedded, it’s time to upload everything to Azure AI Search. First, we grab the current date to store alongside the record—this can be useful later when you want to see exactly when a record was added to your index. We then build a dictionary keyed to the fields in your AI Search index, including the record’s ID, the text summary from summarize_sql_record(), and the embedding from embed_text(). In this chapter, we often use the terms “vector” and “embedding” interchangeably. After constructing the dictionary, we call search_client.merge_or_upload_documents(), which sends the record to Azure. A quick print statement helps confirm that each record is being processed instead of leaving you staring at a blinking cursor. The upload_to_AI_Search() function below puts all these steps together.</p> 
    </div> 
    <div class="browsable-container listing-container" refid="58" id="58" data-hash="d845f5bf9dbddbfdac49d918f7e9bf86"> 
    <h5>Listing 4.6 Upload the record and embedding to AI Search</h5> 
    <div class="code-area-container"> 
    <pre class="code-area">from datetime import date

    today = date.today()
    date_string = today.strftime("%Y-%m-%d")

    def upload_to_AI_Search(record, 
    record_summary, 
    embedded_summary):

    record_to_upload = {}    
    record_to_upload["id"] = str(record[0])  #A
    record_to_upload["Summary"] = record_summary  #B
    record_to_upload["Vector"] = embedded_summary  #C
    record_to_upload["ProductName"] = record[1]  #A
    record_to_upload["ProductDescription"] = record[2]  #A
    record_to_upload["TechnicalSpecifications"] = record[3]  #A
    record_to_upload["Manufacturer"] = record[4]  #A
    record_to_upload["DateModified"] = date_string  #D

    search_client.merge_or_upload_documents(
    documents=[record_to_upload])  #E
    print(f"Record for {record[1]} processed and 
    ➥uploaded!")
    </pre> 
    <div class="code-annotations-overlay-container" data-annotations="I0EgSW5jbHVkZSB0aGUgcHJvZHVjdCBuYW1lLCBwcm9kdWN0IGRlc2NyaXB0aW9uLCB0ZWNobmljYWwgc3BlY3MsIGFuZCBtYW51ZmFjdHVyZXIgaW4gdGhlIHJlY29yZCBhcyBzZXBhcmF0ZSBmaWVsZHMuICBXZSBkbyB0aGlzIHNvIHdlIGNhbiBzZWFyY2ggYnkgbWFudWZhY3R1cmVyLCBzZWFyY2ggYnkgcHJvZHVjdCBuYW1lLCBldGMuCiNCIEFkZCB0aGUgc3VtbWFyeSBzdHJpbmcgdG8gdGhlIHJlY29yZCBkaWN0aW9uYXJ5LgojQyBBZGQgdGhlIGVtYmVkZGluZyB0byB0aGUgcmVjb3JkIGRpY3Rpb25hcnkuCiNEIFdlIGFkZCB0b2RheeKAmXMgZGF0ZSBzbyB3ZSBjYW4gdHJhY2sgd2hlbiB0aGVzZSByZWNvcmRzIHdlcmUgY3JlYXRlZCBpbiBvdXIgc2VhcmNoIGluZGV4LgojRSBVcGxvYWQgdGhlIGRvY3VtZW50IHRvIHlvdXIgQUkgU2VhcmNoIGluZGV4Lg=="></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="59" id="59" data-hash="45849ec1fd5d20291916f4494ebb3a01"> 
    <p>Here, we take the original SQL record, the text summary of that record, and the embedding we generated, and bundle them into a dictionary called record_to_upload. We include every key field—ProductName, ProductDescription, and so on—so we can easily search by them later. We also add a current date stamp to keep track of when each record is added to the index. Finally, merge_or_upload_documents() sends the record to Azure AI Search, and we print a quick message confirming it was processed.</p> 
    </div> 
    <div class="readable-text" refid="60" id="60" data-hash="f42f9803d89664afaea9db30bef9d140"> 
    <h3>4.2.5 Putting it all together</h3> 
    </div> 
    <div class="readable-text " refid="61" id="61" data-hash="30ba6de19162fd95858988b15788cfdc"> 
    <p>Next, we compile these smaller functions into a single, readable workflow. In the snippet below (Listing 4.7), summarize_embed_upload() accepts a single SQL record, summarizes it, cleans the summary, embeds it, and then uploads it to Azure AI Search.</p> 
    </div> 
    <div class="browsable-container listing-container" refid="62" id="62" data-hash="68f2b55946b6667596295c0401090f0b"> 
    <h5>Listing 4.7 Process and upload one record</h5> 
    <div class="code-area-container"> 
    <pre class="code-area">def summarize_embed_upload(sql_record):
    summarized_SQL_record = summarize_SQL_record(
    ➥sql_record)  #A

    cleaned_record_summary = clean_record_summary(
    ➥summarized_SQL_record)  #B

    record_summary_embedding = embed_text(
    ➥cleaned_record_summary)  #C

    upload_to_AI_Search(
            sql_record, cleaned_record_summary,
    ➥record_summary_embedding
        )  #D</pre> 
    <div class="code-annotations-overlay-container" data-annotations="I0EgV2UgcHJvZHVjZSBhIHN0cmluZyBzdW1tYXJ5IG9mIHRoZSBTUUwgcmVjb3JkIChzZWUgTGlzdGluZyA0LjMpLgojQiBXZSBjbGVhbiB0aGF0IHN1bW1hcnkgc3RyaW5nIChzZWUgTGlzdGluZyA0LjQpCiNDIFdlIHRyYW5zZm9ybSB0aGUgc3VtbWFyeSBzdHJpbmcgaW50byBhIHZlY3RvciAoc2VlIExpc3RpbmcgNC41KQojRCBDb21iaW5lIHRoZSBvcmlnaW5hbCByZWNvcmQgd2l0aCB0aGUgc3VtbWFyeSBhbmQgdGhlIGVtYmVkZGluZywgdGhlbiB1cGxvYWQgdGhlbSB0byB0aGUgQUkgU2VhcmNoIEluZGV4Lg=="></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="63" id="63" data-hash="35af295fe999ff95c1bdb76463d9f714"> 
    <p>These four lines neatly capture the pipeline: we summarize the record, clean up its text, embed it into a vector, and then push the result to AI Search.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="64" id="64" data-hash="840da0d84132702bdca27d32c1fe7507"> 
    <p>Once you’re able to process and upload a single record like this, it’s easy to loop over all the records in your SQL database.</p> 
    </div> 
    <div class="readable-text" refid="65" id="65" data-hash="c3e09f2fa24917d93300cdc9c1be9bf0"> 
    <h3>4.2.6 Loop through all SQL records</h3> 
    </div> 
    <div class="readable-text " refid="66" id="66" data-hash="045f4ae3b9e1f5072806752a875ccbee"> 
    <p>When you’re ready, you can bring everything together in the ingest_all_records() function. This function is your main orchestrator, connecting to the SQL database and processing its records in batches of 100. Figure 4.5 is a diagram of the simplified ingestion workflow:</p> 
    </div> 
    <div class="browsable-container figure-container" refid="67" id="67" data-hash="8db5a8e62c3c720bbe35939065c80d57"> 
    <h5>Figure 4.5 The iterative process for handling SQL records. The loop starts by connecting to the database and fetching the next batch of records. Each batch is summarized and embedded, with a counter updated to track progress. If no more records remain, the loop breaks, and resources like the cursor and connection are closed to ensure efficiency.</h5> 
    <img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/04__image005.png" data-alt="Title: dimensions:[378x374.5] - Description: 045.png" loading="lazy" width="1200" height="1187" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/04__image005.png" class="medium-zoom-image"> 
    </div> 
    <div class="readable-text " refid="68" id="68" data-hash="d3889f0138168b192ff4c7c19bbda8b1"> 
    <p>Fetching data in smaller batches is a lot more efficient than trying to ingest millions of rows in a single shot, and it keeps both your database and your RAG system more responsive overall. In the code we’ll see next, we pull 100 records at a time, and for each record, we call summarize_embed_upload to do all the heavy lifting: summarizing, cleaning, embedding, and finally uploading that data. Once one batch is done, we move on to the next, continuing until there’s nothing left to fetch.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="69" id="69" data-hash="1a2146761608d7bf188732fbc8017229"> 
    <p>This approach is especially handy if your datasets are huge—think hundreds of thousands or even millions of records. In those situations, don’t be surprised if your script runs for hours or possibly days, depending on your data’s size. You can speed things up by calling the embedding functions asynchronously, letting them run in parallel rather than one by one.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="70" id="70" data-hash="6eaee1511a8f5d3be05b1ba35b8d8e59"> 
    <p>It also helps to keep track of how many records you’ve processed so far, in case the loop fails or times out. For example, if the loop stops at record 1,500, you might skip the first 1,500 uploads when you restart, so you don’t re-embed data you’ve already handled.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="71" id="71" data-hash="25a2517b37fb7d46e667e1753b43ed00"> 
    <p>In the snippet that follows, we connect to the database, pull 100 SQL records, then transform them by summarizing, embedding, and uploading to AI Search. We chose 100 as an example, but you can experiment with different batch sizes to see what feels best in your environment.</p> 
    </div> 
    <div class="browsable-container listing-container" refid="72" id="72" data-hash="f6726e30a8bc2d60ea8c6882ccc976a5"> 
    <h5>Listing 4.8 Process and upload all records</h5> 
    <div class="code-area-container"> 
    <pre class="code-area">def ingest_all_records(sql_query):
    conn = sqlite3.connect("products.db")  #A
    cur = conn.cursor()
    cur.execute(sql_query)  #B

    batch_size = 100  #C

    total_records_transformed = 0  #D

    while True:
    records = cur.fetchmany(size=batch_size)  #E
    if not records:
    break  #F

    for record in records:
    print(f"Summarizing record with ID {record[0]}")
    summarize_embed_upload(record)

    total_records_transformed += len(records)  #G
    print(f"Total records uploaded: {total_records_transformed}")

    cur.close()
    conn.close()  #H

    if __name__ == "__main__":
    ingest_all_records("SELECT * FROM Products")  #I
    </pre> 
    <div class="code-annotations-overlay-container" data-annotations="I0EgQ29ubmVjdCB0byB0aGUgZXhhbXBsZSBkYXRhYmFzZSB3ZSBkb3dubG9hZGVkIGVhcmxpZXIuCiNCIFJ1biB0aGUgcXVlcnkgYW5kIHNlbGVjdCB0aGUgY29ycmVzcG9uZGluZyByZWNvcmRzLiAgSWYgeW91IGFyZSB1bmZhbWlsaWFyIHdpdGggU1FMLCBzZWUgdGhpcyB2aWRlbzogPGEgaHJlZj0iaHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj1rYkt0eTVaVktNWSI+aHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj1rYkt0eTVaVktNWTwvYT4KI0MgU2V0IHRoZSBiYXRjaCBzaXplIHRvIDEwMC4gIFRoaXMgaXMgaW1wb3J0YW50IGZvciBTUUwgZGF0YWJhc2VzIHdpdGggYSBsYXJnZSBudW1iZXIgb2YgcmVjb3JkcywgYmVjYXVzZSBxdWVyeWluZyBhbGwgb2YgdGhlbSB3b3VsZCB0YWtlIGEgdmVyeSBsb25nIHRpbWUuCiNEIEluaXRpYWxpemUgYSBjb3VudGVyIHRvIGtlZXAgdHJhY2sgb2YgaG93IG1hbnkgcmVjb3JkcyB3ZSd2ZSBwcm9jZXNzZWQgc28gZmFyLgojRSBGZXRjaCB0aGUgbmV4dCBiYXRjaCBvZiByZWNvcmRzIGZyb20gdGhlIGRhdGFiYXNlLgojRiBJZiB0aGVyZSBhcmUgbm8gbW9yZSByZWNvcmRzIHRvIGZldGNoLCB3ZSBicmVhayBvdXQgb2YgdGhlIGxvb3AgYW5kIGVuZCB0aGUgcHJvZ3JhbS4KI0cgU2hvdyBob3cgbWFueSByZWNvcmRzIHdlIGhhdmUgcHJvY2Vzc2VkIHNvIGZhci4gIEFnYWluLCBpbXBvcnRhbnQgZm9yIGxhcmdlIGRhdGFiYXNlcy4KI0ggQ2xvc2UgdGhlIGN1cnNvciBhbmQgdGhlIGRhdGFiYXNlIGNvbm5lY3Rpb24gdG8gZnJlZSB1cCByZXNvdXJjZXMuCiNJIENhbGwgdGhlIGZ1bmN0aW9uLiAgX19uYW1lX189PeKAnW1haW7igJ0gbWFrZXMgaXQgc28gdGhpcyBwYXJ0IHdvbuKAmXQgcnVuIHdoZW4gd2UgaW1wb3J0IHRoZSBzY3JpcHQu"></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="73" id="73" data-hash="4a6d7cc92b43c747273073c523e6d59d"> 
    <p>In this function, we connect to the products.db file from our earlier examples and run a SQL query to select the records we want to process. To avoid overloading the database or our RAG system, we fetch data in batches of 100 rows at a time. Each batch is looped through, and for every individual record, we call summarize_embed_upload(), which handles summarizing, cleaning, embedding, and uploading the data to Azure AI Search. Once a batch is processed, we increase our running total of uploaded records. If there are no more records to fetch, we exit the loop, close our cursor and connection, and wrap up the process. This approach saves a lot of time and hassle when dealing with large datasets.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="74" id="74" data-hash="f5a0c9b541aaa6a9d668ff70bf7b6fa0"> 
    <p>After you’ve set up this function, you can run:</p> 
    </div> 
    <div class="browsable-container listing-container" refid="75" id="75" data-hash="544c86986543877664cf9787c8511f33"> 
    <div class="code-area-container"> 
    <pre class="code-area">python upload_records_to_ai_search.py </pre> 
    <div class="code-annotations-overlay-container"></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="76" id="76" data-hash="bfd7f6542e7b98bc8156957badc8d508"> 
    <p>You should see a printout of how many records were ingested in each batch. If you have around 500 records in your example dataset, you can verify that number by checking the search index in your Azure portal—it should show the same total. You can then open the Search Explorer, run a query (or even leave the query blank), and confirm that the new records appear. With all those SQL entries now uploaded and indexed, you’re ready to move on to querying and retrieving results in the next steps.</p> 
    </div> 
    <div class="readable-text" refid="77" id="77" data-hash="6f06e548dd973183a97f0c8810ef1975"> 
    <h3>4.2.7 Test AI Search</h3> 
    </div> 
    <div class="readable-text " refid="78" id="78" data-hash="e162b5c7a6d2d9f7e17ce4e5c2bd4a01"> 
    <p>Here’s a quick rundown of what we’re going to do next: first, you embed the user’s query. By sending the query text to an embedding model, you transform the text “Dubious Parenting Advice” into a numerical vector capturing its overall meaning. Next, you pass that embedding into the class VectorizedQuery() and specify that you only want to see the top three closest matches in the vector field. The vector query might catch records containing phrases like “questionable parenting techniques,” even if they don’t match the user’s words exactly.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="79" id="79" data-hash="235bc4ea9cdc571636848fc344feeda4"> 
    <p>However, you also include the plain-text keyword search, the raw search_text=query part, so you get results that contain the phrase “Dubious Parenting Advice” verbatim (or partial matches, synonyms, etc.) in the standard text search approach. That means your system is doing two things:</p> 
    </div> 
    <div class="readable-text  intended-text" refid="80" id="80" data-hash="0a01bb78336383bd2b684ae97b2771b0"> 
    <p>Semantic Match, comparing the user’s embedding to the embeddings of your documents, and Exact/Keyword Match, finding text that literally includes the words or phrases from the user’s query.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="81" id="81" data-hash="110fe5bdf6b7d9c8c0ce973e79acf836"> 
    <p>By covering both angles, you avoid the pitfalls of purely semantic methods (which might be too inaccurate) or purely keyword-based methods (which might overlook phrases that don’t match exactly but carry the same meaning). The final results can merge and rank hits from each approach, giving you a better set of answers.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="82" id="82" data-hash="6f644b0f365f58dc75bb80095bc65493"> 
    <p>This hybrid search process helps ensure that when someone types a query, the system isn’t forced into a single strategy. Instead, it reaps the benefits of both exact token matching and semantic understanding to retrieve the most relevant records, whether or not the text in your database lines up precisely with the user’s phrasing.</p> 
    </div> 
    <div class="readable-text " refid="83" id="83" data-hash="926bc43b8758a07490617b6b2791f2b2"> 
    <p>Let’s create a new file called <strong>try_search.py</strong>, type out the following code, and then run the file:</p> 
    </div> 
    <div class="browsable-container listing-container" refid="84" id="84" data-hash="166352c6986490c72f14ed8cb2e018b3"> 
    <h5>Listing 4.9 Test your AI Search</h5> 
    <div class="code-area-container"> 
    <pre class="code-area">from azure.search.documents.models import 
    ➥VectorizedQuery  #A
    from upload_records_to_ai_search import 
    ➥embed_text, search_client

    query = "Dubious parenting advice"

    embedding = embed_text(query)  #B

    vector_query = VectorizedQuery(
    vector=embedding,  #C
    k_nearest_neighbors=3,   #D
    fields="Vector")  #E

    results = search_client.search(
    search_text=query,
    vector_queries=[vector_query],
    top=1
    )  #F

    for result in results:
    print(result)
    </pre> 
    <div class="code-annotations-overlay-container" data-annotations="I0EgV2UgdXNlIHRoaXMgY2xhc3MgdG8gc2VhcmNoIGJ5IGJvdGggdmVjdG9yIGFuZCB0ZXh0LgojQiBXZSBnZW5lcmF0ZSBhbiBlbWJlZGRpbmcgdmVjdG9yIGZvciB0aGUgdXNlcidzIHF1ZXJ5LgojQyBBZGQgb3VyIGVtYmVkZGVkIHF1ZXJ5IHRvIHRoZSBWZWN0b3JpemVkUXVlcnkgY2xhc3MuCiNEIFRha2UgdGhlIHRvcCAzIG5lYXJlc3Qgc2VhcmNoIHZlY3RvcnMgYXMgcmVzdWx0cy4gCiNFIEluZGljYXRlIHRoZSBmaWVsZCBpbiBvdXIgSW5kZXggd2hlcmUgd2Ugc2hvdWxkIHBlcmZvcm0gdGhlIHZlY3RvciBzZWFyY2guCiNGIFNlYXJjaCB0aGUgSW5kZXggdXNpbmcgYm90aCB0aGUgdmVjdG9yIGFuZCB0aGUgdGV4dC4="></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="85" id="85" data-hash="b91bb2a747cf4efe12050c4da9422c96"> 
    <p>If all goes well, you should see something like this in your output (omitting the Summary for brevity):</p> 
    </div> 
    <div class="browsable-container listing-container" refid="86" id="86" data-hash="d163e5dfcee9ebc1d10aa080f5df0260"> 
    <div class="code-area-container"> 
    <pre class="code-area">{'DateModified': '2024-12-24', 'id': '59', 'ProductName': 'Dubious Parenting Tips', 'Manufacturer': 'Wongza! Products', 'TechnicalSpecifications': '{"Author": "Lisa Melton", "Genre": "Non-Fiction", "Pages": 846}', 'ProductDescription': "Introducing **Dubious Parenting Tips** by Wongza! – a refreshingly candid and humor-infused guide to the wonderfully chaotic world of parenting. Crafted by the witty and insightful **Lisa Melton**, this non-fiction tome, stretching across an engaging 846 pages, offers an unconventional perspective on raising little humans.\n\nWith her trademark sass and wisdom, Lisa Melton challenges conventional parenting advice with a bold mix of hilariously relatable anecdotes and clever guidance. Dubious Parenting Tips is not just a book – it’s a companion, a cheerleader, and sometimes, a much-needed reality check for any parent navigating the pressures of modern-day parenting.\n\nInside, you'll find advice on everything from sleep training to temper tantrums, all delivered with a wink and a nod to the fact that there is truly no one-size-fits-all when it comes to kids. Whether you're a brand-new parent or a seasoned pro looking for a fresh take, this book is packed with insights that embrace the imperfections and joys of parenting.\n\nJoin thousands of readers who are discovering the joy of letting go of the 'perfect parent' myth and embracing the beautiful, chaotic journey of raising children. Let **Dubious Parenting Tips** by Wongza! be your trusted guide, providing comfort and laughter to parents everywhere.", '@search.score': 0.03333333507180214, '@search.reranker_score': None, '@search.highlights': None, '@search.captions': None}</pre> 
    <div class="code-annotations-overlay-container"></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="87" id="87" data-hash="01528c83f011962e9ee1c985e26e115e"> 
    <p>Great—we successfully retrieved the record for “Dubious Parenting Advice” by combining text and vector search!</p> 
    </div> 
    <div class="readable-text" refid="88" id="88" data-hash="c4dab5092516ed69ab9e54ef436e3373"> 
    <h3>4.2.8 Search filters and selecting fields</h3> 
    </div> 
    <div class="readable-text " refid="89" id="89" data-hash="b5411a21081282f86b5e7c899f21001f"> 
    <p>Now suppose you want to narrow your results to a single manufacturer—for example, Banana Angel inc. We can accomplish this using an OData filter, which tells the system to return only items matching a certain condition. If you’re curious about OData query options, check out Microsoft’s documentation (<a href="https://learn.microsoft.com/en-us/odata/">https://learn.microsoft.com/en-us/odata/</a>). In our current code, we can search only the products manufactured by Banana Angel inc by setting our <kbd>filter</kbd> parameter to: “Manufacturer eq ‘Banana Angel inc.’”. The “eq” is Odata code for “equals”. We can also use “neq” for not equals, “lt” for less than, and “gt” for greater than.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="90" id="90" data-hash="c3d2b3fe7909c9c3499b2048dce3635c"> 
    <p>We can also specify which fields to retrieve. For instance, if your user only needs the product’s name, there’s no point in returning a full description, as that might waste tokens. We would set the <kbd>select</kbd> parameter to “ProductName” to only see that field coming back in our search results. If you do need more details and trust the model to handle them, feel free to leave the select parameter blank and you will get all fields back, as long as they are marked “Retrievable” in your index. Here’s how you can apply these ideas in your try_search.py file:</p> 
    </div> 
    <div class="browsable-container listing-container" refid="91" id="91" data-hash="e1d6e92dca44289e4bb028212a143ad2"> 
    <h5>Listing 4.10 Use filters and select fields</h5> 
    <div class="code-area-container"> 
    <pre class="code-area">query = "tennis racket"

    embedding = embed_text(query)
    vector_query = VectorizedQuery(vector=embedding, k_nearest_neighbors=3, fields="Vector")

    results = search_client.search(
    search_text=query,
    vector_queries=[vector_query],
    filter="Manufacturer eq 'Banana Angel inc.'",  #A
    select=["ProductName"],  #B
    top=3
    )
    results_list = list(results)
    for result in results_list:
    print(result)
    </pre> 
    <div class="code-annotations-overlay-container" data-annotations="I0EgVGhpcyBpcyBvdXIgZmlsdGVyLCBpdCBpcyBqdXN0IGEgcGxhaW4gc3RyaW5nLCBpbiBPZGF0YSBmb3JtYXQ6IGZpZWxkIGVxIHZhbHVlLiAgSXQgd2lsbCBvbmx5IHJldHVybiByZWNvcmRzIHdoZXJlIHRoZSBtYW51ZmFjdHVyZXIgaXMg4oCcQmFuYW5hIEFuZ2VsIGluYy7igJ0uCiNCIFdlIGVudGVyIHRoZSBuYW1lcyBvZiB0aGUgZmllbGRzIHdlIHdhbnQgdG8gYmUgcmV0dXJuZWQgaGVyZS4gIFdlIG9ubHkgd2FudCB0byByZXR1cm4gdGhlIFByb2R1Y3ROYW1lLg=="></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="browsable-container listing-container" refid="92" id="92" data-hash="e4acc710251df8564cad598b0d354e7d"> 
    <div class="code-area-container"> 
    <pre class="code-area">Outpu: {'ProductName': 'Breakable Tennis Racket', '@search.score': 0.03279569745063782, '@search.reranker_score': None, '@search.highlights': None, '@search.captions': None}
    {'ProductName': 'Unexpectedly-Decent Tennis Racket', '@search.score': 0.03279569745063782, '@search.reranker_score': None, '@search.highlights': None, '@search.captions': None}      
    {'ProductName': 'Unusually-Unique Tennis Racket', '@search.score': 0.03226646035909653, '@search.reranker_score': None, '@search.highlights': None, '@search.captions': None}   
    </pre> 
    <div class="code-annotations-overlay-container"></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="93" id="93" data-hash="5d102f83b639a5a89181904fb1a11c7a"> 
    <p>Note that each record also has a search score (@search.score), showing how well it matches your query (higher is better). Notice how you’re only seeing ProductName in the returned data because of the select parameter.</p> 
    </div> 
    <div class="readable-text" refid="94" id="94" data-hash="c9f105c3a1e2df79898c595abdd8e400"> 
    <h3>4.2.9 Ordering search results for consistency</h3> 
    </div> 
    <div class="readable-text " refid="95" id="95" data-hash="fe44068c246bc0de3459b6f5d00845c2"> 
    <p>One extra detail to keep in mind is that your stakeholders might want a consistent ordering for your search results. Sometimes, AI Search can return the same three records in a different order, which might confuse or annoy users. For example, if your boss searches for “Show me some games for pets,” they might see the same top three products but in varied sequences. This can lead to slightly different answers in your RAG responses, even though they’re still correct overall. Figure 4.6 illustrates this issue with inconsistent ordering. Having a clear sorting strategy—maybe by relevance or alphabetical order—helps ensure more predictable, reliable search results.</p> 
    </div> 
    <div class="browsable-container figure-container" refid="96" id="96" data-hash="492987da18df61bfd6c7676e5e91eca7"> 
    <h5>Figure 4.6 Illustration of user confusion caused by inconsistent search result ordering. Two identical searches for "pet games" return the same items in a different order, leading to contradictory responses from the writer agent. This highlights the importance of consistently ranked search results to ensure clarity and user trust.</h5> 
    <img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/04__image006.png" data-alt="Title: dimensions:[378x283.5] - Description: 046.png" loading="lazy" width="1200" height="899" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/04__image006.png" class="medium-zoom-image"> 
    </div> 
    <div class="readable-text " refid="97" id="97" data-hash="dc30b3ad1c89e936b6c62fe5ce3a5b97"> 
    <p>If you want to avoid situations where the same query returns results in different orders, the easiest fix is to sort your search results—either during the search or once you receive them. One option is to sort by the relevance score that Azure AI Search provides in each result. Alternatively, you might consult with your stakeholders about more specific criteria: should you show the most popular product first? Would you rather highlight products from a certain brand or emphasize the newest information by sorting by date? Each of these approaches can help ensure consistent, predictable answers in your RAG system.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="98" id="98" data-hash="9abdfdd8ec019ce8ba0ee4508fcb8fc3"> 
    <p>Here’s some sample code that sorts by a chosen field—in this case, alphabetical order by ProductName. Feel free to adapt it if you need to prioritize other fields:</p> 
    </div> 
    <div class="browsable-container listing-container" refid="99" id="99" data-hash="d43c4a78a550c518a83fc2aeca472802"> 
    <h5>Listing 4.11 Sort search results</h5> 
    <div class="code-area-container"> 
    <pre class="code-area">def sort_results(
    results_list, 
    field_name, 
    descending=False):
    sorted_results = sorted(
    results_list, 
    key=lambda x: x[field_name], 
    reverse=descending)  #A
    return sorted_results
    print(sort_results(results_list, "ProductName", descending=False))</pre> 
    <div class="code-annotations-overlay-container" data-annotations="I0EgVGhpcyB3aWxsIHNvcnQgdGhlIHJlc3VsdHMgeW91IHB1dCBpbnRvIGl0IGJ5IHdoYXRldmVyIGZpZWxkIG5hbWUgeW91IGNob29zZS4gSWYgeW91IHdhbnQgdGhlIGxpc3QgdG8gYmUgZGVzY2VuZGluZywgYXMgaW4gdGhlIGhpZ2hlc3QgbnVtYmVycyBzaG91bGQgYmUgYXQgdGhlIHRvcCwgeW91IGNhbiBzZXQgZGVzY2VuZGluZyBlcXVhbCB0byBUcnVlLg=="></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="100" id="100" data-hash="45111013a46a68d585bb8e79b24b36e8"> 
    <p>After running this snippet, your search results should appear in alphabetical order. If you run it again with the same data, the list will come back in the exact same order. Here’s an example of what you might see:</p> 
    </div> 
    <div class="browsable-container listing-container" refid="101" id="101" data-hash="f4ba90ff007552c3c5eb7242a4bfc89c"> 
    <div class="code-area-container"> 
    <pre class="code-area">{'ProductName': 'Breakable Tennis Racket', '@search.score': 0.03279569745063782, '@search.reranker_score': None, '@search.highlights': None, '@search.captions': None}, 
    {'ProductName': 'Unexpectedly-Decent Tennis Racket', '@search.score': 0.03279569745063782, '@search.reranker_score': None, '@search.highlights': None, '@search.captions': None}, 
    {'ProductName': 'Unusually-Unique Tennis Racket', '@search.score': 0.03226646035909653, '@search.reranker_score': None, '@search.highlights': None, '@search.captions': None}
    </pre> 
    <div class="code-annotations-overlay-container"></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="102" id="102" data-hash="3d226efcb30f751a59773f179090e015"> 
    <p>It looks like our AI Search is up and running! We’ve processed and uploaded our data, tested the search, and even sorted the results for consistent answers.</p> 
    </div> 
    <div class="readable-text" refid="103" id="103" data-hash="255c3145fe9f631d1215b2fb767bf7a2"> 
    <h3>4.2.10 Updating AI Search Index: adding new records</h3> 
    </div> 
    <div class="readable-text " refid="104" id="104" data-hash="856007595c238f6f859fc2b9b64fdb7a"> 
    <p>Of course, your database won’t always stay the same. Maybe your company starts selling a brand-new product, or a certain product line is removed from the catalog. You don’t want your chatbot to give outdated info, so you’ll need a script that periodically checks for new or updated records and uploads them to your AI Search index. Here is an overview of the process before we look at the code:</p> 
    </div> 
    <div class="browsable-container figure-container" refid="105" id="105" data-hash="bcd52dc9118c04cb5b9fa71d4636bf55"> 
    <h5>Figure 4.7 Workflow for updating records in AI Search. A weekly timer trigger initiates the process, selecting only the records that have been updated in the past week. These records are processed and then sent to AI Search, ensuring the system remains up-to-date with the latest data.</h5> 
    <img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/04__image007.png" data-alt="Title: dimensions:[252.95x350.6] - Description: 047.png" loading="lazy" width="1200" height="1663" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/04__image007.png" class="medium-zoom-image"> 
    </div> 
    <div class="readable-text " refid="106" id="106" data-hash="d7f5766d994f8c5d87b34d6224b169bd"> 
    <p>Create a new file called update_ai_search.py to handle this task. We will add to it code that will check for new records created in the last week, and upload them all to our AI Search Index using our ingest_all_records() function:</p> 
    </div> 
    <div class="browsable-container listing-container" refid="107" id="107" data-hash="3df5b791bda96ba14e370d58403233e3"> 
    <h5>Listing 4.12 Update your AI Search</h5> 
    <div class="code-area-container"> 
    <pre class="code-area">from upload_sql_records_to_ai_search import ingest_all_records
    def update_all_records_created_in_last_week():    
    sql_query = (
    "SELECT * FROM Products WHERE ‘Date Modified’ &gt;= 
    ➥DATEADD(day, -7, GETDATE())"  #A
    )
    ingest_all_records(sql_query)  #B
    </pre> 
    <div class="code-annotations-overlay-container" data-annotations="I0EgVGhpcyBzZWxlY3RzIE9OTFkgdGhlIHJlY29yZHMgaW4gb3VyIFNRTCBkYXRhYmFzZSB0aGF0IGhhdmUgYmVlbiB1cGRhdGVkIGluIHRoZSBsYXN0IHdlZWsuCiNCIFRoaXMgcnVucyB0aGUgZnVuY3Rpb24gd2UgZGVmaW5lZCBlYXJsaWVyIGZvciB1cGxvYWRpbmcgcmVjb3JkcyB0byBvdXIgQUkgU2VhcmNoIEluZGV4Lg=="></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="callout-container admonition-block"> 
    <div class="readable-text" refid="108" id="108" data-hash="260cc6dcef2c22785feb4596e3fe5a61"> 
    <h5>NOTE</h5> 
    </div> 
    <div class="readable-text" refid="109" id="109" data-hash="4c63f0eebc00428037482274d1b98063"> 
    <p>Azure does offer its own “Indexer” service that automatically syncs source data with your AI Search index, but we’ve found it simpler and more flexible to manage updates ourselves.</p> 
    </div> 
    </div> 
    <div class="readable-text " refid="110" id="110" data-hash="8ece30df89c88825dec40004a87193e1"> 
    <p>The code you see here not only adds new records but also overwrites existing ones if they share the same ID. That way, whenever a record changes in your SQL database, your search index reflects those updates. You can set a cron job or timer to run this script once a day or once a week, depending on how frequently your data changes. I recommend you only run it at night when the burdens on your search service are minimal. With that in place, your system remains accurate and ready to respond to new or updated information—precisely what a well-rounded RAG solution needs.</p> 
    </div> 
    <div class="readable-text" refid="111" id="111" data-hash="6ca9c07ed4a68be50ace19f88c0ffde5"> 
    <h3>4.2.11 Updating AI Search Index: deleting records</h3> 
    </div> 
    <div class="readable-text " refid="112" id="112" data-hash="4fc67d24e1306d0d00cbdff095d4481a"> 
    <p>If you want to remove records from your AI Search index, for instance, if your company no longer sells a particular product, you’ll need to handle deletions in a special way. Instead of actually erasing the record from your SQL database, you can add a Deleted column and set it to 0 by default. Whenever a record is no longer valid, flip that column to 1 and update the DateModified field. Your update script will see that this record is marked as deleted, and you can use its id to remove it from AI Search, skipping all the usual steps for summarizing, embedding, and uploading.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="113" id="113" data-hash="d5a05e869a565421e8315cfe51913dc5"> 
    <p>Let’s start by checking for deleted records in our SQL database. Create a new script called check_for_deleted_records.py and enter the following:</p> 
    </div> 
    <div class="browsable-container listing-container" refid="114" id="114" data-hash="3e933167dca487159a9134310767f8ba"> 
    <h5>Listing 4.13 Check for deleted records in SQL database</h5> 
    <div class="code-area-container"> 
    <pre class="code-area">import sqlite3  #A
    conn = sqlite3.connect("products.db")  #A
    cur = conn.cursor()  #A
    cur.execute("SELECT * FROM products WHERE Deleted = '1'")  #B
    records = cur.fetchmany(size=100)  #C
    for record in records:
    print(record)

    cur.close()
    conn.close()  #D
    </pre> 
    <div class="code-annotations-overlay-container" data-annotations="I0EgSGVyZSB3ZSBhcmUganVzdCBzZXR0aW5nIHVwIHRoZSBTUUwgZGF0YWJhc2UgY29ubmVjdGlvbi4KI0IgV2UgYXJlIG9ubHkgc2VsZWN0aW5nIHRoZSByZWNvcmRzIHRoYXQgc2hvdWxkIGJlIGRlbGV0ZWQgZnJvbSBvdXIgQUkgU2VhcmNoIEluZGV4LgojQyBXZSBzZXQgb3VyIGJhdGNoIHNpemUgdG8gMTAwIGFnYWluIHRvIGtlZXAgdGhlIHF1ZXJ5IGZhc3QuCiNEIFdlIGNsb3NlIG91ciBjb25uZWN0aW9uIHRvIGJlIHBvbGl0ZS4="></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="115" id="115" data-hash="83553528a0b0c775a8270754c3c3411b"> 
    <p>This query fetches records where Deleted is set to 1, meaning they should be removed from AI Search. For example, suppose you get the following:</p> 
    </div> 
    <div class="browsable-container listing-container" refid="116" id="116" data-hash="71e4e9b43dc47eeef6db261a0816b9fb"> 
    <div class="code-area-container"> 
    <pre class="code-area">(500, 'Tastefully-Average Pants', "Introducing the Tastefully-Average Pants by Banana Angel Inc. — where innovative fashion meets extraordinary design. Perfect for those who dare to embrace a new level of boldness, these pants transcend traditional style norms with their futuristic flair.\n\nCrafted from high-quality metal, the Tastefully-Average Pants offer a unique visual appeal and an unexpected tactile experience. The sleek, metallic sheen effortlessly captures attention and reflects the brand’s commitment to avant-garde fashion.\n\nThe vibrant blue color adds a splash of personality, making these pants not only a statement piece but also a versatile addition to your wardrobe. Whether you're looking to stand out at a gala or add some edge to your everyday look, the refined hue of blue provides just the right balance of audacity and sophistication.\n\nDesigned for a size small, the Tastefully-Average Pants cater to those with a penchant for exclusive, form-fitting styles. The meticulously engineered structure promises a snug yet comfortable fit, allowing you to showcase your silhouette with confidence and ease.\n\nDare to redefine simplicity with Banana Angel Inc.'s Tastefully-Average Pants — where innovation collides with style, and average becomes exceptional. Whether you're a trendsetter or simply someone with an eye for the unusual, these pants are sure to elevate your fashion game to new heights.", '{"Material": "Metal", "Color": "Blue", "Size": "Small"}', 'Banana Angel inc.', '2024-11-08 19:14:26', 1)
    </pre> 
    <div class="code-annotations-overlay-container"></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="117" id="117" data-hash="0854734c62210ebc6f75ed0e00973bdb"> 
    <p>Notice that the “1” at the end indicates the item is marked as deleted. That means “Tastefully-Average Pants” from Banana Angel inc. has to go, even though it may still appear if you check your AI Search index manually in the Azure portal. You might see something like this in your Search Explorer output:</p> 
    </div> 
    <div class="browsable-container listing-container" refid="118" id="118" data-hash="fe289e9228c7e8bcea43960f1a27e401"> 
    <div class="code-area-container"> 
    <pre class="code-area">{
    "@odata.context": "https://products-ai-search.search.windows.net/indexes('product-search-index')/$metadata#docs(*)",
    "@odata.count": 123,
    "@search.nextPageParameters": {
    "search": "Tastefully Average Pants",
    "count": true,
    "skip": 50
    },
    "value": [
    {
    "@search.score": 36.81215,
    "id": "500",
    "ProductName": "Tastefully-Average Pants",
    "ProductDescription": "Introducing the Tastefully-Average Pants by Banana Angel Inc. — where innovative fashion meets extraordinary design. Perfect for those who dare to embrace a new level of boldness, these pants transcend traditional style norms with their futuristic flair.\n\nCrafted from high-quality metal, the Tastefully-Average Pants offer a unique visual appeal and an unexpected tactile experience. The sleek, metallic sheen effortlessly captures attention and reflects the brand’s commitment to avant-garde fashion.\n\nThe vibrant blue color adds a splash of personality, making these pants not only a statement piece but also a versatile addition to your wardrobe. Whether you're looking to stand out at a gala or add some edge to your everyday look, the refined hue of blue provides just the right balance of audacity and sophistication.\n\nDesigned for a size small, the Tastefully-Average Pants cater to those with a penchant for exclusive, form-fitting styles. The meticulously engineered structure promises a snug yet comfortable fit, allowing you to showcase your silhouette with confidence and ease.\n\nDare to redefine simplicity with Banana Angel Inc.'s Tastefully-Average Pants — where innovation collides with style, and average becomes exceptional. Whether you're a trendsetter or simply someone with an eye for the unusual, these pants are sure to elevate your fashion game to new heights.",
    "TechnicalSpecifications": "{\"Material\": \"Metal\", \"Color\": \"Blue\", \"Size\": \"Small\"}",
    "Manufacturer": "Banana Angel inc.",
    "DateModified": "2024-12-24"
    },
    </pre> 
    <div class="code-annotations-overlay-container"></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="119" id="119" data-hash="bce81900d7313f4f70b9194c855dd5b3"> 
    <p>This output confirms that “Tastefully-Average Pants” from Banana Angel inc. is still in our search index. You might also notice another product with the same name, but by CorBran Corp—it’s a completely different entry.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="120" id="120" data-hash="ddafd4c4bfcdc9e07e66ee0b0b292857"> 
    <p>Next, we’ll open upload_sql_records_to_ai_search.py and adjust the ingest_all_records function to handle deletions. Let’s say that our company at long last decides not to sell Product XYZ anymore, due to complaints from customers about burned hair. We would need to remove that item from our AI Search, and thereby remove it from our RAG system. Our updated code will only summarize and embed a record if its Deleted column is 0. If the column is 1, we’ll remove that record from our AI Search Index and move on. This works well with the timer-based script in update_ai_search.py, which queries any records modified in the last week. As soon as we see that “Tastefully-Average Pants” by Banana Angel inc. has a Deleted field set to 1, we’ll know to take it out of our AI Search index.</p> 
    </div> 
    <div class="browsable-container figure-container" refid="121" id="121" data-hash="51b41f23c71cd429385bfaf73838a042"> 
    <h5>Figure 4.8 Process for handling "soft delete" records in AI Search. The workflow begins by checking the database for records marked as "Deleted." For each deleted record, its ID is retrieved and used to instruct AI Search to remove that entry from the index, ensuring the search index matches the source database.</h5> 
    <img src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/04__image008.png" data-alt="Title: dimensions:[254.7x298.95] - Description: 048.png" loading="lazy" width="1200" height="1408" data-action="zoom" data-zoom-src="https://drek4537l1klr.cloudfront.net/suard/v-1/Figures/04__image008.png" class="medium-zoom-image"> 
    </div> 
    <div class="browsable-container listing-container" refid="122" id="122" data-hash="b16a30c9482d9d8ca08d2235814279d3"> 
    <h5>Listing 4.14 Delete records from your AI Search</h5> 
    <div class="code-area-container"> 
    <pre class="code-area">#... existing code for ingest_all_records function ...
    for record in records:  #A
    if record[-1] &gt; 0:  #B
    try:
    search_client.delete_documents(
    documents=[{"id": str(record[0])}])  #C
    continue  #D
    except:
    continue
    summarize_embed_upload(record)  #E
    #... the rest of the code stays the same ...
    </pre> 
    <div class="code-annotations-overlay-container" data-annotations="I0EgVGhpcyBsaW5lIGFscmVhZHkgZXhpc3RzIGluIGluZ2VzdF9hbGxfcmVjb3JkcygpLCB3cml0ZSB5b3VyIG5ldyBjb2RlIGltbWVkaWF0ZWx5IGJlbG93IHRoaXMgbGluZS4KI0IgSW4gb3VyIGRhdGEsIHRoZSBsYXN0IGNvbHVtbiBpcyB0aGUg4oCcRGVsZXRlZOKAnSBjb2x1bW4uCiNDIFdlIHVzZSB0aGUgSUQgb2YgdGhlIHJlY29yZCAoZmlyc3QgY29sdW1uKSB0byBkZWxldGUgdGhhdCBzYW1lIHJlY29yZCBmcm9tIHRoZSBBSSBTZWFyY2ggSW5kZXguCiNEIFdlIGNvbnRpbnVlIG9uIHRvIHRoZSBuZXh0IHJlY29yZCBpbiB0aGUgbG9vcCwgYXZvaWRpbmcgZnVydGhlciBwcm9jZXNzaW5nLgojRSBUaGlzIGxpbmUgYWxzbyBpcyBpbiB0aGUgb3JpZ2luYWwgc2NyaXB0LiA="></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="123" id="123" data-hash="2cabb3dba2299d84a79ef778b60ed6ea"> 
    <p>Here’s a quick breakdown of what’s happening:</p> 
    </div> 
    <div class="readable-text  intended-text" refid="124" id="124" data-hash="c6847a37c2e29b39761404a6364a609f"> 
    <p>Line #A already exists in ingest_all_records(). You’ll add this new code right below it. In #B, we check if the last column (Deleted) is set to 1. If it is, we use #C to delete that record from AI Search using its ID (the first column). Then we skip any further processing and move on to the next record in line #D. Finally, if the record isn’t marked as deleted, we run summarize_embed_upload(record) in #E, which uploads the record as usual.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="125" id="125" data-hash="10973d7f76a174f37ef98684ec5fe396"> 
    <p>Now run upload_sql_records_to_ai_search.py. Don’t worry about duplicates—any record with the same ID simply gets updated rather than duplicated. With that, “Tastefully-Average Pants” from Banana Angel inc. should vanish from the AI Search index. To confirm, go back to the portal and search for those pants again. You might see something like this:</p> 
    </div> 
    <div class="browsable-container listing-container" refid="126" id="126" data-hash="0a45b4b9ebfdbb7cd84be1ffe3c111d7"> 
    <div class="code-area-container"> 
    <pre class="code-area">{"@odata.context":"https://products-ai-search.search.windows.net/indexes('product-search-index')/$metadata#docs(*)",
    "@odata.count": 122,
    "@search.nextPageParameters": {
    "search": "Tastefully Average Pants",
    "count": true,
    "skip": 50
    },
    "value": [
    {
    "@search.score": 36.400574,
    "id": "409",
    "ProductName": "Tastefully-Average Pants",
    "ProductDescription": "Introducing the latest in unconventional fashion from CorBran Corp: Tastefully-Average Pants. Crafted with an avant-garde twist for those who dare to step outside the ordinary, these pants are for anyone looking to make a statement – and maybe a few double takes.\n\n**Features:**\n\n- **Material**: Experience a bold departure from the norm with our innovative wood design. These pants are an embodiment of nature meeting fashion, crafted from sustainable wood materials to give you a look that's not just stunningly unique, but also environmentally conscious.\n\n- **Color**: Stand out with confidence in a radiant yellow hue that's sure to catch everyone's eye. This vibrant color combines seamlessly with the natural texture of wood to create an ensemble that is both striking and sophisticated.\n\n- **Size**: Available in Medium, the Tastefully-Average Pants are designed for a comfortable fit that balances style and function. Perfectly tailored to ensure you can move with grace and poise, this size is ideal for those seeking a savvy blend of comfort and chic.\n\nThese Tastefully-Average Pants are more than just a garment; they're a conversation starter, an opportunity to wear art, and a chance to embrace an extraordinary flair. Whether you're attending an art exhibit, making an entrance at an exclusive soiree, or simply expressing your creative spirit, these pants provide the perfect canvas. Celebrate your adventurous spirit with CorBran Corp's Tastefully-Average Pants and redefine the concept of everyday wear.",
    "TechnicalSpecifications": "{\"Material\": \"Wood\", \"Color\": \"Yellow\", \"Size\": \"Medium\"}",
    "Manufacturer": "CorBran Corp",
    "DateModified": "2024-12-24"
    },
    </pre> 
    <div class="code-annotations-overlay-container"></div> 
    </div> 
    <div class="listing-environment-container">
    <div class="listing-environment-toolbar">
    <span class="listing-environment-runnable-script-container">

    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="button-copy button radius"><span class="show-medium-up">copy</span> <i class="fal fa-clipboard show-small" aria-hidden="true"></i></a>
    </span>
    <span class="listing-environment-standard-mode-container">
      <a href="javascript:void(0)" class="manny-button button radius listing-manny-button">
        <svg width="16" height="16" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M0 3.16667C0 1.41777 1.41777 0 3.16667 0H15.8333C17.5822 0 19 1.41777 19 3.16667V15.8333C19 17.5822 17.5822 19 15.8333 19H3.16667C1.41777 19 0 17.5822 0 15.8333V3.16667ZM3.16667 1.26667C2.11732 1.26667 1.26667 2.11732 1.26667 3.16667V15.8333C1.26667 16.8826 2.11732 17.7333 3.16667 17.7333H15.8333C16.8826 17.7333 17.7333 16.8826 17.7333 15.8333V3.16667C17.7333 2.11732 16.8826 1.26667 15.8333 1.26667H3.16667Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M7.53403 6.68347C7.42674 6.46891 7.20748 6.33337 6.96758 6.33337C6.72769 6.33337 6.5084 6.46891 6.40112 6.68347L3.86779 11.7501C3.71135 12.063 3.83816 12.4434 4.15101 12.5998C4.46387 12.7563 4.8443 12.6295 5.00072 12.3166L5.45901 11.4H8.47618L8.93446 12.3166C9.09089 12.6295 9.47127 12.7563 9.78413 12.5998C10.097 12.4434 10.2238 12.063 10.0674 11.7501L7.53403 6.68347ZM7.84284 10.1334L6.96758 8.38284L6.09235 10.1334H7.84284Z" fill="currentColor"></path>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M13.2974 6.33337C13.6471 6.33337 13.9307 6.61693 13.9307 6.96671V12.0334C13.9307 12.3831 13.6471 12.6667 13.2974 12.6667C12.9477 12.6667 12.6641 12.3831 12.6641 12.0334V6.96671C12.6641 6.61693 12.9477 6.33337 13.2974 6.33337Z" fill="currentColor"></path>
        </svg>
      </a>
    </span>
    </span></div>
    </div></div> 
    <div class="readable-text " refid="127" id="127" data-hash="985f0049cf495920e2e723c2f4240e40"> 
    <p>Perfect! “Tastefully-Average Pants” by Banana Angel inc. is no longer listed, and only CorBran Corp’s product remains.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="128" id="128" data-hash="311e7653ff8d0d036cbe1b4c39e19f2c"> 
    <p>With this final step, you’ve created a system that can query, transform, and upload your SQL data to Azure AI Search, and also remove any records flagged for deletion. Better yet, you now have a script that checks for updates or additions in the last week, ensuring your AI Search index always stays current. If a record in your SQL database is marked as deleted, that same record disappears from the index. Your RAG application is ready to handle not just the structured data you have now, but all the new data (and deletions) your organization might introduce in the future.</p> 
    </div> 
    <div class="readable-text" refid="129" id="129" data-hash="795d1fcea0e885b3045f7d30c054c931"> 
    <h2>4.3 Preparing and uploading unstructured data to AI Search</h2> 
    </div> 
    <div class="readable-text " refid="130" id="130" data-hash="3d1f8c2b9f0d9ff9a113901d2e1232c5"> 
    <p>The ingestion process we’ve discussed in this chapter is great for structured data, but you might be wondering how to handle unstructured sources, such as sales catalogs or user manuals. The same techniques you learned in Chapter 3—parsing, chunking, and embedding—can be applied here, but instead of storing those embeddings in a vector database, you can upload them to Azure AI Search. One big difference is that chunk size matters less with AI Search than it does with a traditional vector database, because AI Search lets you rely on keyword-based queries while only using vectors as an extra boost. In our experience, taking an entire PDF page and embedding it works just fine for documents in AI Search.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="131" id="131" data-hash="bbf970a08c19fbeeb8a996b332ee867b"> 
    <p>If you want to include images, you can convert them to text by using a multi-modal language model to generate descriptions for each image, then store both the text and its embedding in your index, along with a link to the original file. For example, if you want to create a RAG chatbot for retrieving photos of cats, you may send each photo through a multimodal LLM, and ask the LLM to describe the cat picture in great detail. You would then embed the text of that description, and upload the description, embedding, and a link to the photo to your AI Search index. The same concept applies to videos. An LLM can create frame-by-frame descriptions or transcribe the audio, and you can add those transcripts and embeddings to AI Search.</p> 
    </div> 
    <div class="readable-text  intended-text" refid="132" id="132" data-hash="5f4f1277a02429ee93a470908a23b08c"> 
    <p>Now that you’ve built out your AI Search capabilities, the next step is to hand them off to some AI agents who can harness these search features to find records quickly and flexibly—exactly what we’ll explore in the next chapter.</p> 
    </div> 
    <div class="readable-text" refid="133" id="133" data-hash="1473f86fae2b690742a2716ef4ba4262"> 
    <h2>4.4 Summary</h2> 
    </div> 
    <ul> 
    <li class="readable-text" refid="134" id="134" data-hash="356304824f5c37d0bf82a26eee7e1417">Azure AI Search may be more effective than many traditional vector databases. By combining text search, vector search, and natural language processing, Azure AI Search delivers results that are typically more relevant and precise.</li> 
    <li class="readable-text" refid="135" id="135" data-hash="031747616c0b6f2b3789ba403a8e9dc7">Setting up an Azure AI Search service and creating an appropriate search index requires defining the right fields for the data. This setup includes adding a vector field of the correct dimensionality and configuring vector search profiles to leverage both text and vector searches.</li> 
    <li class="readable-text" refid="136" id="136" data-hash="a42c9fd437990d15409723d3789700a4">Structured data like SQL records must first be transformed into text that is optimized for retrieval. This transformation involves summarizing the records, removing any unnecessary characters, and generating embeddings that capture the semantic meaning of the data.</li> 
    <li class="readable-text" refid="137" id="137" data-hash="0aec7f0ad2e610225b30c5f86e684a4d">Uploading processed and embedded SQL records into Azure AI Search enables a hybrid search function that combines vector similarity with semantic understanding. This approach allows more efficient and accurate retrieval than relying on keyword matching or vector matching alone.</li> 
    <li class="readable-text" refid="138" id="138" data-hash="09e9fc9697eab84858f479da3abc13b6">Maintaining a synchronized search index is crucial when handling frequent data changes. Implementing code to update modified records and remove deleted ones in Azure AI Search ensures that the index remains current.</li> 
    </ul></div>
            <div id="right-margin-column"></div>
            <div id="right-margin-menu-column"></div>
        </div>
    </div>

   </body>
   </html>